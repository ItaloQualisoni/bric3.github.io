<!doctype html><html lang=en><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta http-equiv=cache-control content="public"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=generator content="Hugo 0.69.0"><title>Une fuite mémoire, beaucoup de reflection et pas de OutOfMemoryError • The Coffee Workshop</title><meta name=twitter:card content="summary"><meta name=twitter:title content="Une fuite mémoire, beaucoup de reflection et pas de OutOfMemoryError"><meta name=twitter:description content="Le contexte L&rsquo;histoire commence par un problème en production sur une version à priori stable et sans anomalie connue. Seulement voilà une fois en prod l&rsquo;application devient de plus en plus lente."><meta property="og:title" content="Une fuite mémoire, beaucoup de reflection et pas de OutOfMemoryError"><meta property="og:description" content="Le contexte L&rsquo;histoire commence par un problème en production sur une version à priori stable et sans anomalie connue. Seulement voilà une fois en prod l&rsquo;application devient de plus en plus lente."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.arkey.fr/2010/02/12/une-fuite-memoire-beaucoup-de-reflection-et-pas-de-outofmemoryerror/"><meta property="article:published_time" content="2010-02-12T21:12:39+00:00"><meta property="article:modified_time" content="2010-02-12T21:12:39+00:00"><meta property="og:site_name" content="Arkey"><link rel=stylesheet href=/scss/hyde-hyde.9181f25ed2263aeb878ec6f8a84f10c4ebb16150000fca8767308880bdde5ca0.css integrity="sha256-kYHyXtImOuuHjsb4qE8QxOuxYVAAD8qHZzCIgL3eXKA="><link rel=stylesheet href=/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58+TzH3icCkSHGoJ+ed7w=" media=print><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=apple-touch-icon-precomposed sizes=72x72 href=/apple-touch-icon-72-precomposed.png><link rel=apple-touch-icon-precomposed sizes=114x114 href=/apple-touch-icon-114-precomposed.png><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" sizes=192x192 href=/android-192-favicon.png><link rel="shortcut icon" href=/android-192-favicon.png></head><body><div class=sidebar><div class=container><div class=sidebar-about><span class=site__title><a href=https://blog.arkey.fr>The Coffee Workshop</a></span><div class=author-image><img src="https://www.gravatar.com/avatar/f31c7fbcbb0766d0632d96fd7e74b649?s=240&d=mp" class="img--circle img--headshot element--center" alt=gravatar></div><p class=site__description>Java mostly, and general tech</p></div><div class=collapsible-menu><input type=checkbox id=menuToggle>
<label for=menuToggle>The Coffee Workshop</label><div class=menu-content><div><ul class=sidebar-nav><li><a href=/><span class=fa-icon><i class="fas fa-home"></i></span><code>cd <em>~</em></code>
<span></span></a></li><li><a href=/posts/><span class=fa-icon><i class="fas fa-stream"></i></span><code>ls <em>posts/*</em></code>
<span></span></a></li><li><a href=/series/><span class=fa-icon><i class="fas fa-list-alt"></i></span><code>grep -o <em>series</em> posts/* | sort -u</code>
<span></span></a></li><li><a href=/tags/><span class=fa-icon><i class="fas fa-tags"></i></span><code>grep -o <em>tags</em> posts/* | sort -u</code>
<span></span></a></li><li><a href=/cool-stuff/><span class=fa-icon><i class="fas fa-thumbtack"></i></span><code>cd <em>cool-stuff</em></code>
<span></span></a></li><li><a href=/whoami/><span class=fa-icon><i class="fas fa-id-card"></i></span><code>whoami</code>
<span></span></a></li></ul></div><section class=social><a href=https://twitter.com/@BriceDutheil rel=me><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="bird" class="svg-inline--fa fa-bird fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645.0 138.72-105.583 298.558-298.558 298.558-59.452.0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055.0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421.0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391.0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04.0-57.828 46.782-104.934 104.934-104.934 30.213.0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></a><a href=https://github.com/bric3 rel=me><i class="fab fa-github fa-lg" aria-hidden=true></i></a><a href=https://speakerdeck.com/bric3 rel=me><i class="fab fa-speaker-deck" aria-hidden=true></i></i></a><a href=https://linkedin.com/in/dutheilbrice rel=me><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="pro-network" class="svg-inline--fa fa-pro-network fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg></a><a href=https://stackoverflow.com/users/48136/brice rel=me><i class="fab fa-stack-overflow fa-lg" aria-hidden=true></i></a></section></div></div><div class=copyright>&copy; 2010 - 2020 Brice Dutheil
<a href=https://creativecommons.org/licenses/by-sa/4.0>CC BY-SA 4.0</a></div></div></div><div class="content container"><article><header><h1>Une fuite mémoire, beaucoup de reflection et pas de OutOfMemoryError</h1><div class=post__meta><i class="fas fa-calendar-alt"></i>2010-02-12<br><i class="fas fa-tags"></i><a class="badge badge-tag" href=/tags/code>code</a>
<a class="badge badge-tag" href=/tags/memoryleak>memoryleak</a>
<a class="badge badge-tag" href=/tags/outofmemoryerror>outofmemoryerror</a>
<a class="badge badge-tag" href=/tags/performance>performance</a>
<a class="badge badge-tag" href=/tags/reflection>reflection</a><br><i class="fas fa-clock"></i>10 min read</div></header><div class=post><h1 id=le-contexte>Le contexte</h1><p>L&rsquo;histoire commence par un problème en production sur une version à priori stable et sans anomalie connue. Seulement voilà une fois en prod l&rsquo;application devient de plus en plus lente. Pourquoi? Que se passe-t-il?</p><p>Avec l&rsquo;activation des logs du GC dans les options de la JVM, l'équipe s&rsquo;aperçoit donc très vite que l&rsquo;application arrive à bout de la mémoire disponible, mais pas de <code>OutOfMemoryError</code> (pourtant classique lors d&rsquo;une fuite mémoire).</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>-Xloggc:-XX:+PrintGCDetails
</code></pre></div><p> </p><p>Lors de l&rsquo;analyse des GC on remarque immédiatement une famine de mémoire, la JVM est obligée de faire des Full GC très souvent, et un Full GC c&rsquo;est lent!</p><p>Pour avoir une représentation un peu compréhensible, on analyse ces logs avec <a href=http://www.tagtraum.com/gcviewer.html>GCViewer</a>. On a alors un graphe qui ressemble à ça :</p><p><img src=/assets/application-gc.png alt=application-gc></p><p>On voit comment se passe le consommation de la mémoire dans l&rsquo;application, on sait que l&rsquo;application est lente, maintenant pourquoi la consommation mémoire monte autant sans être libéré. Effectivement les raisons peuvent varier <strong>surtout qu&rsquo;il n&rsquo;y avait pas de OutOfMemoryError</strong>!</p><ul><li>Possibilité 1 : Un problème de concurrence (deadlock, point de contention sur une ressource, &mldr;); c&rsquo;est cette possibilité qui a été retenue pour l&rsquo;investigation du problème. Les thread dump nous confortaient dans cette optique étant donné qu&rsquo;on voyait régulièrement le même code revenir. Et les indicateurs sur le CPU montrait qu&rsquo;il n'était pas énormément utilisé.</li><li>Possibilité 2 : Une fuite mémoire, choix écarté parce qu&rsquo;on ne voyait de OOME.</li></ul><p>Et bien on avait tort, il s&rsquo;agissait d&rsquo;une fuite mémoire. Avec un collègue plus expérimenté nous avons fait du profiling, très vite il a mis le doigt sur le code en tort. <strong>Mais quelque chose me choquait, pourquoi pas d&rsquo;erreur OOME</strong> alors qu&rsquo;il s&rsquo;agissait manifestement d&rsquo;une fuite mémoire.</p><h1 id=la-bonne-rencontre>La bonne rencontre</h1><p>J&rsquo;ai eu la chance de pouvoir rencontré <a href=http://www.zenika.com/>Zenika</a>, en discutant avec lui j&rsquo;ai eu l&rsquo;occasion d&rsquo;aborder ce sujet. Il m&rsquo;a immédiatement demandé si notre application utilisait beaucoup d&rsquo;introspection. Il m&rsquo;a dit qu&rsquo;il soupçonnait que ce genre de cas pouvait se produire, et il m&rsquo;a ensuite aiguillé sur la manière dont le JDK de Sun utilise des SoftReference pour stocker les éléments issus de la reflection.</p><p>Et là, les cases manquantes n'étaient plus, en effet les objets <a href=http://java.sun.com/j2se/1.5.0/docs/api/java/lang/ref/SoftReference.html>SoftReference</a> sont des références qui sont réclamées par le GC lorsque la JVM a vraiment vraiment besoin de mémoire, juste avant de lever une OutOfMemoryError. En gros, ça se passe typiquement lors des Full GC.</p><p>Et donc comme l&rsquo;application est toujours en état de marche, le code qui a besoin de reflection va recréer ces objets. Cette combinaison de Full GC et la recréation constante des références des éléments issus de l&rsquo;introspection, va très fortement ralentir l&rsquo;application sans lever cette fameuse OOME. Ou en tout cas en repoussant dans le temps cette OOME.</p><h1 id=la-preuve>La preuve</h1><p>Fort de cette nouvelle connaissance, j&rsquo;ai été jeter un coup d'œil dans l&rsquo;objet <code>java.lang.Class</code> pour effectivement y découvrir la mise en cache des éléments comme les méthodes et les champs dans une <code>SoftReference</code>. Ainsi en regardant le code source de OpenJDK:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#998;font-style:italic>/*
</span><span style=color:#998;font-style:italic> * Copyright 1994-2006 Sun Microsystems, Inc.  All Rights Reserved.
</span><span style=color:#998;font-style:italic> * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
</span><span style=color:#998;font-style:italic> *
</span><span style=color:#998;font-style:italic> * This code is free software; you can redistribute it and/or modify it
</span><span style=color:#998;font-style:italic> * under the terms of the GNU General Public License version 2 only, as
</span><span style=color:#998;font-style:italic> * published by the Free Software Foundation.  Sun designates this
</span><span style=color:#998;font-style:italic> * particular file as subject to the &#34;Classpath&#34; exception as provided
</span><span style=color:#998;font-style:italic> * by Sun in the LICENSE file that accompanied this code.
</span><span style=color:#998;font-style:italic> *
</span><span style=color:#998;font-style:italic> * This code is distributed in the hope that it will be useful, but WITHOUT
</span><span style=color:#998;font-style:italic> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
</span><span style=color:#998;font-style:italic> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
</span><span style=color:#998;font-style:italic> * version 2 for more details (a copy is included in the LICENSE file that
</span><span style=color:#998;font-style:italic> * accompanied this code).
</span><span style=color:#998;font-style:italic> *
</span><span style=color:#998;font-style:italic> * You should have received a copy of the GNU General Public License version
</span><span style=color:#998;font-style:italic> * 2 along with this work; if not, write to the Free Software Foundation,
</span><span style=color:#998;font-style:italic> * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
</span><span style=color:#998;font-style:italic> *
</span><span style=color:#998;font-style:italic> * Please contact Sun Microsystems, Inc., 4150 Network Circle, Santa Clara,
</span><span style=color:#998;font-style:italic> * CA 95054 USA or visit www.sun.com if you need additional information or
</span><span style=color:#998;font-style:italic> * have any questions.
</span><span style=color:#998;font-style:italic>*/</span>

<span style=color:#000;font-weight:700>...</span>

<span style=color:#998;font-style:italic>// Returns an array of &#34;root&#34; methods. These Method objects must NOT
</span><span style=color:#998;font-style:italic>// be propagated to the outside world, but must instead be copied
</span><span style=color:#998;font-style:italic>// via ReflectionFactory.copyMethod.
</span><span style=color:#998;font-style:italic></span><span style=color:#000;font-weight:700>private</span> Method<span style=color:#000;font-weight:700>[]</span> <span style=color:#900;font-weight:700>privateGetDeclaredMethods</span><span style=color:#000;font-weight:700>(</span><span style=color:#458;font-weight:700>boolean</span> publicOnly<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
  checkInitted<span style=color:#000;font-weight:700>();</span>
  Method<span style=color:#000;font-weight:700>[]</span> res <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>null</span><span style=color:#000;font-weight:700>;</span>
  <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span>useCaches<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
    clearCachesOnClassRedefinition<span style=color:#000;font-weight:700>();</span>
    <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span>publicOnly<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
      <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span>declaredPublicMethods <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>null</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
        res <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>(</span>Method<span style=color:#000;font-weight:700>[])</span> declaredPublicMethods<span style=color:#000;font-weight:700>.</span><span style=color:teal>get</span><span style=color:#000;font-weight:700>();</span>
      <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>else</span> <span style=color:#000;font-weight:700>{</span>
      <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span>declaredMethods <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>null</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
        res <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>(</span>Method<span style=color:#000;font-weight:700>[])</span> declaredMethods<span style=color:#000;font-weight:700>.</span><span style=color:teal>get</span><span style=color:#000;font-weight:700>();</span>
      <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span>res <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>null</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>return</span> res<span style=color:#000;font-weight:700>;</span>
  <span style=color:#000;font-weight:700>}</span>
  <span style=color:#998;font-style:italic>// No cached value available; request value from VM
</span><span style=color:#998;font-style:italic></span>  res <span style=color:#000;font-weight:700>=</span> Reflection<span style=color:#000;font-weight:700>.</span><span style=color:teal>filterMethods</span><span style=color:#000;font-weight:700>(</span><span style=color:#000;font-weight:700>this</span><span style=color:#000;font-weight:700>,</span> getDeclaredMethods0<span style=color:#000;font-weight:700>(</span>publicOnly<span style=color:#000;font-weight:700>));</span>
  <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span>useCaches<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span>publicOnly<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
      declaredPublicMethods <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>new</span> SoftReference<span style=color:#000;font-weight:700>(</span>res<span style=color:#000;font-weight:700>);</span>
    <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>else</span> <span style=color:#000;font-weight:700>{</span>
      declaredMethods <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>new</span> SoftReference<span style=color:#000;font-weight:700>(</span>res<span style=color:#000;font-weight:700>);</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>return</span> res<span style=color:#000;font-weight:700>;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>Bon voilà pour la preuve de ce qui était avancé, mais pour aller plus loin je vais reproduire le scénario.</p><h1 id=la-preuve-par-lexemple>La preuve par l&rsquo;exemple</h1><p>L&rsquo;idée de l&rsquo;exemple est d&rsquo;avoir du code qui va simuler une fuite mémoire et un autre code qui va utiliser plus ou moins intensément l&rsquo;introspection. On le verra plus tard mais le débit d&rsquo;allocation d&rsquo;objet de la fuite mémoire ne doit pas être trop important sinon on verra effectivement très vite l&rsquo;erreur <code>OutOfMemoryError</code>.</p><h2 id=le-processus-métier-qui-utilise-de-lintrospection>Le processus métier qui utilise de l&rsquo;introspection</h2><p>Comme je suis fainéant, je n&rsquo;ai pas spécialement envie de créer 300 classes, donc je vais les générer en utilisant l&rsquo;API Compiler du JDK 6. Je me suis un peu inspiré de qui disponible sur le net à ce sujet. En particulier de cette <a href=http://speaking-my-language.blogspot.com/2008/04/instant-evaluation-of-java-code-in.html>entrée</a>. Je passe brièvement dessus pour simplement dire que c&rsquo;est la méthode <code>processBusinessLogic</code> qui est intéressante, on charge des classes, et surtout on appelle une méthode par introspection.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000;font-weight:700>package</span> <span style=color:#555>com.brice.memoryleakwithoutoome</span><span style=color:#000;font-weight:700>;</span>

<span style=color:#000;font-weight:700>import</span> <span style=color:#555>javax.tools.*</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#000;font-weight:700>import</span> <span style=color:#555>java.io.*</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#000;font-weight:700>import</span> <span style=color:#555>java.lang.reflect.Method</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#000;font-weight:700>import</span> <span style=color:#555>java.net.URI</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#000;font-weight:700>import</span> <span style=color:#555>java.nio.charset.Charset</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#000;font-weight:700>import</span> <span style=color:#555>java.util.*</span><span style=color:#000;font-weight:700>;</span>

<span style=color:#000;font-weight:700>public</span> <span style=color:#000;font-weight:700>class</span> <span style=color:#458;font-weight:700>BusinessLayerWithALotOfReflection</span> <span style=color:#000;font-weight:700>{</span>
  <span style=color:#000;font-weight:700>private</span> InMemoryClassLoader classLoader <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>new</span> InMemoryClassLoader<span style=color:#000;font-weight:700>();</span>
  <span style=color:#000;font-weight:700>private</span> List<span style=color:#000;font-weight:700>&lt;</span>String<span style=color:#000;font-weight:700>&gt;</span> classNames <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>new</span> ArrayList<span style=color:#000;font-weight:700>();</span>

  <span style=color:#000;font-weight:700>public</span> <span style=color:#000;font-weight:700>static</span> <span style=color:#458;font-weight:700>void</span> <span style=color:#900;font-weight:700>main</span><span style=color:#000;font-weight:700>(</span>String<span style=color:#000;font-weight:700>...</span> args<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>throws</span> Exception <span style=color:#000;font-weight:700>{</span>
    BusinessLayerWithALotOfReflection businessLayer <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>new</span> BusinessLayerWithALotOfReflection<span style=color:#000;font-weight:700>(</span>3<span style=color:#000;font-weight:700>);</span>
    businessLayer<span style=color:#000;font-weight:700>.</span><span style=color:teal>performBusinessLogic</span><span style=color:#000;font-weight:700>();</span>
  <span style=color:#000;font-weight:700>}</span>

  <span style=color:#000;font-weight:700>public</span> <span style=color:#900;font-weight:700>BusinessLayerWithALotOfReflection</span><span style=color:#000;font-weight:700>(</span><span style=color:#458;font-weight:700>int</span> toGenerate<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>throws</span> Exception <span style=color:#000;font-weight:700>{</span>
    init<span style=color:#000;font-weight:700>(</span>toGenerate<span style=color:#000;font-weight:700>);</span>
  <span style=color:#000;font-weight:700>}</span>

  <span style=color:#000;font-weight:700>public</span> <span style=color:#458;font-weight:700>void</span> <span style=color:#900;font-weight:700>performBusinessLogic</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>throws</span> Exception <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000;font-weight:700>for</span> <span style=color:#000;font-weight:700>(</span>String className <span style=color:#000;font-weight:700>:</span> classNames<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
      Object o <span style=color:#000;font-weight:700>=</span> Class<span style=color:#000;font-weight:700>.</span><span style=color:teal>forName</span><span style=color:#000;font-weight:700>(</span>className<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>true</span><span style=color:#000;font-weight:700>,</span> classLoader<span style=color:#000;font-weight:700>).</span><span style=color:teal>newInstance</span><span style=color:#000;font-weight:700>();</span>
      Method method <span style=color:#000;font-weight:700>=</span> o<span style=color:#000;font-weight:700>.</span><span style=color:teal>getClass</span><span style=color:#000;font-weight:700>().</span><span style=color:teal>getMethod</span><span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#34;m1&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>null</span><span style=color:#000;font-weight:700>);</span>
      method<span style=color:#000;font-weight:700>.</span><span style=color:teal>invoke</span><span style=color:#000;font-weight:700>(</span>o<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>null</span><span style=color:#000;font-weight:700>);</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>}</span>

  <span style=color:#000;font-weight:700>private</span> <span style=color:#458;font-weight:700>void</span> <span style=color:#900;font-weight:700>init</span><span style=color:#000;font-weight:700>(</span><span style=color:#458;font-weight:700>int</span> toGenerate<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>throws</span> Exception <span style=color:#000;font-weight:700>{</span>
    generateSources<span style=color:#000;font-weight:700>(</span>toGenerate<span style=color:#000;font-weight:700>);</span>
  <span style=color:#000;font-weight:700>}</span>

  <span style=color:#000;font-weight:700>private</span> <span style=color:#458;font-weight:700>void</span> <span style=color:#900;font-weight:700>generateSources</span><span style=color:#000;font-weight:700>(</span><span style=color:#458;font-weight:700>int</span> toGenerate<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>throws</span> Exception <span style=color:#000;font-weight:700>{</span>
    List<span style=color:#000;font-weight:700>&lt;</span>JavaObjectFromString<span style=color:#000;font-weight:700>&gt;</span> generatedSources <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>new</span> ArrayList<span style=color:#000;font-weight:700>&lt;</span>JavaObjectFromString<span style=color:#000;font-weight:700>&gt;();</span>

    <span style=color:#000;font-weight:700>for</span> <span style=color:#000;font-weight:700>(</span><span style=color:#458;font-weight:700>int</span> genId<span style=color:#000;font-weight:700>=</span>0<span style=color:#000;font-weight:700>;</span> genId <span style=color:#000;font-weight:700>&lt;</span> toGenerate<span style=color:#000;font-weight:700>;</span> genId<span style=color:#000;font-weight:700>++)</span> <span style=color:#000;font-weight:700>{</span>
      String className <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#34;$Generated&#34;</span> <span style=color:#000;font-weight:700>+</span> genId<span style=color:#000;font-weight:700>;</span>
      StringBuilder sb <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>new</span> StringBuilder<span style=color:#000;font-weight:700>();</span>
      sb<span style=color:#000;font-weight:700>.</span><span style=color:teal>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#34;package com.brice.memoryleakwithoutoome.generated; &#34;</span><span style=color:#000;font-weight:700>);</span>
      sb<span style=color:#000;font-weight:700>.</span><span style=color:teal>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#34;import java.util.Random;&#34;</span><span style=color:#000;font-weight:700>);</span>
      sb<span style=color:#000;font-weight:700>.</span><span style=color:teal>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#34;public class &#34;</span><span style=color:#000;font-weight:700>).</span><span style=color:teal>append</span><span style=color:#000;font-weight:700>(</span>className<span style=color:#000;font-weight:700>).</span><span style=color:teal>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#34; {&#34;</span><span style=color:#000;font-weight:700>);</span>
      sb<span style=color:#000;font-weight:700>.</span><span style=color:teal>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#34;public void m1() { new Random().nextGaussian(); }&#34;</span><span style=color:#000;font-weight:700>);</span>
      sb<span style=color:#000;font-weight:700>.</span><span style=color:teal>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#34;}&#34;</span><span style=color:#000;font-weight:700>);</span>

      classNames<span style=color:#000;font-weight:700>.</span><span style=color:teal>add</span><span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#34;com.brice.memoryleakwithoutoome.generated.&#34;</span> <span style=color:#000;font-weight:700>+</span> className<span style=color:#000;font-weight:700>);</span>
      generatedSources<span style=color:#000;font-weight:700>.</span><span style=color:teal>add</span><span style=color:#000;font-weight:700>(</span><span style=color:#000;font-weight:700>new</span> JavaObjectFromString<span style=color:#000;font-weight:700>(</span>className<span style=color:#000;font-weight:700>,</span> sb<span style=color:#000;font-weight:700>.</span><span style=color:teal>toString</span><span style=color:#000;font-weight:700>()));</span>
    <span style=color:#000;font-weight:700>}</span>
    generateClasses<span style=color:#000;font-weight:700>(</span>generatedSources<span style=color:#000;font-weight:700>);</span>
  <span style=color:#000;font-weight:700>}</span>

  <span style=color:#000;font-weight:700>private</span> <span style=color:#458;font-weight:700>void</span> <span style=color:#900;font-weight:700>generateClasses</span><span style=color:#000;font-weight:700>(</span>Iterable<span style=color:#000;font-weight:700>&lt;</span>JavaObjectFromString<span style=color:#000;font-weight:700>&gt;</span> javaObjects<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>throws</span> IOException <span style=color:#000;font-weight:700>{</span>

    JavaCompiler compiler <span style=color:#000;font-weight:700>=</span> ToolProvider<span style=color:#000;font-weight:700>.</span><span style=color:teal>getSystemJavaCompiler</span><span style=color:#000;font-weight:700>();</span>
    StandardJavaFileManager javaFileManager <span style=color:#000;font-weight:700>=</span> compiler<span style=color:#000;font-weight:700>.</span><span style=color:teal>getStandardFileManager</span><span style=color:#000;font-weight:700>(</span><span style=color:#000;font-weight:700>null</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>null</span><span style=color:#000;font-weight:700>,</span> Charset<span style=color:#000;font-weight:700>.</span><span style=color:teal>defaultCharset</span><span style=color:#000;font-weight:700>());</span>
    InMemoryJavaFileManager inMemoryJavaFileManager <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>new</span> InMemoryJavaFileManager<span style=color:#000;font-weight:700>(</span>javaFileManager<span style=color:#000;font-weight:700>,</span> classLoader<span style=color:#000;font-weight:700>);</span>

    compiler<span style=color:#000;font-weight:700>.</span><span style=color:teal>getTask</span><span style=color:#000;font-weight:700>(</span><span style=color:#000;font-weight:700>null</span><span style=color:#000;font-weight:700>,</span> inMemoryJavaFileManager<span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>null</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>null</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>null</span><span style=color:#000;font-weight:700>,</span> javaObjects<span style=color:#000;font-weight:700>).</span><span style=color:teal>call</span><span style=color:#000;font-weight:700>();</span>

    javaFileManager<span style=color:#000;font-weight:700>.</span><span style=color:teal>close</span><span style=color:#000;font-weight:700>();</span>
  <span style=color:#000;font-weight:700>}</span>

  <span style=color:#000;font-weight:700>static</span> <span style=color:#000;font-weight:700>class</span> <span style=color:#458;font-weight:700>JavaObjectFromString</span> <span style=color:#000;font-weight:700>extends</span> SimpleJavaFileObject <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000;font-weight:700>private</span> String contents <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>null</span><span style=color:#000;font-weight:700>;</span>

    <span style=color:#000;font-weight:700>public</span> <span style=color:#900;font-weight:700>JavaObjectFromString</span><span style=color:#000;font-weight:700>(</span>String className<span style=color:#000;font-weight:700>,</span> String contents<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>throws</span> Exception <span style=color:#000;font-weight:700>{</span>
      <span style=color:#000;font-weight:700>super</span><span style=color:#000;font-weight:700>(</span>URI<span style=color:#000;font-weight:700>.</span><span style=color:teal>create</span><span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#34;string:///&#34;</span> <span style=color:#000;font-weight:700>+</span> className<span style=color:#000;font-weight:700>.</span><span style=color:teal>replace</span><span style=color:#000;font-weight:700>(</span><span style=color:#d14>&#39;.&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#d14>&#39;/&#39;</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>+</span> Kind<span style=color:#000;font-weight:700>.</span><span style=color:teal>SOURCE</span><span style=color:#000;font-weight:700>.</span><span style=color:teal>extension</span><span style=color:#000;font-weight:700>),</span> Kind<span style=color:#000;font-weight:700>.</span><span style=color:teal>SOURCE</span><span style=color:#000;font-weight:700>);</span>
      <span style=color:#000;font-weight:700>this</span><span style=color:#000;font-weight:700>.</span><span style=color:teal>contents</span> <span style=color:#000;font-weight:700>=</span> contents<span style=color:#000;font-weight:700>;</span>
    <span style=color:#000;font-weight:700>}</span>

    <span style=color:#000;font-weight:700>public</span> CharSequence <span style=color:#900;font-weight:700>getCharContent</span><span style=color:#000;font-weight:700>(</span><span style=color:#458;font-weight:700>boolean</span> ignoreEncodingErrors<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>throws</span> IOException <span style=color:#000;font-weight:700>{</span>
      <span style=color:#000;font-weight:700>return</span> contents<span style=color:#000;font-weight:700>;</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>}</span>

  <span style=color:#000;font-weight:700>static</span> <span style=color:#000;font-weight:700>class</span> <span style=color:#458;font-weight:700>InMemoryJavaFileObject</span> <span style=color:#000;font-weight:700>extends</span> SimpleJavaFileObject <span style=color:#000;font-weight:700>{</span>

    InMemoryJavaFileObject<span style=color:#000;font-weight:700>(</span>String name<span style=color:#000;font-weight:700>,</span> Kind kind<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
      <span style=color:#000;font-weight:700>super</span><span style=color:#000;font-weight:700>(</span>URI<span style=color:#000;font-weight:700>.</span><span style=color:teal>create</span><span style=color:#000;font-weight:700>(</span>name<span style=color:#000;font-weight:700>),</span> kind<span style=color:#000;font-weight:700>);</span>
    <span style=color:#000;font-weight:700>}</span>

    <span style=color:#000;font-weight:700>private</span> ByteArrayOutputStream baos<span style=color:#000;font-weight:700>;</span>

    <span style=color:#3c5d5d;font-weight:700>@Override</span>
    <span style=color:#000;font-weight:700>public</span> CharSequence <span style=color:#900;font-weight:700>getCharContent</span><span style=color:#000;font-weight:700>(</span><span style=color:#458;font-weight:700>boolean</span> ignoreEncodingErrors<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>throws</span> IOException<span style=color:#000;font-weight:700>,</span> IllegalStateException<span style=color:#000;font-weight:700>,</span> UnsupportedOperationException <span style=color:#000;font-weight:700>{</span>
      <span style=color:#000;font-weight:700>throw</span> <span style=color:#000;font-weight:700>new</span> UnsupportedOperationException<span style=color:#000;font-weight:700>();</span>
    <span style=color:#000;font-weight:700>}</span>

    <span style=color:#3c5d5d;font-weight:700>@Override</span>
    <span style=color:#000;font-weight:700>public</span> InputStream <span style=color:#900;font-weight:700>openInputStream</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>throws</span> IOException<span style=color:#000;font-weight:700>,</span> IllegalStateException<span style=color:#000;font-weight:700>,</span> UnsupportedOperationException <span style=color:#000;font-weight:700>{</span>
      <span style=color:#000;font-weight:700>return</span> <span style=color:#000;font-weight:700>new</span> ByteArrayInputStream<span style=color:#000;font-weight:700>(</span>baos<span style=color:#000;font-weight:700>.</span><span style=color:teal>toByteArray</span><span style=color:#000;font-weight:700>());</span>
    <span style=color:#000;font-weight:700>}</span>

    <span style=color:#3c5d5d;font-weight:700>@Override</span>
    <span style=color:#000;font-weight:700>public</span> OutputStream <span style=color:#900;font-weight:700>openOutputStream</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>throws</span> IOException<span style=color:#000;font-weight:700>,</span> IllegalStateException<span style=color:#000;font-weight:700>,</span> UnsupportedOperationException <span style=color:#000;font-weight:700>{</span>
      <span style=color:#000;font-weight:700>return</span> baos <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>new</span> ByteArrayOutputStream<span style=color:#000;font-weight:700>();</span>
    <span style=color:#000;font-weight:700>}</span>

    <span style=color:#000;font-weight:700>public</span> <span style=color:#458;font-weight:700>byte</span><span style=color:#000;font-weight:700>[]</span> <span style=color:#900;font-weight:700>getClassDefinition</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
      <span style=color:#000;font-weight:700>return</span> baos<span style=color:#000;font-weight:700>.</span><span style=color:teal>toByteArray</span><span style=color:#000;font-weight:700>();</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>}</span>

  <span style=color:#000;font-weight:700>static</span> <span style=color:#000;font-weight:700>class</span> <span style=color:#458;font-weight:700>InMemoryJavaFileManager</span> <span style=color:#000;font-weight:700>extends</span> ForwardingJavaFileManager<span style=color:#000;font-weight:700>&lt;</span>StandardJavaFileManager<span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000;font-weight:700>private</span> InMemoryClassLoader inMemoryClassLoader<span style=color:#000;font-weight:700>;</span>

    <span style=color:#000;font-weight:700>protected</span> <span style=color:#900;font-weight:700>InMemoryJavaFileManager</span><span style=color:#000;font-weight:700>(</span>StandardJavaFileManager fileManager<span style=color:#000;font-weight:700>,</span> InMemoryClassLoader classLoader<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
      <span style=color:#000;font-weight:700>super</span><span style=color:#000;font-weight:700>(</span>fileManager<span style=color:#000;font-weight:700>);</span>
      <span style=color:#000;font-weight:700>this</span><span style=color:#000;font-weight:700>.</span><span style=color:teal>inMemoryClassLoader</span> <span style=color:#000;font-weight:700>=</span> classLoader<span style=color:#000;font-weight:700>;</span>
    <span style=color:#000;font-weight:700>}</span>

    <span style=color:#3c5d5d;font-weight:700>@Override</span>
    <span style=color:#000;font-weight:700>public</span> JavaFileObject <span style=color:#900;font-weight:700>getJavaFileForOutput</span><span style=color:#000;font-weight:700>(</span>Location location<span style=color:#000;font-weight:700>,</span>
                                               String name<span style=color:#000;font-weight:700>,</span>
                                               JavaFileObject<span style=color:#000;font-weight:700>.</span><span style=color:teal>Kind</span> kind<span style=color:#000;font-weight:700>,</span>
                                               FileObject sibling<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>throws</span> IOException <span style=color:#000;font-weight:700>{</span>
      <span style=color:#000;font-weight:700>return</span> inMemoryClassLoader<span style=color:#000;font-weight:700>.</span><span style=color:teal>registerClassDefinition</span><span style=color:#000;font-weight:700>(</span><span style=color:#000;font-weight:700>new</span> InMemoryJavaFileObject<span style=color:#000;font-weight:700>(</span>name<span style=color:#000;font-weight:700>,</span> kind<span style=color:#000;font-weight:700>));</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>}</span>

  <span style=color:#000;font-weight:700>static</span> <span style=color:#000;font-weight:700>class</span> <span style=color:#458;font-weight:700>InMemoryClassLoader</span> <span style=color:#000;font-weight:700>extends</span> ClassLoader <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000;font-weight:700>private</span> Map<span style=color:#000;font-weight:700>&lt;</span>String <span style=color:#000;font-weight:700>,</span> InMemoryJavaFileObject<span style=color:#000;font-weight:700>&gt;</span> inMemoryClassObjects <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>new</span> HashMap<span style=color:#000;font-weight:700>&lt;</span>String <span style=color:#000;font-weight:700>,</span> InMemoryJavaFileObject<span style=color:#000;font-weight:700>&gt;();</span>

    <span style=color:#000;font-weight:700>protected</span> Class <span style=color:#900;font-weight:700>findClass</span><span style=color:#000;font-weight:700>(</span>String name<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>throws</span> ClassNotFoundException <span style=color:#000;font-weight:700>{</span>
      InMemoryJavaFileObject classObject <span style=color:#000;font-weight:700>=</span> inMemoryClassObjects<span style=color:#000;font-weight:700>.</span><span style=color:teal>get</span><span style=color:#000;font-weight:700>(</span>name<span style=color:#000;font-weight:700>);</span>
      <span style=color:#000;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span>classObject <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>null</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#458;font-weight:700>byte</span><span style=color:#000;font-weight:700>[]</span> classDefinition <span style=color:#000;font-weight:700>=</span> classObject<span style=color:#000;font-weight:700>.</span><span style=color:teal>getClassDefinition</span><span style=color:#000;font-weight:700>();</span>
        <span style=color:#000;font-weight:700>return</span> defineClass<span style=color:#000;font-weight:700>(</span>name<span style=color:#000;font-weight:700>,</span> classDefinition<span style=color:#000;font-weight:700>,</span> 0<span style=color:#000;font-weight:700>,</span> classDefinition<span style=color:#000;font-weight:700>.</span><span style=color:teal>length</span><span style=color:#000;font-weight:700>);</span>
      <span style=color:#000;font-weight:700>}</span>
      <span style=color:#000;font-weight:700>return</span> <span style=color:#000;font-weight:700>super</span><span style=color:#000;font-weight:700>.</span><span style=color:teal>findClass</span><span style=color:#000;font-weight:700>(</span>name<span style=color:#000;font-weight:700>);</span>
    <span style=color:#000;font-weight:700>}</span>

    <span style=color:#000;font-weight:700>public</span> InMemoryJavaFileObject <span style=color:#900;font-weight:700>registerClassDefinition</span><span style=color:#000;font-weight:700>(</span>InMemoryJavaFileObject object<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
      inMemoryClassObjects<span style=color:#000;font-weight:700>.</span><span style=color:teal>put</span><span style=color:#000;font-weight:700>(</span>object<span style=color:#000;font-weight:700>.</span><span style=color:teal>getName</span><span style=color:#000;font-weight:700>(),</span> object<span style=color:#000;font-weight:700>);</span>
      <span style=color:#000;font-weight:700>return</span> object<span style=color:#000;font-weight:700>;</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><h2 id=le-code-avec-la-fuite-mémoire>Le code avec la fuite mémoire</h2><p>Bon voilà pour le code qui simule du code métier avec de l&rsquo;introspection, maintenant c&rsquo;est au tour de simuler le service qui engendre une fuite mémoire. L&rsquo;utilisation des thread est accessoire cela dit, mais ça permet de rappeler le fonctionnement d&rsquo;une véritable application.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#000;font-weight:700>package</span> <span style=color:#555>com.brice.memoryleakwithoutoome</span><span style=color:#000;font-weight:700>;</span>

<span style=color:#000;font-weight:700>import</span> <span style=color:#555>java.lang.management.ManagementFactory</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#000;font-weight:700>import</span> <span style=color:#555>java.util.Set</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#000;font-weight:700>import</span> <span style=color:#555>java.util.UUID</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#000;font-weight:700>import</span> <span style=color:#555>java.util.concurrent.ConcurrentSkipListSet</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#000;font-weight:700>import</span> <span style=color:#555>java.util.concurrent.ExecutorService</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#000;font-weight:700>import</span> <span style=color:#555>java.util.concurrent.Executors</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#000;font-weight:700>import</span> <span style=color:#555>java.util.logging.Logger</span><span style=color:#000;font-weight:700>;</span>

<span style=color:#000;font-weight:700>public</span> <span style=color:#000;font-weight:700>class</span> <span style=color:#458;font-weight:700>Service</span> <span style=color:#000;font-weight:700>{</span>

  <span style=color:#000;font-weight:700>private</span> <span style=color:#000;font-weight:700>static</span> Set<span style=color:#000;font-weight:700>&lt;</span>UUID<span style=color:#000;font-weight:700>&gt;</span> sessions <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>new</span> ConcurrentSkipListSet<span style=color:#000;font-weight:700>&lt;</span>UUID<span style=color:#000;font-weight:700>&gt;();</span>
  <span style=color:#000;font-weight:700>private</span> <span style=color:#000;font-weight:700>static</span> ExecutorService executor <span style=color:#000;font-weight:700>=</span> Executors<span style=color:#000;font-weight:700>.</span><span style=color:teal>newCachedThreadPool</span><span style=color:#000;font-weight:700>();</span>
  <span style=color:#000;font-weight:700>private</span> <span style=color:#000;font-weight:700>static</span> BusinessLayerWithALotOfReflection businessLayer<span style=color:#000;font-weight:700>;</span>
  <span style=color:#000;font-weight:700>static</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000;font-weight:700>try</span> <span style=color:#000;font-weight:700>{</span>
      businessLayer <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>new</span> BusinessLayerWithALotOfReflection<span style=color:#000;font-weight:700>(</span>300<span style=color:#000;font-weight:700>);</span>
    <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>catch</span> <span style=color:#000;font-weight:700>(</span>Exception e<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
      e<span style=color:#000;font-weight:700>.</span><span style=color:teal>printStackTrace</span><span style=color:#000;font-weight:700>();</span>
      System<span style=color:#000;font-weight:700>.</span><span style=color:teal>exit</span><span style=color:#000;font-weight:700>(</span>1<span style=color:#000;font-weight:700>);</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>}</span>

  <span style=color:#000;font-weight:700>public</span> <span style=color:#000;font-weight:700>static</span> <span style=color:#458;font-weight:700>void</span> <span style=color:#900;font-weight:700>main</span><span style=color:#000;font-weight:700>(</span>String<span style=color:#000;font-weight:700>[]</span> args<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>throws</span> Throwable <span style=color:#000;font-weight:700>{</span>
    System<span style=color:#000;font-weight:700>.</span><span style=color:teal>out</span><span style=color:#000;font-weight:700>.</span><span style=color:teal>println</span><span style=color:#000;font-weight:700>(</span>ManagementFactory<span style=color:#000;font-weight:700>.</span><span style=color:teal>getRuntimeMXBean</span><span style=color:#000;font-weight:700>().</span><span style=color:teal>getName</span><span style=color:#000;font-weight:700>());</span>
    <span style=color:#000;font-weight:700>try</span> <span style=color:#000;font-weight:700>{</span>
      <span style=color:#000;font-weight:700>while</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000;font-weight:700>true</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
        executor<span style=color:#000;font-weight:700>.</span><span style=color:teal>submit</span><span style=color:#000;font-weight:700>(</span><span style=color:#000;font-weight:700>new</span> LeakyThread<span style=color:#000;font-weight:700>(</span>businessLayer<span style=color:#000;font-weight:700>));</span>
        Thread<span style=color:#000;font-weight:700>.</span><span style=color:teal>sleep</span><span style=color:#000;font-weight:700>(</span>1<span style=color:#000;font-weight:700>);</span>
      <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>catch</span> <span style=color:#000;font-weight:700>(</span>Throwable t<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
      Logger<span style=color:#000;font-weight:700>.</span><span style=color:teal>getAnonymousLogger</span><span style=color:#000;font-weight:700>().</span><span style=color:teal>severe</span><span style=color:#000;font-weight:700>(</span>t<span style=color:#000;font-weight:700>.</span><span style=color:teal>toString</span><span style=color:#000;font-weight:700>());</span>
      <span style=color:#000;font-weight:700>throw</span> t<span style=color:#000;font-weight:700>;</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>}</span>

  <span style=color:#000;font-weight:700>private</span> <span style=color:#000;font-weight:700>static</span> <span style=color:#000;font-weight:700>class</span> <span style=color:#458;font-weight:700>LeakyThread</span> <span style=color:#000;font-weight:700>extends</span> Thread <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000;font-weight:700>private</span> BusinessLayerWithALotOfReflection businessLayer<span style=color:#000;font-weight:700>;</span>

    <span style=color:#000;font-weight:700>public</span> <span style=color:#900;font-weight:700>LeakyThread</span><span style=color:#000;font-weight:700>(</span>BusinessLayerWithALotOfReflection businessLayer<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
      <span style=color:#000;font-weight:700>this</span><span style=color:#000;font-weight:700>.</span><span style=color:teal>businessLayer</span> <span style=color:#000;font-weight:700>=</span> businessLayer<span style=color:#000;font-weight:700>;</span>
    <span style=color:#000;font-weight:700>}</span>

    <span style=color:#3c5d5d;font-weight:700>@Override</span>
    <span style=color:#000;font-weight:700>public</span> <span style=color:#458;font-weight:700>void</span> <span style=color:#900;font-weight:700>run</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
      <span style=color:#998;font-style:italic>// leak
</span><span style=color:#998;font-style:italic></span>      sessions<span style=color:#000;font-weight:700>.</span><span style=color:teal>add</span><span style=color:#000;font-weight:700>(</span>UUID<span style=color:#000;font-weight:700>.</span><span style=color:teal>randomUUID</span><span style=color:#000;font-weight:700>());</span>

      <span style=color:#998;font-style:italic>// non leaky business logic using a lot reflection
</span><span style=color:#998;font-style:italic></span>      <span style=color:#000;font-weight:700>try</span> <span style=color:#000;font-weight:700>{</span>
        businessLayer<span style=color:#000;font-weight:700>.</span><span style=color:teal>performBusinessLogic</span><span style=color:#000;font-weight:700>();</span>
      <span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>catch</span> <span style=color:#000;font-weight:700>(</span>Exception e<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
        e<span style=color:#000;font-weight:700>.</span><span style=color:teal>printStackTrace</span><span style=color:#000;font-weight:700>();</span>
        <span style=color:#000;font-weight:700>return</span><span style=color:#000;font-weight:700>;</span>
      <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>C&rsquo;est à la ligne de 30 du code que je contrôle le débit de la fuite mémoire. En effet si je retire ce <code>Thread.sleep</code>, il y a très vite une OOME. Pour la fuite mémoire, celle-ci consiste juste à alimenter un liste de <code>String</code>. On pourrait par exemple imaginer que dans une application réelle ce code stockerait des objets dans une Map pour chaque session.</p><p>Afin de ne pas attendre des heures avec juste quelques <code>String</code>, je vais limiter l&rsquo;espace mémoire de mon application à 10MB:</p><pre><code class=language-default data-lang=default>-Xms10m -Xmx10m
</code></pre><p>Je vais également ajouter les paramètres à la JVM pour suivre le GC.</p><p>Et le résultat est là, l&rsquo;application ne plante toujours pas après 6 minutes.</p><p>Effectivement les paramètres de la JVM donnent une allure différente d&rsquo;une application en production, mais ici le but est de reproduire un scénario de fuite mémoire sans OutOfMemoryError. Le GC a donc l&rsquo;allure suivante :</p><p><img src=/assets/gc1.png alt=gc></p><p>On voit un premier Full GC vers 1min30 ou les SoftReferences sont nettoyées, et puis vers 2min30 c&rsquo;est la catastrophe, il n&rsquo;y a que des Full GC, la JVM va constamment réclamer les références issues de l&rsquo;introspection, le programme va constamment en recréer, avec la saturation de la mémoire la lenteur de tous les FullGC devient manifeste. Et comme dit plus haut les thread dump ne vont pas révéler de point de contention, ils vont juste montrer que l&rsquo;application est lente. En particulier les thread dump vont surtout révéler les stacks des modules ou l&rsquo;application est plus lente!</p><p>D&rsquo;ailleurs sur la sortie standard, on voit au premier Full GC les traces suivantes, et elles arrivent  plus régulièrement une fois que les GC s&rsquo;enchainent :</p><pre><code>...
[Unloading class sun.reflect.GeneratedConstructorAccessor147]
[Unloading class sun.reflect.GeneratedConstructorAccessor419]
[Unloading class sun.reflect.GeneratedMethodAccessor104]
[Unloading class sun.reflect.GeneratedMethodAccessor151]
[Unloading class sun.reflect.GeneratedMethodAccessor57]
[Unloading class sun.reflect.GeneratedMethodAccessor390]
[Unloading class sun.reflect.GeneratedConstructorAccessor8]
[Unloading class sun.reflect.GeneratedMethodAccessor207]
[Unloading class sun.reflect.GeneratedMethodAccessor395]
[Unloading class sun.reflect.GeneratedConstructorAccessor83]
...
</code></pre><p>Autre outil à utiliser, jVisualVM qui est disponible en standard avec le JDK6. On se retrouve avec onglet de monitoring sympa. A noter que les graphes d&rsquo;activité du CPU ne sont pas disponible en standard sur jVisualVM avec la JDK6.</p><p><img src=/assets/visualvm-mon1.png alt=visualvm-mon></p><p>Ce que je ne voyais pas avec GCViewer c&rsquo;est que le nombre de threads actives a dramatiquement baissé, ce qui confirme la lenteur exécution, les traitements mettent vraiment plus longtemps, et les autres threads sont alors mises en standby. Si on fait attention à la fenêtre temporelle, ça passe vers 14h48, à ce moment là, la mémoire heap n&rsquo;est pas encore complètement saturée les GC tenaient jusque là. C&rsquo;est ensuite que <strong>les</strong> Full GC prennent le relai pour réclamer de la mémoire, c&rsquo;est donc à ce moment que les SoftReference sont collectées. Et comme dit plus haut, ces références sont recréées par les <em>traitements métier</em>. Et comme le Full GC s&rsquo;exerce en permanence après ce moment, les références qui viennent d'être recréés sont collectées à nouveau. Et voilà la boucle est bouclée.</p><h1 id=conclusion>Conclusion</h1><p>En conclusion, ce n&rsquo;est pas parce qu&rsquo;il n&rsquo;y a pas de OutOfMemoryError qu&rsquo;il n&rsquo;y a pas de fuite mémoire. Plus généralement le réflexe c&rsquo;est de se demander si notre application utilise beaucoup d&rsquo;introspection ou plus simplement si l&rsquo;application utilise beaucoup de références plus faibles comme les WeakReference, SoftReference.</p></div><div class="navigation navigation-single"><a href=/2010/02/09/a-propos-de-joda-time/ class=navigation-prev><i aria-hidden=true class="fa fa-chevron-left"></i><span class=navigation-tittle>A propos de Joda-Time</span></a>
<a href=/2010/02/16/les-collections-par-google-comment-sy-retrouver/ class=navigation-next><span class=navigation-tittle>Les collections par Google, comment s'y retrouver?</span>
<i aria-hidden=true class="fa fa-chevron-right"></i></a></div><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){this.page.identifier='41 http:\/\/dutheil.brice.online.fr\/blog\/?p=41';this.page.title='Une fuite mémoire, beaucoup de reflection et pas de OutOfMemoryError';this.page.url='https://blog.arkey.fr/2010/02/12/une-fuite-memoire-beaucoup-de-reflection-et-pas-de-outofmemoryerror/';};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"thecoffeeworkshop"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></div><script defer src=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/js/all.min.js integrity="sha256-KzZiKy0DWYsnwMF+X1DvQngQ2/FxF7MF3Ff72XcpuPs=" crossorigin=anonymous></script><script type=text/javascript>hljs.initHighlightingOnLoad();</script></body></html>