#!/bin/sh

if [ -f /usr/local/bin/asciidoctor ]; then
  ad="/usr/local/bin/asciidoctor"
else
  ad="/usr/bin/asciidoctor"
fi

basedir=.
diagram_target=/assets/diagram

$ad --trace \
  --base-dir ${basedir} \
  --require asciidoctor-diagram \
  --no-header-footer \
  --attribute docinfo=shared \
  --attribute nofooter \
  --attribute skip-front-matter \
  --attribute library=asciidoctor-ruby \
  --attribute icons=font \
  --attribute sectlinks \
  --attribute sectanchors \
  --attribute figure-caption! \
  --attribute source-highlighter=highlightjs \
  --attribute experimental=true \
  --attribute out_dir=resources/_gen/diagram \
  --attribute toc-title! \
  --attribute diagram-svg-type=inline \
  - \
  | sed -E -e "s,img src=\"([^/]+)\",img src=\"${diagram_target}/\1\","

# mv_diagram_target=static${diagram_target}
# mkdir -p ${mv_diagram_target}
# if ls ${basedir}/*.svg >/dev/null 2>&1; then
#   mv -f ${basedir}/*.svg ${mv_diagram_target}
# fi
# 
# if ls *.png >/dev/null 2>&1; then
#   mv -f ${basedir}/*.png ${mv_diagram_target}
# fi

