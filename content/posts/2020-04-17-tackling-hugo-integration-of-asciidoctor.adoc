---
authors: ["brice.dutheil"]
date: "2020-04-16T14:01:50+02:00"
language: en
draft: true
tags: ["webpages", "jekyll", "staticsite", "hugo", "github pages", "asciidoctor"]
slug: "tackling-hugo-integration-of-asciidoctor" 
title: "Tackling Hugo Integration of Asciidoctor"
series: ["Jekyll to Hugo with Asciidoctor"]
---

== Integrate Asciidoctor as everyone should expect

While Hugo comes with Asciidoctor support, they are in reality several issues
to account for at this time: 



While basic rendering of asciidoc files works, we soon encounter problems

* HTML structure is not modern by default
+
[source,html]
----
<div class="paragraph">
<p>I’ve crafted my own simple shortcode for Amazon <code>{{&lt; amzn "B07XW76VHZ" &gt;}}</code> :</p>
</div>
----

But diving in the HTML soon reveal other issues

.div post
[source, html]
----
<div class="post">

<!DOCTYPE html>
<html lang="en">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Asciidoctor 2.0.10">
    <title>Integrate Asciidoctor as everyone should expect</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
    <style>
    //... asciidoctor inline css
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">


    <body class="article">
        <div id="header">
        </div>
        <div id="content">

        ... the article content


        </div>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/github.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js"></script>
        <script>hljs.initHighlighting()</script>
        <script type="text/x-mathjax-config;executed=true">
        MathJax.Hub.Config({
          messageStyle: "none",
          tex2jax: {
            inlineMath: [["\\(", "\\)"]],
            displayMath: [["\\[", "\\]"]],
            ignoreClass: "nostem|nolatexmath"
          },
          asciimath2jax: {
            delimiters: [["\\$", "\\$"]],
            ignoreClass: "nostem|noasciimath"
          },
          TeX: { equationNumbers: { autoNumber: "none" } }
        })
        MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
          MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
            if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains('stemblock')) {
              data.math.root.display = "block"
            }
            return data
          })
        })
        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
    </body>
    </html>
</div>
----

The whole HTML document is here along with other script and css competing with the one of Hugo.

* [ ] source listings are not _syntax-highlighted_.
* [ ] CSS is a bit off for some elements, and _corrupts_ other elements like the sidebar
* [ ] inline css



tweak css to integrate with scss of the theme : https://css2sass.herokuapp.com/


TIP: First we need to be able to override how hugo invoke asciidoctor. Hugo expects an
executable name `asciidoctor`, we can trick it to run a shell script instead, by creating
in the repository a file named `./bin/asciidoctor`. Then run hugo with the following
environment : `env PATH=$PWD/bin:$PATH hugo serve`.


The Semantic HTML5 converter from https://github.com/jirutka/asciidoctor-html5s
outputs semantic HTML, but doesn't support all features of asciidoctor like
icons for admonition blocks, also it uses the default CSS which is not suited
for this HTML tree path to elements differ, class names differ as well.


Then to fix how asciidoc renders the doc, by using the *semantic*
HTML5 backend as suggested in this https://ratfactor.com/hugo-adoc-html5s/[blog post].
`gem install asciidoctor-html5s`. And pass this option in the script `--backend html5s`.
While this slightly improves the HTML, this broke the syntax highlighting, so I didn't
use it.

Inspired by https://www.zipproth.com/cheat-sheets/hugo-asciidoctor/

hugo uses : `--no-header-footer --safe --trace -`

.from the https://asciidoctor.org/man/asciidoctor/[man page]
|===
| `--safe`
| Set safe mode level to safe. Enables include directives, but prevents access to ancestor paths of source file. Provided for compatibility with the asciidoc command. If not set, the safe mode level defaults to unsafe when Asciidoctor is invoked using this script.

| `-s`, `--no-header-footer`
| Output an embeddable document, which excludes the header, the footer, and everything outside the body of the document. This option is useful for producing documents that can be inserted into an external template.

| `-`
| If FILE is - then the AsciiDoc source is read from standard input.
|===



../bin/asciidoctor
[source,bash]
----
#!/bin/bash
                                       
echo $@

if [ -f /usr/local/bin/asciidoctor ]; then
  ad="/usr/local/bin/asciidoctor"
else
  ad="/usr/bin/asciidoctor"
fi

$ad --trace --verbose \
  --base-dir . \
  --require asciidoctor-html5s \
  --backend html5 \
  --no-header-footer \
  --attribute=icons=font \
  --attribute=docinfo=shared \
  --attribute=nofooter \
  --attribute=sectanchors \
  --attribute=experimental=true \
  --attribute=figure-caption! \
  --attribute=source-highlighter=highlightjs \
  --attribute=toc-title! \
  -


----

https://dburet.gitlab.io/blog/2020-01-22-adoc-chart/



When using defining the attribute `:fonts: icons` asciidoctor will use Font Awesome 4.7 names
for example with the admonition block like `TIP:` it will generate HTML asking for `icon-tip`,
which is named differently is FA5 :

There are two issues https://github.com/asciidoctor/asciidoctor/issues/2535[asciidoctor/asciidoctor#2535]
and https://github.com/asciidoctor/asciidoctor-reveal.js/issues/304[asciidoctor/asciidoctor-reveal.js#304]
that indicated this is not something supported at the moment, adding the FA4 _shim_
doews not help, as FA4 conflicts with other solid icons

.does not work
[source, diff]
----
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/js/all.min.js" integrity="sha256-KzZiKy0DWYsnwMF+X1DvQngQ2/FxF7MF3Ff72XcpuPs=" crossorigin="anonymous"></script>
+ <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/js/v4-shims.min.js" integrity="sha256-prFmieX9aRVhOV/ldXGklUUhS7NRBQUijQU4HcdnO8Q=" crossorigin="anonymous"></script>
----

So icons remain disabled for now

https://www.zipproth.com/cheat-sheets/hugo-asciidoctor/

icon:tags[] ruby, asciidoctor


== With the Github Actions





*TODO* investigate https://github.com/asciidoctor/docker-asciidoctor





'''

You need a smoke test content to check what feature works or not:




Asciidoctor Demo
================

////
Big ol' comment

sittin' right 'tween this here title 'n header metadata
////
Dan Allen <thedoc@asciidoctor.org>

* emoji :plus:
* html &#43;

[role='lead']
This is a demonstration of {library}. And this is the preamble of this document.

[[purpose]]
.Purpose
****
This document exercises many of the features of AsciiDoc to test the {library} implementation.
****

TIP: If you want the output to look familiar, copy (or link) the AsciiDoc stylesheet, asciidoc.css, to the output directory.

NOTE: Items marked with TODO are either not yet supported or a work in progress.

[[first,First Steps]]
== First Steps with http://asciidoc.org[AsciiDoc]

.Inline markup
* single quotes around a phrase place 'emphasis'
* astericks around a phrase make the text *bold*
* double astericks around one or more **l**etters in a word make those letters bold
* double underscore around a __sub__string in a word emphasize that substring
* use carrots around characters to make them ^super^script
* use tildes around characters to make them ~sub~script
ifdef::basebackend-html[]
* to pass through +++<u>HTML</u>+++ directly, surround the text with triple plus
endif::basebackend-html[]
ifdef::basebackend-docbook[]
* to pass through +++<constant>XML</constant>+++ directly, surround the text with triple plus
endif::basebackend-docbook[]

// separate two adjacent lists using a line comment (only the leading // is required)

- characters can be escaped using a {backslash}
* for instance, you can escape a quote inside emphasized text like 'Here\'s Johnny!'
- you can safely use reserved XML characters like <, > and &, which are escaped when rendering
- force a space{sp}between inline elements using the \{sp} attribute
- hold text together with an intrinsic non-breaking{nbsp}space attribute, \{nbsp}
- handle words with unicode characters like in the name Gregory Romé
- claim your copyright (C), registered trademark (R) or trademark (TM)

You can write text http://example.com[with inline links], optionally{sp}using an explicit link:http://example.com[link prefix]. In either case, the link can have a http://example.com?foo=bar&lang=en[query string].

If you want to break a line +
just end it in a {plus} sign +
and continue typing on the next line.

=== Lists Upon Lists

.Adjacent lists
* this list
* should join

* to have
* four items

[[numbered]]
.Numbered lists
. These items
. will be auto-numbered
.. and can be nested
. A numbered list can nest
* unordered
* list
* items

.Statement
I swear I left it in 'Guy\'s' car. Let\'s go look for it.

[[defs]]
term::
definition
line two
[[another_term]]another term::

  another definition, which can be literal (indented) or regular paragraph

This should be a standalone paragraph, not grabbed by the definition list.

[[nested]]
* first level
written on two lines
* first level
+
....
with this literal text
....
+
** second level
*** third level
- fourth level
* back to +
first level

// this is just a comment

Let's make a horizontal rule...

'''

then take a break.


== We're back!

Want to see a image:/img/hugo.png[Tiger]?

Do you feel safer with the tiger in a box?

.Hugo in a box
image::/img/hugo.png[]

start inlcude /

include::content/posts/include.asciidoc.adoc[]

/ end include

.Asciidoctor usage example, should contain 3 lines
[source, ruby]
----
doc = Asciidoctor::Document.new("*This* is it!", :header_footer => false)

puts doc.render
----

// FIXME: use ifdef to show output according to backend
Here's what it outputs (using the built-in templates):

....
<div class="paragraph">
  <p><strong>This</strong> is it!</p>
</div>
....

=== ``Quotes''

____
AsciiDoc is 'so' *powerful*!
____

This verse comes to mind.

[verse]
La la la

Here's another quote:

[quote, Sir Arthur Conan Doyle, The Adventures of Sherlock Holmes]
____
When you have eliminated all which is impossible, then whatever remains, however improbable, must be the truth.
____

Getting Literal [[literally]]
-----------------------------

 Want to get literal? Just prefix a line with a space (just one will do).

....
I'll join that party, too.
....

We forgot to mention in <<numbered>> that you can change the numbering style.

.. first item (yeah!)
.. second item, looking `so mono`
.. third item, +mono+ it is!

// This attribute line will get reattached to the next block
// despite being followed by a trailing blank line
[id='wrapup']

== Wrap-up

NOTE: AsciiDoc is quite cool, you should try it!

[TIP]
.Info
=====
Go to this URL to learn more about it:

* http://asciidoc.org

Or you could return to the xref:first[] or <<purpose,Purpose>>.
=====

Here's a reference to the definition of <<another_term>>, in case you forgot it.

[NOTE]
One more thing. Happy documenting!

[[google]]When all else fails, head over to <http://google.com>.

++++
<details>
<summary>Passthrough block</summary>

Hello

</summary>
++++
