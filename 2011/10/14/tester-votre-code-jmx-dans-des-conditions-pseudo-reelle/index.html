<!DOCTYPE html>
<html lang="en">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.69.0" />

    
    
    

<title>Tester votre code JMX dans des conditions pseudo réelle. • The Coffee Workshop</title>


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Tester votre code JMX dans des conditions pseudo réelle."/>
<meta name="twitter:description" content="Vous devez écrire du code qui fait appel à JMX, en bon citoyen et bon développeur vous voulez tester ce code.
Première approche; vous enregistrez vos MBean sur un MBeanServer, disons celui de la plateforme (avec Java 6 : ManagementFactory."/>

<meta property="og:title" content="Tester votre code JMX dans des conditions pseudo réelle." />
<meta property="og:description" content="Vous devez écrire du code qui fait appel à JMX, en bon citoyen et bon développeur vous voulez tester ce code.
Première approche; vous enregistrez vos MBean sur un MBeanServer, disons celui de la plateforme (avec Java 6 : ManagementFactory." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.arkey.fr/2011/10/14/tester-votre-code-jmx-dans-des-conditions-pseudo-reelle/" />
<meta property="article:published_time" content="2011-10-14T13:01:31+00:00" />
<meta property="article:modified_time" content="2011-10-14T13:01:31+00:00" /><meta property="og:site_name" content="Arkey" />


    






<link rel="stylesheet" href="/scss/hyde-hyde.e8dcd6124217521cb99429500b4fa8392b1f372d14ea1a5a2631f10b3b4652ff.css" integrity="sha256-6NzWEkIXUhy5lClQC0&#43;oOSsfNy0U6hpaJjHxCztGUv8=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    
    <link rel="shortcut icon" sizes="192x192" href="/android-192-favicon.png">

    
    <link rel="shortcut icon" href="/android-192-favicon.png">
    
    


    
</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://blog.arkey.fr">The Coffee Workshop</a>
      </span>
      
      
        <div class="author-image">
          <img src="https://www.gravatar.com/avatar/f31c7fbcbb0766d0632d96fd7e74b649?s=240&d=mp" class="img--circle img--headshot element--center" alt="gravatar">
        </div>
      
      <p class="site__description">
         Java mostly, and general tech 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">The Coffee Workshop</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/"><span class='fa-icon'><i class='fas fa-home'></i></span><code>cd <em>~</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/posts/"><span class='fa-icon'><i class='fas fa-stream'></i></span><code>ls <em>posts/*</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/series/"><span class='fa-icon'><i class='fas fa-list-alt'></i></span><code>grep -o <em>series</em> posts/* | sort -u</code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/"><span class='fa-icon'><i class='fas fa-tags'></i></span><code>grep -o <em>tags</em> posts/* | sort -u</code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/cool-stuff/"><span class='fa-icon'><i class='fas fa-thumbtack'></i></span><code>cd <em>cool-stuff</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/whoami/"><span class='fa-icon'><i class='fas fa-id-card'></i></span><code>whoami</code>
						<span></span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://twitter.com/@BriceDutheil" rel="me"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	
	<a href="https://github.com/bric3" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="https://speakerdeck.com/bric3" rel="me"><i class="fab fa-speaker-deck" aria-hidden="true"></i></i></a>
	
	
	
	
	
	
	
	<a href="https://linkedin.com/in/dutheilbrice" rel="me"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="https://stackoverflow.com/users/48136/brice" rel="me"><i class="fab fa-stack-overflow fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
</section>

      </div>
    </div>
    
<div class="copyright">
  &copy; 2010 - 2020 Brice Dutheil
  
    <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>
  
</div>



  </div>
</div>

        <div class="content container">
            
    
<article>
  <header>
    <h1>Tester votre code JMX dans des conditions pseudo réelle.</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> 2011-10-14
    
    
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/code">code</a>
           
      
          <a class="badge badge-tag" href="/tags/jmx">jmx</a>
           
      
          <a class="badge badge-tag" href="/tags/tdd">tdd</a>
           
      
          <a class="badge badge-tag" href="/tags/test-unitaire">test unitaire</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 3 min read
</div>


  </header>
  
  
  <div class="post">
    <p>Vous devez écrire du code qui fait appel à JMX, en bon citoyen et bon développeur vous voulez tester ce code.</p>
<p>Première approche; vous enregistrez vos MBean sur un <code>MBeanServer</code>, disons celui de la plateforme (avec Java 6 : <code>ManagementFactory.getPlatformMBeanServer()</code>).</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">mBeanServer<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">registerMBean</span><span style="color:#000;font-weight:bold">(</span>theMBean<span style="color:#000;font-weight:bold">,</span> theMBean<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getObjectName</span><span style="color:#000;font-weight:bold">());</span>
</code></pre></div><p>Étant donné que <code>MBeanServer</code> étends <code>MBeanServerConnection</code> il est possible d’exécuter des querys, de faire des invocations sur les MBean etc. Si le code est suffisamment isolé des aspects techniques de connexion à JMX, vous passerez le <code>MBeanServer</code> en lieu et place de la <code>MBeanServerConnection</code>.</p>
<p>Supposons le code suivant.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">OperateOnJMXConnection</span> <span style="color:#000;font-weight:bold">implements</span> JMXOperation <span style="color:#000;font-weight:bold">{</span>

    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">perform</span><span style="color:#000;font-weight:bold">(</span>MBeanServerConnection connection<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#998;font-style:italic">// doing some stuff there
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#000;font-weight:bold">public</span> Result <span style="color:#900;font-weight:bold">getResult</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000;font-weight:bold">return</span> result<span style="color:#000;font-weight:bold">;</span> <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Pour tester ce code il faudrait alors écrire :</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#3c5d5d;font-weight:bold">@Test</span>
<span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">do_not_fail</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
    operateOnJMXConnection<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">perform</span><span style="color:#000;font-weight:bold">(</span>mbeanServer<span style="color:#000;font-weight:bold">);</span>

    assertThat<span style="color:#000;font-weight:bold">(</span>result<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">satisfies</span><span style="color:#000;font-weight:bold">(</span>someCondition<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Mais voilà, vous restez en local, et par exemple si vous avez merdé sur la sérialisation de vos beans, vous ne verrez pas d'échec dans vos test et vous aurez une surprise en prod, ou avant si votre projet a un processus qualité décent.</p>
<p>Évidement il y a une solution, l&rsquo;idée c&rsquo;est de pouvoir se connecter au <code>mBeanServer</code> local à votre processus (typiquement dans maven 3, l’exécution de vos tests peuvent être forkée).</p>
<p>Alors j&rsquo;ai essayé de récupérer les informations pour récupérer les informations de la VM qui tourne, mais bon on tombe dans des classes <strong>sun</strong>, j&rsquo;ai préféré ne pas continuer sur ce chemin semé d&rsquo;embûches, sans compter sur la faiblesse de cette approche.</p>
<p>Bref en relisant les articles de Khanh sur JMX, j&rsquo;ai vu quelque chose d&rsquo;intéressant <code>JMXConnectorServerFactory</code>. Cette classe permet donc de créer un <code>JMXConnectorServer</code> avec l&rsquo;URL qu&rsquo;on lui spécifie et d&rsquo;un <code>MBeanServer</code>. A noter que cette URL doit respecter un certain formalisme tel que la javadoc l&rsquo;indique : <code>service:jmx:*protocol*:*remainder*</code>.</p>
<p>Le protocole ne peut pas être n&rsquo;importe quoi, il faut qu&rsquo;il y ait le bon service enregistré pour qu&rsquo;il soit géré. Dans notre cas RMI est standard, c&rsquo;est donc le protocole que je prendrai. Pour le remainder, il s&rsquo;agit plus d&rsquo;une partie d&rsquo;une URL, je vous laisse voir la Javadoc de <code>JMXServiceUrl</code> à ce sujet, mais dans les grandes lignes la forme doit être la suivante : <code>//[host[:port]][url-path]</code></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">JMXConnectorServer connectorServer <span style="color:#000;font-weight:bold">=</span> JMXConnectorServerFactory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">newJMXConnectorServer</span><span style="color:#000;font-weight:bold">(</span>
    <span style="color:#000;font-weight:bold">new</span> JMXServiceURL<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;service:jmx:rmi://&#34;</span><span style="color:#000;font-weight:bold">),</span>
    <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span>
    mBeanServer
<span style="color:#000;font-weight:bold">);</span>

connectorServer<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">start</span><span style="color:#000;font-weight:bold">();</span>
</code></pre></div><p>Hop dans le code précédent, on a créé puis démarrer notre <code>JMXConnectorServer</code>. Il n&rsquo;y a plus qu'à se connecter dessus de manière standard :</p>
<p>Je vais utiliser <code>connectorServer.getJMXServer()</code> pour récupérer l&rsquo;URL du service, il y a une raison à cela, c&rsquo;est que comme l&rsquo;indique la javadoc, l&rsquo;URL passée pour la création du <code>JMXConnectorServer</code> peut être légèrement modifiée par celui-ci, il faut donc récupérer la nouvelle URL.<!-- raw HTML omitted --></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">JMXConnector jmxConnetor <span style="color:#000;font-weight:bold">=</span> JMXConnectorFactory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">connect</span><span style="color:#000;font-weight:bold">(</span>connectorServer<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getJMXServiceUrl</span><span style="color:#000;font-weight:bold">());</span>
MBeanServerConnection connection <span style="color:#000;font-weight:bold">=</span> jmx<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getgetMBeanServerConnection</span><span style="color:#000;font-weight:bold">();</span>
</code></pre></div><p>Et voilà vous avez accès à une <code>MBeanServerConnection</code>, qui vit dans la JVM locale, mais qui utilise RMI pour communiquer avec le <code>MBeanServer</code>, du coup vous êtes nettement plus proches des conditions du code de production et c&rsquo;est ce qui nous intéresse dans cet article.</p>
<p>Pour référence les articles de Khanh, et en français s&rsquo;il vous plait :) :</p>
<ul>
<li><a href="http://jetoile.blogspot.com/2010/10/jmx-pour-les-nuls-les-concepts-partie-1.html">Partie 1 : Les concepts</a></li>
<li><a href="http://jetoile.blogspot.com/2010/11/jmx-pour-les-nuls-les-differents-mbeans.html">Partie 2 : Les différents MBean</a></li>
<li><a href="http://jetoile.blogspot.com/2010/11/jmx-pour-les-nuls-les-agents-jmx-partie.html">Partie 3 : Les agents</a></li>
<li><a href="http://jetoile.blogspot.com/2010/11/jmx-pour-les-nuls-les-classes-de-base.html">Partie 4 : Les classes de bases</a></li>
<li><a href="http://jetoile.blogspot.com/2010/11/jmx-pour-les-nuls-le-mbean-server.html">Partie 5 : Le MBean server</a></li>
<li><a href="http://jetoile.blogspot.com/2010/12/jmx-pour-les-nuls-chargement-dynamique.html">Partie 6 : Le chargement dynamique</a></li>
<li><a href="http://jetoile.blogspot.com/2010/12/jmx-pour-les-nuls-les-services-jmx.html">Partie 7 : Les services JMX</a></li>
<li><a href="http://jetoile.blogspot.com/2010/12/jmx-pour-les-nuls-les-connecteurs.html">Partie 8 : Les connecteurs</a></li>
</ul>
<p>Quelques liens javadoc :</p>
<ul>
<li><a href="http://download.oracle.com/javase/6/docs/api/javax/management/remote/JMXConnectorFactory.html"><code>JMXConnectorFactory</code></a></li>
<li><a href="http://download.oracle.com/javase/6/docs/api/javax/management/remote/JMXConnectorServerFactory.html"><code>JMXConnectorServerFactory</code></a></li>
<li><a href="http://download.oracle.com/javase/6/docs/api/javax/management/remote/JMXServiceURL.html"><code>JMXServiceURL</code></a></li>
<li><a href="http://download.oracle.com/javase/6/docs/api/javax/management/remote/JMXConnectorServer.html"><code>JMXConnectorServer</code></a></li>
</ul>
<p>Enfin je me suis créé une petite classe de commodité qui permet de créé facilement un loopback pour les TU :</p>

  </div>
  

<div class="navigation navigation-single">
    
    <a href="/2010/11/04/sexprimer-regulierement-partie-3/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">Expressions régulières (Partie 3)</span>
    </a>
    
    
    <a href="/2011/10/18/afficher-les-properties-dun-projet-maven/" class="navigation-next">
      <span class="navigation-tittle">Afficher les properties d&#39;un projet maven</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
        
        
        
        this.page.identifier = 'https://blog.arkey.fr/2011/10/14/tester-votre-code-jmx-dans-des-conditions-pseudo-reelle/';
        this.page.title = 'Tester votre code JMX dans des conditions pseudo réelle.';
        this.page.url = 'https://blog.arkey.fr/2011/10/14/tester-votre-code-jmx-dans-des-conditions-pseudo-reelle/';
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "thecoffeeworkshop" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</article>


        </div>
        
    

<script defer src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/js/all.min.js" integrity="sha256-KzZiKy0DWYsnwMF+X1DvQngQ2/FxF7MF3Ff72XcpuPs=" crossorigin="anonymous"></script>

    
    
    <script type="text/javascript">
        
        hljs.initHighlightingOnLoad();
    </script>
    




    



    </body>
</html>
