<!DOCTYPE html>
<html lang="en">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.75.1" />

    
    
    

<title>Exploring Java native memory • Brice Dutheil</title>













    
<meta property="og:locale" content="en">
<meta property="og:site_name" content="Brice Dutheil">
<meta property="og:title" content="Exploring Java native memory">
<meta property="og:type" content="website">
<meta property="og:url" content="https://blog.arkey.fr/drafts/2020/05/23/exploring-java-native-memory/" />
<meta property="og:description" content="Java mostly, and general tech">
<meta property="og:image" content="https://blog.arkey.fr/social-sharing.png">
<meta property="og:image:type" content="image/png">
    
    
    
<meta property="og:image:width" content="192">
<meta property="og:image:height" content="192">
    

<meta property="og:updated_time" content="2020-05-23T23:45:29&#43;0200">



<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@BriceDutheil">
<meta name="twitter:title" content="Exploring Java native memory">

<meta name="twitter:image" content="https://blog.arkey.fr/social-sharing.png">

<meta name="twitter:description" content="Java mostly, and general tech">
<meta name="twitter:creator" content="@BriceDutheil">
    
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/a11y-light.min.css" media="(prefers-color-scheme: light)"><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/gruvbox-dark.min.css" media="(prefers-color-scheme: dark)">




<link rel="stylesheet" href="/scss/hyde-hyde.157ebce1a9aa8d33b32dc026b8fa65847644aab3c1cb1ff0e1c25efc7ec2491e.css" integrity="sha256-FX684amqjTOzLcAmuPplhHZEqrPByx/w4cJe/H7CSR4=">


<link rel="stylesheet" href="/scss/hyde-hyde-dark.e42accb90675eefea7f835f9f36a333b2e088d399217fcac85044e672158d585.css" integrity="sha256-5CrMuQZ17v6n&#43;DX582ozOy4IjTmSF/yshQROZyFY1YU=" media="(prefers-color-scheme: dark)">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    
    <link rel="shortcut icon" sizes="192x192" href="/android-192-favicon.png">

    
    <link rel="shortcut icon" href="/android-192-favicon.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css" integrity="sha256-h20CPZ0QyXlBuAw7A+KluUYx/3pK+c7lYEpqLTlxjYQ=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/v4-shims.min.css" integrity="sha256-wN7QJaqAwQ03kgUhyN4EU2phRdDkLrQYbFe0EvpQ60U=" crossorigin="anonymous" />

    
    


    
</head>


    <body class="draft">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://blog.arkey.fr">Brice Dutheil</a>
      </span>
      
      
        <div class="author-image">
          <img src="https://www.gravatar.com/avatar/f31c7fbcbb0766d0632d96fd7e74b649?s=240&d=mp" class="img--circle img--headshot element--center" alt="gravatar">
        </div>
      
      <p class="site__description">
         Java mostly, and general tech 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">Brice Dutheil</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/"><span class='fa-icon'><i class='fas fa-home'></i></span><code>cd <em>~</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/posts/"><span class='fa-icon'><i class='fas fa-stream'></i></span><code>ls <em>posts/*</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/series/"><span class='fa-icon'><i class='fas fa-list-alt'></i></span><code>grep -o <em>series</em> posts/* | sort -u</code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/"><span class='fa-icon'><i class='fas fa-tags'></i></span><code>grep -o <em>tags</em> posts/* | sort -u</code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/cool-stuff/"><span class='fa-icon'><i class='fas fa-thumbtack'></i></span><code>cd <em>cool-stuff</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/whoami/"><span class='fa-icon'><i class='fas fa-id-card'></i></span><code>whoami</code>
						<span></span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://twitter.com/@BriceDutheil" rel="me"><i class="fa-w-16" aria-hidden="true"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="bird" class="svg-inline--fa fa-bird fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></i></a>
	
	
	
	<a href="https://github.com/bric3" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="https://speakerdeck.com/bric3" rel="me"><i class="fab fa-speaker-deck" aria-hidden="true"></i></i></a>
	
	
	
	
	
	
	
	<a href="https://linkedin.com/in/dutheilbrice" rel="me"><i class="fa-w-16" aria-hidden="true"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="pro-network" class="svg-inline--fa fa-pro-network fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></i></a>
	
	
	<a href="https://stackoverflow.com/users/48136/brice" rel="me"><i class="fab fa-stack-overflow fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
</section>

      </div>
    </div>

  </div>
  <div class="container fixed-container">
    
<div class="copyright">
  &copy; 2010 - 2020 Brice Dutheil
  
    <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>
  
</div>



  </div>
</div>

        <div class="content container">
            
    

<article>
  <header>
    <h1>Exploring Java native memory</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> 2020-05-23
    
    
    
    
    
    <br/>
    <i class="fas fa-clock"></i> 90 min read

    
    
    

</div>


  </header>
  
  
  
  <div class="post adoc">
    <div class="admonitionblock caution">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Talk about the kubernetes scheduling aspect of setting memory request and limits.
</td>
</tr>
</tbody></table>
</div>
<div class="admonitionblock caution">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Change <em>memory zone</em> in NMT to memory by JVM components
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Like many I was happy to see the JDK landed support for containers in Java 9,
and that it was backported to Java 8 as well. Now the JDK 11 enables this
support by default. This support make the JVM read information from <code>cgroup</code>s,
also the JVM has new way to tell the runtime the memory as a percentage of the
cgroup value via the <code>-XX:MaxRAMPercentage</code> flag. After some experience with it
I found this flag is not helpful in containers, at least for the application mileage
I worked with.</p>
</div>
<div class="paragraph">
<p>So, this flag did not worked as I expected to be, and I’m a bit the culprit on this one.
When this flag appeared –- as a fraction based flags first (<code>*RAMFraction</code>) — mostly blogs
explored these options (<em>like this <a href="https://merikan.com/2019/04/jvm-in-a-container/">one</a></em>),
many thanks to authors of these blogs. However I missed the most important part
<code>MaxRamPercentage</code> is <strong>only about the Java heap</strong>, like most blog most on the topic, leaving
the bigger picture.</p>
</div>
<div class="paragraph">
<p>If I turned on blogs first it’s because the official documentation doesn’t even mention
any <code>*RAMPercentage</code> flags:</p>
</div>
<div class="ulist">
<div class="title">Oracle documentation</div>
<ul>
<li>
<p><a href="https://docs.oracle.com/en/java/javase/11/tools/java.html#GUID-3B1CE181-CD30-4178-9602-230B800D4FAE"><code>java</code> (JDK11)</a></p>
</li>
<li>
<p><a href="https://docs.oracle.com/en/java/javase/12/docs/specs/man/java.html"><code>java</code> (JDK12)</a></p>
</li>
<li>
<p><a href="https://docs.oracle.csom/apps/search/search.jsp?q=MaxRAMPercentage&amp;search-scope=book&amp;book=tools&amp;product=en%2Fjava%2Fjavase%2F11&amp;category=java">Searching Oracle’s documentation</a></p>
</li>
<li>
<p>…​</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Fortunately there’s this awesome contribution from <a href="https://twitter.com/chriswhocodes">Chris Newland</a>,
this tool indexes JDK codebase and flag’s documentations among other metadata.</p>
</div>
<div class="paragraph">



<div class="table-wrapper">
    <table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. <a href="https://chriswhocodes.com/hotspot_options_jdk11.html">VM Options Explorer - JDK11 HotSpot</a></caption>
<colgroup>
<col style="width: 9.0909%;"/>
<col style="width: 9.0909%;"/>
<col style="width: 9.0909%;"/>
<col style="width: 9.0909%;"/>
<col style="width: 9.0909%;"/>
<col style="width: 9.0909%;"/>
<col style="width: 9.0909%;"/>
<col style="width: 9.0909%;"/>
<col style="width: 9.0909%;"/>
<col style="width: 9.0909%;"/>
<col style="width: 9.091%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Since</th>
<th class="tableblock halign-left valign-top">Deprecated</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">OS</th>
<th class="tableblock halign-left valign-top">CPU</th>
<th class="tableblock halign-left valign-top">Component</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Availability</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Defined in</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MaxRAMPercentage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JDK10</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">double</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">gc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">25.0 range(0.0, 100.0)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">product</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum percentage of real memory used for maximum heap size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>share/gc/shared/gc_globals.hpp</code></p></td>
</tr>
</tbody>
</table>

</div>

</div>
<div class="paragraph">
<p>I knew this tool beforehand yet I didn’t use Chris’s website first, I should have.
Anyway. This entry is about figuring out the other memory <em>parts</em> of a Java process.
I will use as a specimen an issue that I experienced in production, the actual problem could
be solved without diving in memory, but it served as an excuse to go down the rabbit hole.</p>
</div>
<div class="paragraph">
<p>In doing so the following writing tries to piece together several elements
from a few things I knew, things I grepped in the JDK codebase, blog post, stack overflow,
and things learned from — awesome — people.</p>
</div>
<div class="paragraph">
<p>If I ignored something or if I’m wrong please reach out.</p>
</div>
<hr/>
<div class="paragraph">
<p>To put things in context the application is running within a Kubernetes cluster
and experienced memory problems after increasing HTTP traffic.</p>
</div>
<div class="paragraph">
<p>This application is deployed as a <a href="https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/"><em>replicaset</em></a>,
this means that Kubernetes make sure there’s always the right number of application
instances, or <em>replicas</em> using the Kubernetes terminology.
Also this deployment is using an <a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/"><em>horizontal pod auto-scaler</em></a>
whose role is to increase the number of instances based on some criteria, this application
used the CPU usage.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Problem</div>
<div class="paragraph">
<p>The application was running with <code>-XX:MaxRAMPercentage=85</code> in a container constrained
to <code>3 GiB</code> of memory and hit the memory limit. Naturally the application got killed by the
OS. And more dramatically all replicas eventually got <em>oomkilled</em> after some time, which led
Kubernetes to always deploy new pods.</p>
</div>
<div class="paragraph">
<p>This application worked very well on a different datacenter handling all the traffic with
a heap of <code>2 GiB</code>. The instances in Kubernetes could handle half of the traffic well but not
the entire traffic.</p>
</div>
<div class="paragraph">
<p>In short when the traffic on kubernetes instances was increased to 100%
the <em>pod</em>s started to get <em>oom killed</em>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p><span class="image"><img src="../../static/assets/maxrampercentage/app-jvm-memory-usage.png" alt="JVM memory usage"/></span></p>
</div>
<div class="paragraph">
<p>On the graph above we can see the trend of the <strong>R</strong>esident <strong>S</strong>et <strong>S</strong>ize in green,
the Java heap limit (85% of <code>3 GiB</code>), and in yellow the current heap usage.</p>
</div>
<div class="paragraph">
<p>Note that this graph has a slight issue as it displays data in <em>metric bytes</em>
while in reality this should be IEC bytes. Talking about this :</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Most of the time, figures will use the <a href="https://en.wikipedia.org/wiki/Binary_prefix">IEC binary notation</a> (<code>1 KiB = 1024 B</code>),
it matches the <a href="https://github.com/corretto/corretto-11/blob/055a9a1a279b9a2953c2150bc937b04f905eeba1/src/src/hotspot/share/utilities/globalDefinitions.hpp#L226">JVM</a>,
our <a href="https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#meaning-of-memory">Kubernetes</a> usage,
and Linux’s tools (<code>/proc/{pid}/stat</code> or <code>/proc/{pid}/maps</code> ; although I couldn’t find a reference stating this).</p>
</div>
<div class="paragraph">
<p>Some charts may however use the <a href="https://en.wikipedia.org/wiki/Binary_prefix">SI metric notation</a> (<code>1 KB = 1000 B</code>).</p>
</div>
<div class="quoteblock">
<blockquote>
Actually, 227,893 KB is only 222 MB. For ease of discussion, I’ll truncate the KBs part by 1,000
in this chapter; pretend I’m a disk manufacturer.
</blockquote>
<div class="attribution">
— Java Performance: The Definitive Guide<br/>
<cite>Getting the Most Out of Your Code (1st Edition)</cite>
</div>
</div>
<div class="paragraph">
<p><em>Thanks to this <a href="https://twitter.com/fleming_matt/status/1282729134481965064?s=21">tweet</a>.</em></p>
</div>
</td>
</tr>
</tbody></table>
</div>
<details>
<summary class="title">Fixing the issue without understanding</summary>
<div class="content">
<div class="paragraph">
<p>The application that became problematic runs on a Kubernetes cluster. As mentioned above
this application worked fine before, and the people who handled the issue at that time were
not well-prepared, and I certainly wouldn’t be prepared much better, that means memory
limits until it worked. <code>5 GiB</code> proved to be the lucky number.
It was the right approach at this moment in this context as it quickly resolved production
issues.</p>
</div>
<div class="listingblock">
<div class="title">memory limits in the deployment object of the app</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: java-app
spec:
  template:
    spec:
      containers:
      - name: java-app
        resources:
          limits:
            cpu: &#34;8&#34;
            memory: 5Gi <i class="conum" data-value="1"></i><b>(1)</b>
          requests:
            cpu: &#34;3&#34;
            memory: 3Gi</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The working memory limit.</td>
</tr>
</tbody></table>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The resources tree is equivalent to this docker params</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">docker run \
  --cpu-shares=3 \ <i class="conum" data-value="1"></i><b>(1)</b>
  --cpu-quota=8 \ <i class="conum" data-value="2"></i><b>(2)</b>
  --memory=5g \ <i class="conum" data-value="3"></i><b>(3)</b>
  ...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>cpu request, this is the relative weight of that container for CPU time</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>cpu limit, this limits the CPU time of container’s processes, that means throttling</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>memory limit, tells the OS to kill (<code>oomkill</code>) the container’s processes if they hit this limit</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The memory request is only used for scheduling the pod on a node.</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>However, while increasing memory limit work this is not satisfactory because :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>This number comes from trial and error.</p>
</li>
<li>
<p>This application worked with a <code>2 GiB</code> heap, <code>5 GiB</code> looks greedy.</p>
</li>
<li>
<p>Why this his number work is not understood.</p>
</li>
</ol>
</div>
</div>
</details>
<div class="paragraph">
<p><em>Now let’s answer this question: What is consuming the memory ?</em></p>
</div>
<div class="sect1">
<h2 id="_diagnosis"><a class="anchor" href="#_diagnosis"></a><a class="link" href="#_diagnosis">Diagnosis</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_the_jvm_options"><a class="anchor" href="#_the_jvm_options"></a><a class="link" href="#_the_jvm_options">The JVM options</a></h3>
<div class="paragraph">
<p>When assessing java memory one of the fist thing to look at are the Java heap parameters.</p>
</div>
<div class="paragraph">
<p>It’s likely anyone that reads this article is familiar with <code>Xms</code> or <code>Xmx</code>, but there are
other ways to define the boundaries of the Java heap in particular if the process is started
with <code>\*RAMPercentage</code>. With those the JVM will compute the actual values from the <code>cgroup</code>,
in this case it’s possible to access the actual runtime values with <code>jcmd</code>.</p>
</div>
<div class="paragraph">
<p>For example with a memory limit of <code>5 GiB</code>, if a process is started with
<code>-XX:InitialRAMPercentage=85.0 -XX:MaxRAMPercentage=85.0</code> the <code>VM.flags</code>
diagnostic command will output this :</p>
</div>
<div class="listingblock">
<div class="title"><code>VM.flags</code> in k8s</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ jcmd $(pidof java) VM.flags | tr &#39; &#39; &#39;\n&#39;
6:
...
-XX:InitialHeapSize=4563402752 <i class="conum" data-value="3"></i><b>(3)</b>
-XX:InitialRAMPercentage=85.000000 <i class="conum" data-value="1"></i><b>(1)</b>
-XX:MarkStackSize=4194304
-XX:MaxHeapSize=4563402752 <i class="conum" data-value="4"></i><b>(4)</b>
-XX:MaxNewSize=2736783360
-XX:MaxRAMPercentage=85.000000 <i class="conum" data-value="2"></i><b>(2)</b>
-XX:MinHeapDeltaBytes=2097152
-XX:NativeMemoryTracking=summary
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Initial RAM at 85%</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Max RAM at 85%</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Initial heap size ~<code>4.25 GiB</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Max heap size ~<code>4.25 GiB</code></td>
</tr>
</tbody></table>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Do not confuse the <code>VM.flags</code> command which will output parameters calculated <strong>from</strong> the
<em>command line</em> and <code>VM.command_line</code> which will print the <strong>raw</strong> <em>command line</em>.
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The other Hotspot flag values comes are JVM defaults (which may either be static values,
or computed from internal heuristics).</p>
</div>
<div class="paragraph">
<p>The Java heap is only a part of the process memory usage. I intend
to explain how memory is <em>concumed</em> in the rest of this article, in the context
of an application running inside a container.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_real_memory_footprint_of_the_java_process_in_the_container"><a class="anchor" href="#_the_real_memory_footprint_of_the_java_process_in_the_container"></a><a class="link" href="#_the_real_memory_footprint_of_the_java_process_in_the_container">The real memory footprint of the java process in the container</a></h3>
<div class="paragraph">
<p>In the Java dream us developers shouldn’t care much about the memory or the OS
and if we did we should only look a the Java Heap usage.</p>
</div>
<div class="paragraph">
<p>This dream more or less lasted a long time until Java applications were put
in containers.</p>
</div>
<div class="paragraph">
<p>Indeed of the most the most critical thing to look at, in a containers in particlar,
is the <em>resident set size</em>, it can be obtained in various ways, using <code>ps</code>, <code>top</code> or
reading the <code>/proc</code> filesystem. E.g. on the same than above</p>
</div>
<div class="listingblock primary">
<div class="title"><code>ps</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ ps o pid,rss -p $(pidof java)
PID   RSS
  6 4701120</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title"><code>/proc/{pid}/status</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ cat /proc/$(pgrep java)/status | grep VmRSS
VmRSS:	 4701120 kB</code></pre>
</div>
</div>
<div class="paragraph">
<p>The RSS is <code>4.6 GiB</code>, and it’s Java heap size is <code>4.25 GiB</code>, indicating
this process uses around <code>0.35 GiB</code> of non Java heap memory, I’ll refer
to this memory as <em>native memory</em>.</p>
</div>
<div class="paragraph">
<p>Now I’d like to dig a bit to understand the reported number <code>4701120 KiB</code>,
what it actually measures.</p>
</div>
<div class="sect3">
<h4 id="_the_java_memory_zones"><a class="anchor" href="#_the_java_memory_zones"></a><a class="link" href="#_the_java_memory_zones">The java memory zones</a></h4>
<div class="paragraph">
<p>In order to understand how the Java process memory is consumed, we need to use
<em>Native Memory Tracking</em> (<code>-XX:NativeMemoryTracking=summary</code>) which produces
an overview of the memory usage by components of the JVM. It actually gives
a pretty good picture of the &#34;cost&#34; of the JVM.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Enabling <em>detailed</em> native memory tracking (NMT) causes a 5% to 10%
performance overhead. The <em>summary</em> mode merely has an impact in memory usage
as shown below.
</td>
</tr>
</tbody></table>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is necessary to note that while the above command indicate a scale
in <code>KB</code> for the JVM it really means <code>KiB</code>.
</td>
</tr>
</tbody></table>
</div>
<div class="listingblock">
<div class="title"><code>VM.native_memory</code> instant snapshot</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ jcmd $(pidof java) VM.native_memory
6:

Native Memory Tracking:

Total: reserved=7168324KB, committed=5380868KB                               <i class="conum" data-value="1"></i><b>(1)</b>
-                 Java Heap (reserved=4456448KB, committed=4456448KB)        <i class="conum" data-value="2"></i><b>(2)</b>
                            (mmap: reserved=4456448KB, committed=4456448KB)

-                     Class (reserved=1195628KB, committed=165788KB)         <i class="conum" data-value="3"></i><b>(3)</b>
                            (classes #28431)                                 <i class="conum" data-value="4"></i><b>(4)</b>
                            (  instance classes #26792, array classes #1639)
                            (malloc=5740KB #87822)
                            (mmap: reserved=1189888KB, committed=160048KB)
                            (  Metadata:   )
                            (    reserved=141312KB, committed=139876KB)
                            (    used=135945KB)
                            (    free=3931KB)
                            (    waste=0KB =0.00%)
                            (  Class space:)
                            (    reserved=1048576KB, committed=20172KB)
                            (    used=17864KB)
                            (    free=2308KB)
                            (    waste=0KB =0.00%)

-                    Thread (reserved=696395KB, committed=85455KB)
                            (thread #674)
                            (stack: reserved=692812KB, committed=81872KB)    <i class="conum" data-value="5"></i><b>(5)</b>
                            (malloc=2432KB #4046)
                            (arena=1150KB #1347)

-                      Code (reserved=251877KB, committed=105201KB)          <i class="conum" data-value="6"></i><b>(6)</b>
                            (malloc=4189KB #11718)
                            (mmap: reserved=247688KB, committed=101012KB)

-                        GC (reserved=230739KB, committed=230739KB)          <i class="conum" data-value="7"></i><b>(7)</b>
                            (malloc=32031KB #63631)
                            (mmap: reserved=198708KB, committed=198708KB)

-                  Compiler (reserved=5914KB, committed=5914KB)              <i class="conum" data-value="8"></i><b>(8)</b>
                            (malloc=6143KB #3281)
                            (arena=180KB #5)

-                  Internal (reserved=24460KB, committed=24460KB)           <i class="conum" data-value="10"></i><b>(10)</b>
                            (malloc=24460KB #13140)

-                     Other (reserved=267034KB, committed=267034KB)         <i class="conum" data-value="11"></i><b>(11)</b>
                            (malloc=267034KB #631)

-                    Symbol (reserved=28915KB, committed=28915KB)            <i class="conum" data-value="9"></i><b>(9)</b>
                            (malloc=25423KB #330973)
                            (arena=3492KB #1)

-    Native Memory Tracking (reserved=8433KB, committed=8433KB)
                            (malloc=117KB #1498)
                            (tracking overhead=8316KB)

-               Arena Chunk (reserved=217KB, committed=217KB)
                            (malloc=217KB)

-                   Logging (reserved=7KB, committed=7KB)
                            (malloc=7KB #266)

-                 Arguments (reserved=19KB, committed=19KB)
                            (malloc=19KB #521)

-                    Module (reserved=1362KB, committed=1362KB)
                            (malloc=1362KB #6320)

-              Synchronizer (reserved=837KB, committed=837KB)
                            (malloc=837KB #6877)

-                 Safepoint (reserved=8KB, committed=8KB)
                            (mmap: reserved=8KB, committed=8KB)

-                   Unknown (reserved=32KB, committed=32KB)
                            (mmap: reserved=32KB, committed=32KB)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This shows a <code>reserved</code> value (<code>7168324 KiB</code> (~<code>6.84 GiB</code>)), it’s the amount
of addressable memory on that container, and a <code>committed</code> value (<code>4456448 KiB</code> (~<code>4.25 GiB</code>))
that represents what the JVM actually asked the OS to allocate.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>Heap</code> zone, note that reserved and committed values are the same <code>4456448 KiB</code>
here because our <code>InitialRAMPercentage</code> is the same as max. I’m not sure why this number
is different from the VM flags <code>-XX:MaxHeapSize=4563402752</code> though.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>~<code>162 MiB</code> of metaspace.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>How many classes have been loaded : <code>28431</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>There are 674 threads whose stacks are using ~<code>80 MiB</code> at this time.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td><code>Code</code> cache area (assembly of the used methods) ~<code>102 MiB</code> out of ~<code>246 MiB</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>This section contains <code>GC</code> algorithms internal data structures, this is app
is using G1GC which takes ~<code>225 MiB</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>C1 / C2 compilers (which compile bytecode to assembly) use ~<code>5.8 MiB</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>The <code>Symbol</code> section contains many things like interned strings and other
internal constants for about <code>28.2 MiB</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>The <code>Internal</code> area takes ~<code>24 MiB</code>. Before Java 11 this area included
<code>DirectByteBuffers</code>, but from Java 11 those are accounted in the <code>Other</code> zone.</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>The <code>Other</code> section after Java 11 includes <code>DirectByteBuffers</code> ~<code>261 MiB</code>.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>All possible memory types are defined there in
<a href="https://github.com/corretto/corretto-11/blob/caa2f4cad666b508a88b92db01054ace8647a820/src/src/hotspot/share/memory/allocation.hpp#L114-L141">this enumeration</a>,
and <a href="https://github.com/corretto/corretto-11/blob/2b351313740f148597cf680d8443df93931de813/src/src/hotspot/share/services/nmtCommon.cpp#L28-L51">here</a>
as they appear in the report.</p>
</div>
<div class="paragraph">
<p>The remaining areas are much smaller in scale, NMT takes ~<code>8.2 MiB</code> itself, module system usage ~<code>1.3 MiB</code>,
etc. Also, note that enabling other JVM features may show up if they are activated, like flight recorder.
<a href="https://docs.oracle.com/en/java/javase/11/troubleshoot/diagnostic-tools.html#GUID-5EF7BB07-C903-4EBD-A9C2-EC0E44048D37">Source</a></p>
</div>
<div class="paragraph">
<p>There’s a lot more to read on the
<a href="https://docs.oracle.com/en/java/javase/11/vm/native-memory-tracking.html#GUID-39676837-DA61-4F8D-9C5B-9DB1F5147D80">official documentation about NMT</a>
and <a href="https://docs.oracle.com/en/java/javase/11/troubleshoot/diagnostic-tools.html#GUID-1F53A50E-86FF-491D-A023-8EC4F1D1AC77">how to Monitor VM Internal Memory</a>.</p>
</div>
<div class="paragraph">
<p>Yet another worthwhile read on <a href="https://shipilev.net/jvm/anatomy-quarks/12-native-memory-tracking/">native memory tracking</a>
by <a href="http://twitter.com/shipilev">Aleksey Shipilёv</a>.</p>
</div>
<div class="paragraph">
<p>NMT is a great tool to gain an insight on the memory usage of the various
parts that compose the Java runtime. But it doesn’t answer well
what is actually accounted by the number reported in <code>ps</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_lets_pause_a_bit_and_revise_memory_management"><a class="anchor" href="#_lets_pause_a_bit_and_revise_memory_management"></a><a class="link" href="#_lets_pause_a_bit_and_revise_memory_management">Let’s pause a bit and revise memory management</a></h4>
<div class="paragraph">
<p>I mentioned this acronym already, <em>RSS</em> or <strong>R</strong>esident <strong>S</strong>et <strong>S</strong>ize, what is it?
What exactly means <em>committed</em> memory or <em>reserved</em> memory shown in NMT ? How do they
relate to each other?</p>
</div>
<div class="paragraph">
<p>First let’s break down the vocabulary when we talk about memory.</p>
</div>
<div class="imageblock">
<div class="content">
<svg xmlns="http://www.w3.org/2000/svg" version="1.0" shape-rendering="geometricPrecision" preserveAspectRatio="xMidYMid meet" viewBox="0 0 650.0 224.0" width="650px" height="224px">
  <defs>
    <style type="text/css">
      @font-face { font-family: sans-serif; }
    </style>
    <filter id="shadowBlur" x="0" y="0" width="200%" height="200%">
      <feOffset in="SourceGraphic" dx="3.0003002" dy="3.0003002" result="offOut"></feOffset>
      <feGaussianBlur in="offOut" stdDeviation="3"></feGaussianBlur>
    </filter>
  </defs>
  <g stroke-width="1" stroke-linecap="square" stroke-linejoin="round">
    <rect x="0" y="0" width="650" height="224" style="fill: #ffffff"></rect>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M25.0 133.0 L25.0 105.0 L625.0 105.0 L625.0 133.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M25.0 133.0 L25.0 105.0 L625.0 105.0 L625.0 133.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M40.0 42.0 L30.0 49.0 L40.0 56.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M610.0 42.0 L620.0 49.0 L610.0 56.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M40.0 56.0 L30.0 63.0 L40.0 70.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M480.0 56.0 L490.0 63.0 L480.0 70.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M40.0 70.0 L30.0 77.0 L40.0 84.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M360.0 70.0 L370.0 77.0 L360.0 84.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M40.0 154.0 L30.0 161.0 L40.0 168.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M610.0 154.0 L620.0 161.0 L610.0 168.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M615.0 49.0 L205.0 49.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M215.0 63.0 L485.0 63.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M365.0 77.0 L225.0 77.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M615.0 161.0 L265.0 161.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M55.0 49.0 L35.0 49.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M35.0 63.0 L55.0 63.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M55.0 77.0 L35.0 77.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M55.0 161.0 L35.0 161.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M495.0 63.0 L495.0 105.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M375.0 77.0 L375.0 105.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M625.0 49.0 L625.0 105.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M625.0 133.0 L625.0 175.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M25.0 49.0 L25.0 105.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M25.0 133.0 L25.0 175.0 "></path>
    <text x="63" y="124" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      addressable space of the process
    </text>
    <text x="71" y="166" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      contiguous addresses
    </text>
    <text x="60" y="54" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      virtual memory
    </text>
    <text x="60" y="68" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      reserved memory
    </text>
    <text x="60" y="82" font-family="sans-serif" font-size="14" stroke="none" fill="#000000">
      committed memory
    </text>
    <text x="541" y="194" font-family="sans-serif" font-size="14" stroke="none" fill="#000000">
      0x8000000
    </text>
    <text x="23" y="194" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      0 
    </text>
  </g>
</svg>
</div>
<div class="title">memory zones</div>
</div>
<table class="tableblock frame-all grid-all fit-content stretch">
<caption class="title">Table 1. vocabulary breakdown (<a href="https://stackoverflow.com/a/31178912/48136">source</a>)</caption>
<colgroup>
<col/>
<col/>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Committed</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Address ranges that have been mapped or <code>malloc</code>ed.
They may or may not be backed by physical or swap due to lazy allocation and paging.
This applies to the JVM and the OS.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Reserved</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The total address range that has been pre-mapped via <code>mmap</code> or <code>malloc</code>
for a particular memory pool. In other words <em>reserved memory</em> represents the maximum
addressable memory.
Those could be referred to as <strong>uncommitted</strong>.
This applies to the JVM and the OS.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Resident</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OS memory pages which are currently in physical ram. This means codes,
stacks, part of the committed memory pools but also portions of <code>mmap</code>ed files
which have recently been accessed and allocations outside the control of the JVM.
This only relate to the OS.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Virtual</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The sum of all virtual address mappings. Covers committed, reserved
memory pools but also mapped files or shared memory. This number is rarely informative
since the JVM will reserve large address ranges upfront. We can see this number
as the pessimistic memory usage.
This only relate to the OS.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The graph above does not yet show resident memory. Indeed, the above graph most display
the <em>layout</em> of the address space of a process. In order explain resident memory
it’s necessary to revise how Linux (and other OSes by the way) manage memory
using the concept of <strong>paging</strong>.</p>
</div>
<div class="paragraph">
<p>The virtual address space is divided into smaller chunks called <em>pages</em>. While I only
saw pages of <code>4 KiB</code> other sizes exist and may even co-exist (e.g. having pages of
4 KiB mixed with 2 MiB pages), it all depends on the processor architecture.
That’s something that is out of scope for this article. What is interesting is
how paging and RSS relate to each other.</p>
</div>
<div class="imageblock">
<div class="content">
<svg xmlns="http://www.w3.org/2000/svg" version="1.0" shape-rendering="geometricPrecision" preserveAspectRatio="xMidYMid meet" viewBox="0 0 660.0 532.0" width="660px" height="532px">
  <defs>
    <style type="text/css">
      @font-face { font-family: sans-serif; }
    </style>
    <filter id="shadowBlur" x="0" y="0" width="200%" height="200%">
      <feOffset in="SourceGraphic" dx="3.0003002" dy="3.0003002" result="offOut"></feOffset>
      <feGaussianBlur in="offOut" stdDeviation="3"></feGaussianBlur>
    </filter>
  </defs>
  <g stroke-width="1" stroke-linecap="square" stroke-linejoin="round">
    <rect x="0" y="0" width="660" height="532" style="fill: #ffffff"></rect>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M525.0 455.0 L525.0 483.0 L445.0 483.0 L445.0 455.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M343.0 273.0 L343.0 299.0 L257.0 299.0 L257.0 273.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M343.0 303.0 L343.0 329.0 L257.0 329.0 L257.0 303.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M467.0 273.0 L467.0 299.0 L545.0 299.0 L545.0 280.0 Q545.0 273.0 540.0 273.0 L467.0 273.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M467.0 303.0 L467.0 329.0 L540.0 329.0 Q545.0 329.0 545.0 322.0 L545.0 303.0 L545.0 303.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M403.0 273.0 L403.0 299.0 L347.0 299.0 L347.0 273.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M463.0 273.0 L463.0 299.0 L407.0 299.0 L407.0 273.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M403.0 303.0 L403.0 329.0 L347.0 329.0 L347.0 303.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M463.0 303.0 L463.0 329.0 L407.0 329.0 L407.0 303.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M173.0 273.0 L173.0 299.0 L127.0 299.0 L127.0 273.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M173.0 303.0 L173.0 329.0 L127.0 329.0 L127.0 303.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M57.0 299.0 L57.0 273.0 L93.0 273.0 L93.0 299.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M177.0 273.0 L177.0 299.0 L213.0 299.0 L213.0 273.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M217.0 299.0 L217.0 273.0 L253.0 273.0 L253.0 299.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M57.0 303.0 L57.0 329.0 L93.0 329.0 L93.0 303.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M213.0 303.0 L213.0 329.0 L177.0 329.0 L177.0 303.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M217.0 303.0 L217.0 329.0 L253.0 329.0 L253.0 303.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M30.0 273.0 Q25.0 273.0 25.0 280.0 L25.0 299.0 L53.0 299.0 L53.0 273.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M53.0 303.0 L53.0 329.0 L30.0 329.0 Q25.0 329.0 25.0 322.0 L25.0 303.0 L25.0 303.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M123.0 273.0 L123.0 299.0 L97.0 299.0 L97.0 273.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M123.0 303.0 L123.0 329.0 L97.0 329.0 L97.0 303.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M25.0 49.0 L25.0 77.0 L45.0 77.0 L45.0 49.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M43.0 161.0 L43.0 189.0 L25.0 189.0 L25.0 161.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M607.0 189.0 L625.0 189.0 L625.0 161.0 L607.0 161.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M103.0 161.0 L103.0 189.0 L87.0 189.0 L87.0 161.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M127.0 189.0 L143.0 189.0 L143.0 161.0 L127.0 161.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M163.0 161.0 L163.0 189.0 L147.0 189.0 L147.0 161.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M183.0 161.0 L183.0 189.0 L167.0 189.0 L167.0 161.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M287.0 189.0 L303.0 189.0 L303.0 161.0 L287.0 161.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M563.0 161.0 L563.0 189.0 L547.0 189.0 L547.0 161.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M55.0 427.0 L55.0 439.0 L45.0 439.0 L45.0 427.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M55.0 471.0 L55.0 483.0 L45.0 483.0 L45.0 471.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M85.0 427.0 L85.0 439.0 L75.0 439.0 L75.0 427.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M85.0 471.0 L85.0 483.0 L75.0 483.0 L75.0 471.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M115.0 427.0 L115.0 439.0 L105.0 439.0 L105.0 427.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M115.0 471.0 L115.0 483.0 L105.0 483.0 L105.0 471.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M145.0 427.0 L145.0 439.0 L135.0 439.0 L135.0 427.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M145.0 471.0 L145.0 483.0 L135.0 483.0 L135.0 471.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M175.0 427.0 L175.0 439.0 L165.0 439.0 L165.0 427.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M175.0 471.0 L175.0 483.0 L165.0 483.0 L165.0 471.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M55.0 443.0 L55.0 453.0 L45.0 453.0 L45.0 443.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M55.0 457.0 L55.0 467.0 L45.0 467.0 L45.0 457.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M85.0 443.0 L85.0 453.0 L75.0 453.0 L75.0 443.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M85.0 457.0 L85.0 467.0 L75.0 467.0 L75.0 457.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M115.0 443.0 L115.0 453.0 L105.0 453.0 L105.0 443.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M115.0 457.0 L115.0 467.0 L105.0 467.0 L105.0 457.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M145.0 443.0 L145.0 453.0 L135.0 453.0 L135.0 443.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M145.0 457.0 L145.0 467.0 L135.0 467.0 L135.0 457.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M165.0 453.0 L165.0 443.0 L175.0 443.0 L175.0 453.0 z"></path>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M165.0 457.0 L165.0 467.0 L175.0 467.0 L175.0 457.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M175.0 399.0 L195.0 399.0 L195.0 497.0 L25.0 497.0 L25.0 399.0 L35.0 399.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M435.0 469.0 L435.0 497.0 L585.0 497.0 L585.0 399.0 L505.0 399.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M435.0 469.0 L290.0 469.0 Q285.0 469.0 285.0 462.0 L285.0 385.0 L285.0 385.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M175.0 371.0 L360.0 371.0 Q365.0 371.0 365.0 364.0 L365.0 343.0 L365.0 343.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M525.0 455.0 L525.0 483.0 L445.0 483.0 L445.0 455.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M343.0 273.0 L343.0 299.0 L257.0 299.0 L257.0 273.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M343.0 303.0 L343.0 329.0 L257.0 329.0 L257.0 303.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M467.0 273.0 L467.0 299.0 L545.0 299.0 L545.0 280.0 Q545.0 273.0 540.0 273.0 L467.0 273.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M467.0 303.0 L467.0 329.0 L540.0 329.0 Q545.0 329.0 545.0 322.0 L545.0 303.0 L545.0 303.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M435.0 469.0 L435.0 399.0 L485.0 399.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M403.0 273.0 L403.0 299.0 L347.0 299.0 L347.0 273.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M463.0 273.0 L463.0 299.0 L407.0 299.0 L407.0 273.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M403.0 303.0 L403.0 329.0 L347.0 329.0 L347.0 303.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M463.0 303.0 L463.0 329.0 L407.0 329.0 L407.0 303.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M173.0 273.0 L173.0 299.0 L127.0 299.0 L127.0 273.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M173.0 303.0 L173.0 329.0 L127.0 329.0 L127.0 303.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M57.0 299.0 L57.0 273.0 L93.0 273.0 L93.0 299.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M177.0 273.0 L177.0 299.0 L213.0 299.0 L213.0 273.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M217.0 299.0 L217.0 273.0 L253.0 273.0 L253.0 299.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M57.0 303.0 L57.0 329.0 L93.0 329.0 L93.0 303.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M213.0 303.0 L213.0 329.0 L177.0 329.0 L177.0 303.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M217.0 303.0 L217.0 329.0 L253.0 329.0 L253.0 303.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M495.0 259.0 L495.0 224.0 Q495.0 217.0 500.0 217.0 L550.0 217.0 L550.0 217.0 Q555.0 217.0 555.0 210.0 L555.0 203.0 L555.0 203.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M115.0 413.0 L115.0 378.0 Q115.0 371.0 120.0 371.0 L155.0 371.0 L155.0 371.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M295.0 203.0 L295.0 210.0 Q295.0 217.0 300.0 217.0 L350.0 217.0 L350.0 217.0 Q355.0 217.0 355.0 224.0 L355.0 259.0 L355.0 259.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M30.0 273.0 Q25.0 273.0 25.0 280.0 L25.0 299.0 L53.0 299.0 L53.0 273.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M53.0 303.0 L53.0 329.0 L30.0 329.0 Q25.0 329.0 25.0 322.0 L25.0 303.0 L25.0 303.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M135.0 203.0 L135.0 210.0 Q135.0 217.0 140.0 217.0 L180.0 217.0 L180.0 217.0 Q185.0 217.0 185.0 224.0 L185.0 259.0 L185.0 259.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M123.0 273.0 L123.0 299.0 L97.0 299.0 L97.0 273.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M123.0 303.0 L123.0 329.0 L97.0 329.0 L97.0 303.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M25.0 49.0 L25.0 77.0 L45.0 77.0 L45.0 49.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M205.0 77.0 L225.0 77.0 L225.0 49.0 L205.0 49.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M43.0 161.0 L43.0 189.0 L25.0 189.0 L25.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M607.0 189.0 L625.0 189.0 L625.0 161.0 L607.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M63.0 161.0 L63.0 189.0 L47.0 189.0 L47.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M83.0 161.0 L83.0 189.0 L67.0 189.0 L67.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M103.0 161.0 L103.0 189.0 L87.0 189.0 L87.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M107.0 161.0 L107.0 189.0 L123.0 189.0 L123.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M127.0 189.0 L143.0 189.0 L143.0 161.0 L127.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M163.0 161.0 L163.0 189.0 L147.0 189.0 L147.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M183.0 161.0 L183.0 189.0 L167.0 189.0 L167.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M203.0 161.0 L203.0 189.0 L187.0 189.0 L187.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M223.0 161.0 L223.0 189.0 L207.0 189.0 L207.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M243.0 161.0 L243.0 189.0 L227.0 189.0 L227.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M263.0 161.0 L263.0 189.0 L247.0 189.0 L247.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M267.0 161.0 L267.0 189.0 L283.0 189.0 L283.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M287.0 189.0 L303.0 189.0 L303.0 161.0 L287.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M323.0 161.0 L323.0 189.0 L307.0 189.0 L307.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M343.0 161.0 L343.0 189.0 L327.0 189.0 L327.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M363.0 161.0 L363.0 189.0 L347.0 189.0 L347.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M383.0 161.0 L383.0 189.0 L367.0 189.0 L367.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M403.0 161.0 L403.0 189.0 L387.0 189.0 L387.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M423.0 161.0 L423.0 189.0 L407.0 189.0 L407.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M427.0 161.0 L427.0 189.0 L443.0 189.0 L443.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M447.0 189.0 L463.0 189.0 L463.0 161.0 L447.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M483.0 161.0 L483.0 189.0 L467.0 189.0 L467.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M503.0 161.0 L503.0 189.0 L487.0 189.0 L487.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M523.0 161.0 L523.0 189.0 L507.0 189.0 L507.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M543.0 161.0 L543.0 189.0 L527.0 189.0 L527.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M563.0 161.0 L563.0 189.0 L547.0 189.0 L547.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M583.0 161.0 L583.0 189.0 L567.0 189.0 L567.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M587.0 161.0 L587.0 189.0 L603.0 189.0 L603.0 161.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M185.0 343.0 L185.0 350.0 Q185.0 357.0 180.0 357.0 L170.0 357.0 L170.0 357.0 Q165.0 357.0 165.0 364.0 L165.0 413.0 L165.0 413.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M255.0 203.0 L255.0 210.0 Q255.0 217.0 250.0 217.0 L230.0 217.0 L230.0 217.0 Q225.0 217.0 225.0 224.0 L225.0 259.0 L225.0 259.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M55.0 203.0 L55.0 210.0 Q55.0 217.0 60.0 217.0 L60.0 217.0 L60.0 217.0 Q65.0 217.0 65.0 224.0 L65.0 259.0 L65.0 259.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M95.0 203.0 L95.0 210.0 Q95.0 217.0 100.0 217.0 L100.0 217.0 L100.0 217.0 Q105.0 217.0 105.0 224.0 L105.0 259.0 L105.0 259.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M55.0 427.0 L55.0 439.0 L45.0 439.0 L45.0 427.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M55.0 471.0 L55.0 483.0 L45.0 483.0 L45.0 471.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M85.0 427.0 L85.0 439.0 L75.0 439.0 L75.0 427.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M85.0 471.0 L85.0 483.0 L75.0 483.0 L75.0 471.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M115.0 427.0 L115.0 439.0 L105.0 439.0 L105.0 427.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M115.0 471.0 L115.0 483.0 L105.0 483.0 L105.0 471.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M145.0 427.0 L145.0 439.0 L135.0 439.0 L135.0 427.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M145.0 471.0 L145.0 483.0 L135.0 483.0 L135.0 471.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M175.0 427.0 L175.0 439.0 L165.0 439.0 L165.0 427.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M175.0 471.0 L175.0 483.0 L165.0 483.0 L165.0 471.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M55.0 443.0 L55.0 453.0 L45.0 453.0 L45.0 443.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M55.0 457.0 L55.0 467.0 L45.0 467.0 L45.0 457.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M85.0 443.0 L85.0 453.0 L75.0 453.0 L75.0 443.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M85.0 457.0 L85.0 467.0 L75.0 467.0 L75.0 457.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M115.0 443.0 L115.0 453.0 L105.0 453.0 L105.0 443.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M115.0 457.0 L115.0 467.0 L105.0 467.0 L105.0 457.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M145.0 443.0 L145.0 453.0 L135.0 453.0 L135.0 443.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M145.0 457.0 L145.0 467.0 L135.0 467.0 L135.0 457.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M165.0 453.0 L165.0 443.0 L175.0 443.0 L175.0 453.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M165.0 457.0 L165.0 467.0 L175.0 467.0 L175.0 457.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M40.0 98.0 L30.0 105.0 L40.0 112.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M610.0 98.0 L620.0 105.0 L610.0 112.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M40.0 112.0 L30.0 119.0 L40.0 126.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M510.0 112.0 L520.0 119.0 L510.0 126.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M40.0 126.0 L30.0 133.0 L40.0 140.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M370.0 126.0 L380.0 133.0 L370.0 140.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M30.0 252.0 L35.0 266.0 L40.0 252.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M60.0 252.0 L65.0 266.0 L70.0 252.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M100.0 252.0 L105.0 266.0 L110.0 252.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M180.0 252.0 L185.0 266.0 L190.0 252.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M220.0 252.0 L225.0 266.0 L230.0 252.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M350.0 252.0 L355.0 266.0 L360.0 252.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M490.0 252.0 L495.0 266.0 L500.0 252.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M520.0 252.0 L525.0 266.0 L530.0 252.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M40.0 406.0 L45.0 420.0 L50.0 406.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M110.0 406.0 L115.0 420.0 L120.0 406.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M160.0 406.0 L165.0 420.0 L170.0 406.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M490.0 434.0 L495.0 448.0 L500.0 434.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M430.0 462.0 L440.0 469.0 L430.0 476.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M615.0 105.0 L205.0 105.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M215.0 119.0 L515.0 119.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M35.0 203.0 L35.0 259.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M55.0 105.0 L35.0 105.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M55.0 119.0 L35.0 119.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M55.0 133.0 L35.0 133.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M45.0 343.0 L45.0 413.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M105.0 399.0 L55.0 399.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M495.0 343.0 L495.0 441.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M615.0 203.0 L615.0 224.0 Q615.0 231.0 610.0 231.0 L530.0 231.0 L530.0 231.0 Q525.0 231.0 525.0 238.0 L525.0 259.0 L525.0 259.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M125.0 399.0 L155.0 399.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M375.0 133.0 L225.0 133.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M285.0 343.0 L285.0 357.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M625.0 105.0 L625.0 161.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M385.0 133.0 L385.0 161.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M525.0 119.0 L525.0 161.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M25.0 105.0 L25.0 161.0 "></path>
    <text x="60" y="110" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      virtual memory
    </text>
    <text x="60" y="124" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      reserved memory
    </text>
    <text x="60" y="138" font-family="sans-serif" font-size="14" stroke="none" fill="#000000">
      committed memory
    </text>
    <text x="240" y="54" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      untouched/unused
    </text>
    <text x="240" y="68" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      page
    </text>
    <text x="476" y="292" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      ...
    </text>
    <text x="410" y="292" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      2000
    </text>
    <text x="410" y="320" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      6001
    </text>
    <text x="60" y="54" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      touched/used
    </text>
    <text x="60" y="68" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      page
    </text>
    <text x="562" y="305" font-family="sans-serif" font-size="10" stroke="none" fill="#000000">
      MMU
    </text>
    <text x="266" y="292" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      ...
    </text>
    <text x="266" y="320" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      ...
    </text>
    <text x="180" y="292" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      40
    </text>
    <text x="183" y="320" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      2 
    </text>
    <text x="103" y="292" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      2 
    </text>
    <text x="103" y="320" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      7 
    </text>
    <text x="350" y="292" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      1000
    </text>
    <text x="350" y="320" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      6000
    </text>
    <text x="603" y="502" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      Disk
    </text>
    <text x="33" y="292" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      0 
    </text>
    <text x="33" y="320" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      9 
    </text>
    <text x="451" y="474" font-family="sans-serif" font-size="13" stroke="none" fill="#000000">
      swap
    </text>
    <text x="136" y="292" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      ...
    </text>
    <text x="136" y="320" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      ...
    </text>
    <text x="210" y="501" font-family="sans-serif" font-size="12" stroke="none" fill="#000000">
      RAM
    </text>
    <text x="220" y="292" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      50
    </text>
    <text x="63" y="292" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      1 
    </text>
    <text x="60" y="320" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      50
    </text>
  </g>
</svg>
</div>
<div class="title">paging (for a single process)</div>
</div>
<div class="paragraph">
<p>The graph above shows the addressable space of a process and its <em>pages</em>.
The process can access these pages using the addresses of it’s virtual space,
however these pages have to be stored physically, usually in RAM, sometime on disk,
when referring to these chunks of memory on hardware we use the term <em>frame</em>.</p>
</div>
<div class="paragraph">
<p>The real memory address is naturally different from this virtual address space
for the process. There’s a specialized component called MMU (Memory Management Unit)
to perform the translation between virtual addresses and physical addresses.</p>
</div>
<div class="paragraph">
<p>The motivation behind virtual memory and paging comes from multi-tasking, to allows
to run several program. Each process will have the illusion of a bigger memory.
The OS is hard at work performing various tricks to keep these illusions for all processes.
From this single observation &#34;Not all memory is used at the same time&#34;,
it’s possible :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>to not use physical memory frames if the process didn’t yet <em>touch</em> this page, in
other words such a page does not really exist.</p>
</li>
<li>
<p>to use a slower device to store pages, usually a disk, in special part called <em>swap</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <em>resident set size</em> mean the total size of pages of a process that resides either
in RAM or in secondary storage, i.e. without untouched/unused pages.
This contrasts with VSZ or virtual size which includes the total address space of
a program, this value is usually way superior to RSS.</p>
</div>
<div class="paragraph">
<p><em>If you want to dive how the whole paging thing works head to
system courses, articles (like <a href="https://landley.net/writing/memory-faq.txt">this masterpiece</a>)
where they usually explain in depth how everything interacts.</em></p>
</div>
<div class="paragraph">
<p>To put things in context I’d like to explain one last thing to memory management
with the JVM perspective.</p>
</div>
<div class="sect4">
<h5 id="_reserved_and_committed_memory_in_the_jvm"><a class="anchor" href="#_reserved_and_committed_memory_in_the_jvm"></a><a class="link" href="#_reserved_and_committed_memory_in_the_jvm">Reserved and committed memory in the JVM</a></h5>
<div class="paragraph">
<p>As mentioned above one of the idea of the <strong>reserved</strong> / <strong>committed</strong> memory is to
provide the illusion of a single <strong>continuous</strong> memory space.</p>
</div>
<div class="paragraph">
<p>Concretely for the JVM it means that the <em>committed</em> memory is immediately usable,
and the <em>reserved</em> memory part means memory <em>put on hold</em> and not usable.
Now with a better understanding of how memory works let’s look again at the output
of the <code>VM.native_memory</code> command to make more sense of it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">Total: reserved=7168324KB, committed=5380868KB                               <i class="conum" data-value="1"></i><b>(1)</b>
-                 Java Heap (reserved=4456448KB, committed=4456448KB)        <i class="conum" data-value="2"></i><b>(2)</b>
                            (mmap: reserved=4456448KB, committed=4456448KB)
...
-                     Class (reserved=1195628KB, committed=165788KB)         <i class="conum" data-value="3"></i><b>(3)</b>
...
-                    Thread (reserved=696395KB, committed=85455KB)           <i class="conum" data-value="4"></i><b>(4)</b>
...
-                      Code (reserved=251877KB, committed=105201KB)
...
-                        GC (reserved=230739KB, committed=230739KB)          <i class="conum" data-value="5"></i><b>(5)</b>
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The process addressable memory and what is currently committed.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Here the NMT also show the same abstractions of committed and reserved memory,
on this process these values are the same because the <code>InitialHeapSize</code> (<code>Xms</code>) and
<code>MaxHeapSize</code> (<code>Xmx</code>)are the same. If these boundaries were different it is likely
the heap zone would show different values for reserved and committed memory; the
JVM will increase the committed memory if necessary, and can even uncommit some of
this memory if the GC algorithm allows it.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Class, Code spaces works the same way, specifics JVM flags control the reserved
and committed memory.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Java Threads are allocated within the process memory, the JVM flags only control
the size of a thread. I will expand on this later.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Then comes the other memory space of the JVM, like the GC internal structures, who
are using a different memory management, these zones usually have the same reserved/committed
amount.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Iterating on the graph above the memory is split in smaller regions.</p>
</div>
<div class="imageblock">
<div class="content">
<svg xmlns="http://www.w3.org/2000/svg" version="1.0" shape-rendering="geometricPrecision" preserveAspectRatio="xMidYMid meet" viewBox="0 0 770.0 266.0" width="770px" height="266px">
  <defs>
    <style type="text/css">
      @font-face { font-family: sans-serif; }
    </style>
    <filter id="shadowBlur" x="0" y="0" width="200%" height="200%">
      <feOffset in="SourceGraphic" dx="3.0003002" dy="3.0003002" result="offOut"></feOffset>
      <feGaussianBlur in="offOut" stdDeviation="3"></feGaussianBlur>
    </filter>
  </defs>
  <g stroke-width="1" stroke-linecap="square" stroke-linejoin="round">
    <rect x="0" y="0" width="770" height="266" style="fill: #ffffff"></rect>
    <path stroke="#969696" fill="#969696" filter="url(#shadowBlur)" d="M745.0 147.0 L745.0 175.0 L25.0 175.0 L25.0 147.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="white" d="M745.0 147.0 L745.0 175.0 L25.0 175.0 L25.0 147.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M40.0 42.0 L30.0 49.0 L40.0 56.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M730.0 42.0 L740.0 49.0 L730.0 56.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M40.0 56.0 L30.0 63.0 L40.0 70.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M700.0 56.0 L710.0 63.0 L700.0 70.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M40.0 70.0 L30.0 77.0 L40.0 84.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M670.0 70.0 L680.0 77.0 L670.0 84.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M40.0 84.0 L30.0 91.0 L40.0 98.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M270.0 84.0 L280.0 91.0 L270.0 98.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M300.0 84.0 L290.0 91.0 L300.0 98.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M490.0 84.0 L500.0 91.0 L490.0 98.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M520.0 84.0 L510.0 91.0 L520.0 98.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M620.0 84.0 L630.0 91.0 L620.0 98.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M40.0 98.0 L30.0 105.0 L40.0 112.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M230.0 98.0 L240.0 105.0 L230.0 112.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M300.0 98.0 L290.0 105.0 L300.0 112.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M470.0 98.0 L480.0 105.0 L470.0 112.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M40.0 112.0 L30.0 119.0 L40.0 126.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M190.0 112.0 L200.0 119.0 L190.0 126.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M40.0 196.0 L30.0 203.0 L40.0 210.0 z"></path>
    <path stroke="none" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="#000000" d="M730.0 196.0 L740.0 203.0 L730.0 210.0 z"></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M460.0 105.0 L475.0 105.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M735.0 49.0 L205.0 49.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M735.0 203.0 L265.0 203.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M215.0 63.0 L705.0 63.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M675.0 77.0 L225.0 77.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M195.0 91.0 L275.0 91.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M235.0 105.0 L205.0 105.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M495.0 91.0 L465.0 91.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M55.0 49.0 L35.0 49.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M35.0 63.0 L55.0 63.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M55.0 77.0 L35.0 77.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M55.0 91.0 L35.0 91.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M55.0 105.0 L35.0 105.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M55.0 119.0 L35.0 119.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M55.0 203.0 L35.0 203.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M535.0 91.0 L515.0 91.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M315.0 91.0 L295.0 91.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M315.0 105.0 L295.0 105.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M195.0 119.0 L155.0 119.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M625.0 91.0 L605.0 91.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M715.0 147.0 L715.0 63.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M25.0 175.0 L25.0 217.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M745.0 49.0 L745.0 147.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M635.0 91.0 L635.0 147.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M745.0 175.0 L745.0 217.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M505.0 91.0 L505.0 147.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M285.0 91.0 L285.0 147.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M205.0 119.0 L205.0 147.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M485.0 105.0 L485.0 147.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M25.0 49.0 L25.0 147.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M685.0 77.0 L685.0 147.0 "></path>
    <path stroke="#000000" stroke-width="1.0" stroke-dasharray="5.000000,5.000000" stroke-miterlimit="0" stroke-linecap="butt" stroke-linejoin="round" fill="white" d="M245.0 147.0 L245.0 105.0 "></path>
    <text x="60" y="54" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      virtual memory
    </text>
    <text x="60" y="68" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      reserved memory
    </text>
    <text x="60" y="82" font-family="sans-serif" font-size="14" stroke="none" fill="#000000">
      committed memory
    </text>
    <text x="60" y="96" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      heap max size
    </text>
    <text x="60" y="110" font-family="sans-serif" font-size="15" stroke="none" fill="#ffffff">
      committed heap
    </text>
    <text x="60" y="124" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      used heap
    </text>
    <text x="63" y="166" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      addressable space of the process
    </text>
    <text x="330" y="96" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      Class reserved
    </text>
    <text x="325" y="110" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      Class commited
    </text>
    <text x="71" y="208" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      contiguous addresses
    </text>
    <text x="661" y="236" font-family="sans-serif" font-size="14" stroke="none" fill="#000000">
      0x8000000
    </text>
    <text x="544" y="96" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      others
    </text>
    <text x="23" y="236" font-family="sans-serif" font-size="15" stroke="none" fill="#000000">
      0 
    </text>
  </g>
</svg>
</div>
<div class="title">JVM memory zones</div>
</div>
<div class="paragraph">
<p>This immediately leads to new vocabulary :</p>
</div>
<table class="tableblock frame-all grid-all fit-content stretch">
<caption class="title">Table 2. Java memory vocabulary</caption>
<colgroup>
<col/>
<col/>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Used Heap</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The amount of memory occupied by live objects and to a certain extent object
that are unreachable but not yet collected by the GC. This only relate to the JVM Java heap.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Committed heap</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The current limit if the writable memory to write objects to.
It’s the current workspace of the GC. Upon process start this value should be equal to <code>Xms</code>,
then the GC may expand it up to the Java heap reserved memory, or in Java terms the heap max size,
or <code>Xmx</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Heap Max Size</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum amount of memory that the Java heap can occupy.
It’s the <em>reserved</em> amount in Java Heap section of the NMT output.
If the application requires more memory this will result in a <code>OutOfMemoryError</code>.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>So committed stands for writable memory and reserved stands for total addressable space
of the memory. Hiw does it work concretely?</p>
</div>
<div class="paragraph">
<p>The JVM starts by <a href="https://github.com/corretto/corretto-11/blob/3b31d243a19774bebde63df21cc84e994a89439a/src/src/hotspot/os/linux/os_linux.cpp#L3421-L3444"><em>reserving</em> the memory</a>,
then parts of this &#34;reserve&#34; will be made available by
<a href="https://github.com/corretto/corretto-11/blob/3b31d243a19774bebde63df21cc84e994a89439a/src/src/hotspot/os/linux/os_linux.cpp#L3517-L3531">modifying the memory mappings</a>
using <code>malloc</code>, <code>mmap</code>, as well as <code>mprotect</code> calls in particular (on Linux).</p>
</div>
</div>
<div class="sect4">
<h5 id="_malloc_and_mmap"><a class="anchor" href="#_malloc_and_mmap"></a><a class="link" href="#_malloc_and_mmap"><code>malloc</code> and <code>mmap</code></a></h5>
<div class="paragraph">
<p>The <code>malloc</code> and <code>mmap</code> C calls ask the OS to allocate memory. And it’s the job of the OS to
provide the application the necessary memory, or fail if not possible.</p>
</div>
<div class="paragraph">
<p>Also, depending on the mapping in particular for <code>mmap</code> the OS can be asked to make a file
accessible as a memory zone, in short it’s the kernel that perform IOs, in contrast to perform
IOs with a file descriptor application side.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../../static/assets/maxrampercentage/malloc-mmap.svg" alt="malloc mmap" title="Simple overview of malloc and mmap"/></span></p>
</div>
<details>
<summary class="title">Differences between <a href="https://linux.die.net/man/3/malloc"><code>malloc</code></a> and <a href="http://www.kernel.org/doc/man-pages/online/pages/man2/mmap.2.html"><code>mmap</code></a></summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>malloc</code> may <em>recycle</em> previously used memory that was released by <code>free</code>,
and perform a system call to get memory only required. It’s part of the C standard.</p>
</li>
<li>
<p><code>malloc</code> allows you pass a size and that’s basically it.</p>
</li>
<li>
<p><code>mmap</code> is a system call. It’s not part of the C standard, and may not be available
on all platforms.</p>
</li>
<li>
<p><code>mmap</code> can both map private memory or shared memory (as in shared with other processes).
Those are called <em>anonymous mapping</em> using flag <code>MAP_ANONYMOUS</code>.</p>
</li>
<li>
<p><code>mmap</code> can also interact with disk files on specific ranges, without having
a file descriptor.</p>
</li>
<li>
<p><code>mmap</code> can be set with various flags that are used to control how this memory
mapping behave.</p>
</li>
<li>
<p>Both have their performance characteristics, <code>malloc</code> is usually preferred for
few and small allocations, <code>mmap</code> is preferred for few but large allocations.</p>
</li>
</ul>
</div>
</div>
</details>
<div class="paragraph">
<p>When the JVM bootstrap, it requests a main memory of a certain size with the <code>PROT_NONE</code>
flag to prevent any access. This has the effect to tell the OS that this mapping should
not be backed by physical memory. Then when memory is needed by the program,
the JVM changes the mapping for a sub-range of that main memory by removing the
<code>PROT_NONE</code> flag. When new java threads are created then the JVM will simply
request another memory segment.</p>
</div>
<details>
<summary class="title">Simple code example</summary>
<div class="content">
<div class="paragraph">
<p>To help you understand here’s a very simple program:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>that <strong>reserves</strong> <code>16 MiB</code> via a <code>malloc</code> call and <code>16 MiB</code> via the <code>mmap</code> call</p>
</li>
<li>
<p>then this program will invoke <code>ps</code> to show its actual memory consumption (RSS)</p>
</li>
<li>
<p>then it will touch/use memory by setting a bit every <code>1 KiB</code></p>
</li>
<li>
<p>then this program will invoke <code>ps</code> again to show its actual memory consumption (RSS)</p>
</li>
</ol>
</div>
<div class="listingblock primary">
<div class="title">memory example</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="c" class="language-c hljs">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/mman.h&gt;

#define HEAP_SIZE (16 * 1024 * 1024 * sizeof(char))

int main (int argc, char *argv[])
{
  char *heap1 = malloc(HEAP_SIZE);
  char *heap2 = mmap(0, HEAP_SIZE, PROT_NONE|PROT_WRITE, MAP_PRIVATE | MAP_NORESERVE | MAP_ANONYMOUS, -1, 0);

  pid_t pid = getpid();
  printf(&#34;pid: %d\n&#34;, pid);

  char buffer[50];

  sprintf(buffer, &#34;ps -p %d -o rss,vsz,command&#34;, pid);
  printf(&#34;Executing: &#39;%s&#39;\n&#34;, buffer);
  system(buffer);

  printf(&#34;Writing to some pages, but not all\n&#34;);

  for (char* i = heap1; i &lt; (heap1 + HEAP_SIZE / 16); i += 1024) {
    *i = 0x01;
  }
  for (char* i = heap2; i &lt; (heap2 + HEAP_SIZE / 8); i += 1024) {
    *i = 0x01;
  }

  sprintf(buffer, &#34;ps -p %d -o rss,vsz,command&#34;, pid);
  printf(&#34;Executing: &#39;%s&#39;\n&#34;, buffer);
  system(buffer);

  free(heap1);
  munmap(heap2, HEAP_SIZE);

  return 0;
}</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title">result</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="shell" class="language-shell hljs">$ gcc -Wall -Wpedantic -o heap-malloc heap-malloc.c &amp;&amp; ./heap-mem
pid: 4301956

Executing: &#39;ps -p 2904 -o rss,vsz,command&#39;
   RSS      VSZ COMMAND
   708  4301956 ./test-mem
Writing to some pages, but not all
Executing: &#39;ps -p 2904 -o rss,vsz,command&#39;
   RSS      VSZ COMMAND
  3780  4301956 ./test-mem</code></pre>
</div>
</div>
<div class="paragraph">
<p>As the <code>stdout</code> shows the RSS of this program is very low until memory is actually written to. At the same time
the virtual memory is much, much higher; it means this simple program could address up to
about <code>4 GiB</code>.</p>
</div>
<div class="paragraph">
<p><em>This program ran on a MacBook Pro 2018 running an Intel Core i7 CPU.</em></p>
</div>
</div>
</details>
<div class="paragraph">
<p>Now after some memory management refresh, let’s go back to the main topic of this blog post.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exploring_what_nmt_does_not_show"><a class="anchor" href="#_exploring_what_nmt_does_not_show"></a><a class="link" href="#_exploring_what_nmt_does_not_show">Exploring what NMT does not show</a></h4>
<div class="paragraph">
<p>The <code>NativeMemoryTracking</code> output showed memory usage of the JVM, but it didn’t report
<code>MappedByteBuffers</code>, those are the files that are <em>memory mapped</em> to the virtual memory
of a process as explained above via the native <code>mmap</code> call.
Memory pages of the file content that have been placed in RAM by the OS are accounted in RSS.</p>
</div>
<div class="paragraph">
<p>First let’s see the memory mappings of a process using the handy command : <code>pmap -x &lt;pid&gt;</code>.
<code>pmap</code> is part of the <a href="https://gitlab.com/procps-ng/procps/"><code>procps</code></a> utilities, that contains
other tools like: <code>ps</code>, <code>pgrep</code>, <code>watch</code> or <code>vmstat</code>, so it’s likely that no additional
installation is required which is desirable when the container filesystem is read-only.</p>
</div>
<div class="paragraph">
<p>For example on the same process on which I showed the native memory.</p>
</div>
<div class="listingblock">
<div class="title">process memory mappings</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ pmap -x $(pgrep java)
6:   /usr/bin/java -Dfile.encoding=UTF-8 -Duser.timezone=UTC -Djava.security.egd=file:/dev/./urandom
-XX:InitialRAMPercentage=85.0 -XX:MaxRAMPercentage=85.0 -XX:NativeMemoryTracking=summary
-Xlog:os,safepoint*,gc*,gc+ref=debug,gc+ergo*=debug,gc+age*=debug,gc+phases*:file=/gclogs/%t-gc.log:time,uptime,tags:filecount=5,filesize=10M -javaag
Address           Kbytes     RSS   Dirty Mode  Mapping
0000000000400000       4       4       0 r-x-- java
0000000000600000       4       4       4 r---- java
0000000000601000       4       4       4 rw--- java
000000000216f000     404     272     272 rw---   [ anon ]
00000006f0000000 4476620 3128252 3128252 rw---   [ anon ]
00000008013b3000 1028404       0       0 -----   [ anon ]
00007fc5de9ea000      16       0       0 -----   [ anon ]
00007fc5de9ee000    1012     104     104 rw---   [ anon ]
00007fc5deaeb000      16       0       0 -----   [ anon ]
00007fc5deaef000    1012      24      24 rw---   [ anon ]
00007fc5debec000      16       0       0 -----   [ anon ]
00007fc5debf0000    1012      92      92 rw---   [ anon ]
00007fc5deced000      16       0       0 -----   [ anon ]
00007fc5decf1000    1012     100     100 rw---   [ anon ]
00007fc5dedee000      16       0       0 -----   [ anon ]
00007fc5dedf2000    1012     100     100 rw---   [ anon ]
00007fc5deeef000      16       0       0 -----   [ anon ]
00007fc5deef3000    1012     100     100 rw---   [ anon ]
00007fc5deff0000      16       0       0 -----   [ anon ]
00007fc5deff4000    1012     100     100 rw---   [ anon ]
00007fc5df0f1000      16       0       0 -----   [ anon ]
00007fc5df0f5000    1012     100     100 rw---   [ anon ]
00007fc5df1f2000      16       0       0 -----   [ anon ]
00007fc5df1f6000    1012     100     100 rw---   [ anon ]
00007fc5df2f3000      16       0       0 -----   [ anon ]
00007fc5df2f7000    1012     100     100 rw---   [ anon ]
00007fc5df3f4000      16       0       0 -----   [ anon ]
00007fc5df3f8000    1012     100     100 rw---   [ anon ]
00007fc5df4f5000      16       0       0 -----   [ anon ]
00007fc5df4f9000    1012     100     100 rw---   [ anon ]
00007fc5df5f6000      16       0       0 -----   [ anon ]
00007fc5df5fa000    1012     100     100 rw---   [ anon ]

...

00007fca48ba9000   17696   14876       0 r-x-- libjvm.so
00007fca49cf1000    2044       0       0 ----- libjvm.so
00007fca49ef0000     764     764     764 r---- libjvm.so
00007fca49faf000     232     232     208 rw--- libjvm.so
00007fca49fe9000     352     320     320 rw---   [ anon ]
00007fca4a041000     136     136       0 r---- libc-2.28.so
00007fca4a063000    1312    1140       0 r-x-- libc-2.28.so
00007fca4a1ab000     304     148       0 r---- libc-2.28.so
00007fca4a1f7000       4       0       0 ----- libc-2.28.so
00007fca4a1f8000      16      16      16 r---- libc-2.28.so
00007fca4a1fc000       8       8       8 rw--- libc-2.28.so
00007fca4a1fe000      16      16      16 rw---   [ anon ]
00007fca4a202000       4       4       0 r---- libdl-2.28.so
00007fca4a203000       4       4       0 r-x-- libdl-2.28.so
00007fca4a204000       4       4       0 r---- libdl-2.28.so
00007fca4a205000       4       4       4 r---- libdl-2.28.so
00007fca4a206000       4       4       4 rw--- libdl-2.28.so
00007fca4a207000     100     100       0 r-x-- libjli.so
00007fca4a220000    2048       0       0 ----- libjli.so
00007fca4a420000       4       4       4 r---- libjli.so
00007fca4a421000       4       4       4 rw--- libjli.so
00007fca4a422000      24      24       0 r---- libpthread-2.28.so
00007fca4a428000      60      60       0 r-x-- libpthread-2.28.so
00007fca4a437000      24       0       0 r---- libpthread-2.28.so
00007fca4a43d000       4       4       4 r---- libpthread-2.28.so
00007fca4a43e000       4       4       4 rw--- libpthread-2.28.so
00007fca4a43f000      16       4       4 rw---   [ anon ]
00007fca4a443000       4       4       0 r---- LC_IDENTIFICATION
00007fca4a444000       4       0       0 -----   [ anon ]
00007fca4a445000       4       0       0 r----   [ anon ]
00007fca4a446000       8       8       8 rw---   [ anon ]
00007fca4a448000       4       4       0 r---- ld-2.28.so
00007fca4a449000     120     120       0 r-x-- ld-2.28.so
00007fca4a467000      32      32       0 r---- ld-2.28.so
00007fca4a46f000       4       4       4 r---- ld-2.28.so
00007fca4a470000       4       4       4 rw--- ld-2.28.so
00007fca4a471000       4       4       4 rw---   [ anon ]
00007ffe28536000     140      40      40 rw---   [ stack ]
00007ffe28582000      12       0       0 r----   [ anon ]
00007ffe28585000       8       4       0 r-x--   [ anon ]
ffffffffff600000       4       0       0 r-x--   [ anon ]
---------------- ------- ------- -------
total kB         24035820 4776860 4720796</code></pre>
</div>
</div>
<div class="paragraph">
<p>To select the file mappings we can filter on the
<a href="https://www.kernel.org/doc/Documentation/filesystems/proc.txt">access permissions</a>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>r-</code>: readable memory mapping</p>
</li>
<li>
<p><code>w</code>: writable memory mapping</p>
</li>
<li>
<p><code>x</code>: executable memory mapping</p>
</li>
<li>
<p><code>s</code> or <code>p</code> : shared memory mapping or private mapping. <code>/proc/&lt;pid&gt;/maps</code></p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>On a side note, <code>pmap</code> may show another mapping mode which I barely found any reference of,
here’s <a href="https://johanlouwers.blogspot.com/2017/07/oracle-linux-understanding-linux.html">one</a>
and <a href="https://linux.die.net/man/2/mmap">here</a></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>R</code>: if set, the map has no swap space reserved (<code>MAP_NORESERVE</code> flag of <code>mmap</code>).
This means that we can get a segmentation fault by accessing that memory if it has not
already been mapped to physical memory, and if the system is out of physical memory.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p><em>I was a bit unfamiliar with <code>pmap</code>, reading <a href="https://techtalk.intersec.com/2013/07/memory-part-2-understanding-process-memory/">this process memory blog</a>
helped me with this command.</em></p>
</div>
<div class="paragraph">
<p>At this time the focus is to see what are the memory mapped files with the JVM.
The <code>Mapping</code> column on the of <code>pmap -x $(pgrep java)</code> can be parsed to identify
file mappings, but this is brittle and unnecessary, one can simply look at
the output of <code>pmap -X $(pgrep java)</code> (notice the big <code>X</code>) or even at the
<code>/proc/$(pidof java)/maps</code> content looking for a non-zero value of the <code>inode</code>
column inidcating this is a file.</p>
</div>
<div class="paragraph">
<p>Using the output of <code>pmap -X $(pgrep java)</code> and selecting the matching lines
with <code>awk</code> this is <em>easy</em>:</p>
</div>
<div class="listingblock">
<div class="title">Shared application memory mapped files</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ pmap -X $(pidof java) | awk &#39;{ if (NR &lt;= 2 || $5 &gt;0 ) \ <i class="conum" data-value="1"></i><b>(1)</b>
  printf &#34;%12s %8s %8s %4s %s\n&#34;, \ <i class="conum" data-value="2"></i><b>(2)</b>
  $1, \
  $6, \
  $7, \
  $2, \
  $19 }&#39; <i class="conum" data-value="2"></i><b>(2)</b>
          7: -Djava.awt.headless=true -XX:NativeMemoryTracking=summary /usr/bin/java
     Address     Size      Rss Perm Mapping <i class="conum" data-value="3"></i><b>(3)</b>
561ddb94a000        4        4 r-xp java
561ddbb4b000        4        4 r--p java
561ddbb4c000        4        4 rw-p java
7f355521f000        4        4 r--s instrumentation9549273990865322165.jar
7f355964d000        4        4 r--s instrumentation14393425676176063484.jar
7f3559e50000     1160     1160 r--s dd-java-agent.jar
7f355a372000      256      192 r-xp libsunec.so
7f355a3b2000     2048        0 ---p libsunec.so
7f355a5b2000       20       20 r--p libsunec.so
7f355a5b7000        8        8 rw-p libsunec.so
7f355a7b9000       16       16 r--p libresolv-2.28.so
7f355a7bd000       52       52 r-xp libresolv-2.28.so
7f355a7ca000       16       16 r--p libresolv-2.28.so
7f355a7ce000        4        0 ---p libresolv-2.28.so
7f355a7cf000        4        4 r--p libresolv-2.28.so
7f355a7d0000        4        4 rw-p libresolv-2.28.so
7f355a7d3000        4        4 r--p libnss_dns-2.28.so
7f355a7d4000       16       16 r-xp libnss_dns-2.28.so
7f355a7d8000        4        0 r--p libnss_dns-2.28.so
7f355a7d9000        4        4 r--p libnss_dns-2.28.so
7f355a7da000        4        4 rw-p libnss_dns-2.28.so
7f355a7dd000        4        4 r--s instrumentation13129117816180832587.jar
7f355a7de000        8        8 r-xp libextnet.so
7f355a7e0000     2044        0 ---p libextnet.so
7f355a9df000        4        4 r--p libextnet.so
7f355b9e9000        4        4 r--s newrelic-bootstrap1151474907525430822.jar
7f355bfea000       24       24 r-xp libmanagement_ext.so
7f355bff0000     2044        0 ---p libmanagement_ext.so
7f355c1ef000        4        4 r--p libmanagement_ext.so
7f355c1f0000        4        4 rw-p libmanagement_ext.so
7f355c1f1000       16       16 r-xp libmanagement.so
7f355c1f5000     2048        0 ---p libmanagement.so
7f355c3f5000        4        4 r--p libmanagement.so
7f355c5f7000        8        8 r--s newrelic-weaver-api14962018995408739070.jar
7f355c5f9000       12       12 r--s newrelic-api8237374132620194936.jar
7f355c5fc000        4        4 r--s newrelic-opentracing-bridge6621669571490510163.jar
7f355c5fd000       16       16 r--s agent-bridge7978421659510986627.jar
7f355c601000       88       88 r-xp libnet.so
7f355c617000     2048        0 ---p libnet.so
7f355c817000        4        4 r--p libnet.so
7f355c818000        4        4 rw-p libnet.so
7f355c819000       64       64 r-xp libnio.so
7f355c829000     2048        0 ---p libnio.so
7f355ca29000        4        4 r--p libnio.so
7f355ca2a000        4        4 rw-p libnio.so
7f355cf30000      200      128 r--p LC_CTYPE
7f355cf62000        4        4 r--p LC_NUMERIC
7f355cf63000        4        4 r--p LC_TIME
7f355cf64000     1484      156 r--p LC_COLLATE
7f355d0d7000        4        4 r--p LC_MONETARY
7f355d0d8000        4        4 r--p SYS_LC_MESSAGES
7f355d0d9000        4        4 r--p LC_PAPER
7f355d0da000        4        4 r--p LC_NAME
7f355d0db000       28       28 r--s gconv-modules.cache
7f357663b000   138232    30036 r--s modules
7f357ed39000      104       92 r-xp libzip.so
7f357ed53000     2044        0 ---p libzip.so
7f357ef52000        4        4 r--p libzip.so
7f357ef5c000       12       12 r--p libnss_files-2.28.so
7f357ef5f000       28       28 r-xp libnss_files-2.28.so
7f357ef66000        8        8 r--p libnss_files-2.28.so
7f357ef68000        4        0 ---p libnss_files-2.28.so
7f357ef69000        4        4 r--p libnss_files-2.28.so
7f357ef6a000        4        4 rw-p libnss_files-2.28.so
7f357ef71000        4        4 r--p LC_ADDRESS
7f357ef72000        4        4 r--p LC_TELEPHONE
7f357ef73000        4        4 r--p LC_MEASUREMENT
7f357ef74000       40       40 r-xp libinstrument.so
7f357ef7e000     2044        0 ---p libinstrument.so
7f357f17d000        4        4 r--p libinstrument.so
7f357f17e000        4        4 rw-p libinstrument.so
7f357f17f000      108       64 r-xp libjimage.so
7f357f19a000     2048        0 ---p libjimage.so
7f357f39a000        8        8 r--p libjimage.so
7f357f39c000        4        4 rw-p libjimage.so
7f357f39d000      164      164 r-xp libjava.so
7f357f3c6000     2048        0 ---p libjava.so
7f357f5c6000        4        4 r--p libjava.so
7f357f5c7000        4        4 rw-p libjava.so
7f357f5c9000       68       68 r-xp libverify.so
7f357f5da000     2044        0 ---p libverify.so
7f357f7d9000        8        8 r--p libverify.so
7f357f7dc000        8        8 r--p librt-2.28.so
7f357f7de000       16       16 r-xp librt-2.28.so
7f357f7e2000        8        0 r--p librt-2.28.so
7f357f7e4000        4        4 r--p librt-2.28.so
7f357f7e5000        4        4 rw-p librt-2.28.so
7f357f8e7000    17680    15012 r-xp libjvm.so
7f3580a2b000     2044        0 ---p libjvm.so
7f3580c2a000      764      764 r--p libjvm.so
7f3580ce9000      228      228 rw-p libjvm.so
7f3580d7d000       12       12 r--p libgcc_s.so.1
7f3580d80000       68       64 r-xp libgcc_s.so.1
7f3580d91000       12       12 r--p libgcc_s.so.1
7f3580d94000        4        0 ---p libgcc_s.so.1
7f3580d95000        4        4 r--p libgcc_s.so.1
7f3580d96000        4        4 rw-p libgcc_s.so.1
7f3580d97000       52       52 r--p libm-2.28.so
7f3580da4000      636      368 r-xp libm-2.28.so
7f3580e43000      852      128 r--p libm-2.28.so
7f3580f18000        4        4 r--p libm-2.28.so
7f3580f19000        4        4 rw-p libm-2.28.so
7f3580f1a000      548      548 r--p libstdc++.so.6.0.25
7f3580fa3000      688      192 r-xp libstdc++.so.6.0.25
7f358104f000      248       64 r--p libstdc++.so.6.0.25
7f358108d000        4        0 ---p libstdc++.so.6.0.25
7f358108e000       40       40 r--p libstdc++.so.6.0.25
7f3581098000        8        8 rw-p libstdc++.so.6.0.25
7f35810a0000      136      136 r--p libc-2.28.so
7f35810c2000     1312     1208 r-xp libc-2.28.so
7f358120a000      304      152 r--p libc-2.28.so
7f3581256000        4        0 ---p libc-2.28.so
7f3581257000       16       16 r--p libc-2.28.so
7f358125b000        8        8 rw-p libc-2.28.so
7f3581261000        4        4 r--p libdl-2.28.so
7f3581262000        4        4 r-xp libdl-2.28.so
7f3581263000        4        4 r--p libdl-2.28.so
7f3581264000        4        4 r--p libdl-2.28.so
7f3581265000        4        4 rw-p libdl-2.28.so
7f3581266000      100      100 r-xp libjli.so
7f358127f000     2048        0 ---p libjli.so
7f358147f000        4        4 r--p libjli.so
7f3581480000        4        4 rw-p libjli.so
7f3581481000       24       24 r--p libpthread-2.28.so
7f3581487000       60       60 r-xp libpthread-2.28.so
7f3581496000       24        0 r--p libpthread-2.28.so
7f358149c000        4        4 r--p libpthread-2.28.so
7f358149d000        4        4 rw-p libpthread-2.28.so
7f35814a2000        4        4 r--p LC_IDENTIFICATION
7f35814a5000      152      152 r-xp libtcmalloc_minimal.so.4.5.3
7f35814cb000     2048        0 ---p libtcmalloc_minimal.so.4.5.3
7f35816cb000        4        4 r--p libtcmalloc_minimal.so.4.5.3
7f35816cc000        4        4 rw-p libtcmalloc_minimal.so.4.5.3
7f3581878000        4        4 r--p ld-2.28.so
7f3581879000      120      120 r-xp ld-2.28.so
7f3581897000       32       32 r--p ld-2.28.so
7f358189f000        4        4 r--p ld-2.28.so
7f35818a0000        4        4 rw-p ld-2.28.so
     ======= ======== ============== =======
     6172856        0        0 4245724 <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Filter lines that have an Inode value over 0 and only from the 3rd line (included).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Print only some columns, `pmap -X {pid}’s output is verbose.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The columns are select to match the output of <code>pmap -x</code>, <code>Size</code> column is in <code>KiB</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The last two lines aren’t filtered out due to my limited skills in <code>awk</code>. They are
only valid for the complete output. The actual sum of the size and rss columns
is respectively <code>195336 KiB</code> and <code>52316 KiB</code>.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>What may catch the eye is the multiple mapping for native libraries like <code>libjvm.so</code>.
The reason is that some part of the file is executable, others are for exchanging information
with the library.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>r-xp</code> means an executable segment of the library</p>
</li>
<li>
<p><code>r--p</code> means readable memory of the library, e.g. constants</p>
</li>
<li>
<p><code>rw-p</code> means writable memory, this is usually where the process can set global
variables of thw library.</p>
</li>
<li>
<p><code>---p</code> is a no permission segment, I’m not sure about this one, but it’s location
(between executable and writable segments) makes me think it’s about buffer overflow
prevention.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Mapped files represents <code>195.3 MiB</code> of the address space of which <code>52.3 MiB</code> are
actually resident.</p>
</div>
<div class="paragraph">
<p>Wrapping this information from NMT and memory mapped files leaves us with the
following <em>equation</em> to estimate the actual memory usage of a process:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Total memory = Heap + GC + Metaspace + Code Cache + Symbol tables
               + Compiler + Other JVM structures + Thread stacks
               + Direct buffers + Mapped files +
               + Native Libraries + Malloc overhead + ...</pre>
</div>
</div>
<div class="paragraph">
<p>Using the <strong>committed</strong> values from the NMT output above, and the <strong>mapping size</strong>
this breaks out as :</p>
</div>
<table class="tableblock frame-all grid-all fit-content stretch">
<colgroup>
<col/>
<col/>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Heap</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4456448</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">230739</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Metaspace</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">165788</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Code Cache</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">105201</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Symbol tables</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">28915</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Compiler</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5914</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Other JVM structures
(Internal + NMT + smaller area)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">24460 + 8433 + 217 + 7 + 19 + 1362 + 837 + 8 + 32 = (35375)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Thread stacks</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">85455</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Direct buffers (Other)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">267034</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Total accounted by NMT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5380868</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mapped files (and native libs)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">195336</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Malloc overhead</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">accounted in NMT</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">…​</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
<tfoot>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Total</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5576205 KiB</p></td>
</tr>
</tfoot>
</table>
<div class="paragraph">
<p><code>5576205 KiB</code> is what this container is supposedly actually using, but:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>as expected this is way over the RSS (<code>4701120 KiB</code>) and,</p>
</li>
<li>
<p>also over the <code>5 GiB</code> (<code>5242880 KiB</code>) of the pod limit.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This happens because this pod may not have access all pages especially
if the heap is big enough and the allocation rate is not big enough. While
a pod like this may be health and stay that way. It should rise your eyebrow,
if the RSS grow then the pod is likely to be oomkilled.</p>
</div>
<div class="paragraph">
<p>And this is where one need to review the memory parameter of either
the JVM or the memory limits of the pod. Either the JVM is over-sized
or the JVM will eventually be oomkilled by the OS.</p>
</div>
<div class="sect4">
<h5 id="_how_many_pages_are_used"><a class="anchor" href="#_how_many_pages_are_used"></a><a class="link" href="#_how_many_pages_are_used">How many pages are used ?</a></h5>
<div class="paragraph">
<p>The <em>proc</em> filesystem is nice as it gives the paging details on the current process.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Table 1-3: Contents of the statm files (as of 2.6.8-rc3)
..............................................................................
 Field    Content
 size     total program size (pages)		(same as VmSize in status)
 resident size of memory portions (pages)	(same as VmRSS in status)
 shared   number of pages that are shared	(i.e. backed by a file, same
						as RssFile+RssShmem in status)
 trs      number of pages that are &#39;code&#39;	(not including libs; broken,
							includes data segment)
 lrs      number of pages of library		(always 0 on 2.6)
 drs      number of pages of data/stack		(including libs; broken,
							includes library text)
 dt       number of dirty pages			(always 0 on 2.6)</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="shell" class="language-shell hljs">$ ps -o rss,vsz,command $(pidof java)
  RSS    VSZ COMMAND
4346704 6507368 /usr/bin/java -Dfile.encoding=UTF-8 -Duser.timezone=UTC -Djava.security.egd=file:/dev/./urandom -Djava
$ cat /proc/$(pidof java)/statm | tr &#39; &#39; &#39;\n&#39;
1626842 <i class="conum" data-value="1"></i><b>(1)</b>
1086676 <i class="conum" data-value="2"></i><b>(2)</b>
12638
1
0
1283103
0</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Total size in <em>pages</em> of the addressing space, in bytes : <code>6507368 KiB</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Resident memory in <em>pages</em>, in bytes : <code>4346704 KiB</code></td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Given a page size is <code>4 KiB</code>, it gives in particular :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>vsz = <code>1626842 * 4 = 6507368</code></p>
</li>
<li>
<p>rss = <code>1086676 * 4 = 4346704</code></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If the kubernetes memory limit is <code>5 GiB</code> (<code>5242880 KiB</code>),
then the process may be oom-killed if the program uses more than
<code>1310720</code> used pages. If the program don’t use more pages than this
number this process will be fine.
</td>
</tr>
</tbody></table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_digging"><a class="anchor" href="#_digging"></a><a class="link" href="#_digging">Digging</a></h4>
<div class="paragraph">
<p>The previous section showed that NMT numbers only represents the sizes
of the different JVM memory zones, but, does not reflect the real usage.</p>
</div>
<div class="paragraph">
<p>Most of the time using <code>ps</code> is enough. If however you’d like to understand a bit more
how much JVM components are actually consuming memory, then read on.</p>
</div>
<div class="paragraph">
<p>The JVM components reported by NMT can use different <em>types of memory management</em> and
as such may have multiple allocation mechanisms. For example:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>GC based
<code>Java heap</code> and <code>Metaspace</code> (<code>Class</code>) are usually the biggest consumers of memory,
they both rely on <code>mmap</code>.</p>
<div class="listingblock">
<div class="title">java heap and metaspace</div>
<div class="content">
<pre>-                 Java Heap (reserved=3145728KB, committed=3145728KB)
                            (mmap: reserved=3145728KB, committed=3145728KB)

-                     Class (reserved=1195111KB, committed=164967KB)
                            (classes #27354)
                            (  instance classes #25689, array classes #1665)
                            (malloc=5223KB #86596)
                            (mmap: reserved=1189888KB, committed=159744KB)</pre>
</div>
</div>
<div class="paragraph">
<p>These two <em>memory zones</em> are interesting in that they are managed by the GC algorithm,
put in other words the GC is actually the memory manager of these zones, it is able to
<em>arrange</em> the memory according to the options that are passed on the command line.
E.g. with a fixed size heap (<code>Xms</code> = <code>Xmx</code>), the heap will be constituted of a large memory
segment, in this case the <em>reserved</em> and <em>committed</em> values will be the same as well.</p>
</div>
<div class="paragraph">
<p>Other options may trigger specific behavior for these memory zones, e.g. make
the heap to grow or to shrink (I never saw that in practice,
maybe I’ll see it once I use a JDK 12+ with <em>heap uncommit</em> with <a href="https://openjdk.java.net/jeps/346">JEP-346</a>,
although even the JEP mention it’ll only happen if there is very low activity, which is unlikely to
happen for some workload).</p>
</div>
</li>
<li>
<p>Threads
The Java threads are constructs controlled by the JVM runtime,
each thread is allocated on addressable space, their allocation size is always the
same, but can be controlled via a few JVM parameters. Their usage depends on
application usage. Eg. if the program request 1000 threads, then the JVM needs
to allocate 1000 threads.</p>
<div class="listingblock">
<div class="title">thread</div>
<div class="content">
<pre>-                    Thread (reserved=533903KB, committed=70439KB)
                            (thread #517)
                            (stack: reserved=531432KB, committed=67968KB) <i class="conum" data-value="1"></i><b>(1)</b>
                            (malloc=1866KB #3103) <i class="conum" data-value="2"></i><b>(2)</b>
                            (arena=605KB #1033) <i class="conum" data-value="3"></i><b>(3)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The stack memory is where the JVM puts the thread stack, it’s the sum
of all thread stack memory mappings.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The thread sub-system performed 3103 <code>malloc</code>s amounting to <code>1866 KiB</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The thread local handles required 1033 arenas, amounting to <code>605 KiB</code>.</td>
</tr>
</tbody></table>
</div>
</li>
<li>
<p>Other native zones
The other component reported by NMT management uses different technics. Sometime using a
combination of these technics:</p>
<div class="paragraph">
<p><code>GC</code> zone for example only works with <code>malloc</code> and <code>mmap</code>, and size can grow as needed.</p>
</div>
<div class="listingblock">
<div class="title">gc</div>
<div class="content">
<pre>-                        GC (reserved=180505KB, committed=180505KB)
                            (malloc=30589KB #219593) <i class="conum" data-value="1"></i><b>(1)</b>
                            (mmap: reserved=149916KB, committed=149916KB) <i class="conum" data-value="2"></i><b>(2)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Here the GC performed 219593 <code>malloc</code>s amounting to <code>30589 KiB</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Here the GC reserved and committed memory segment(s) amount to <code>149916 KiB</code>.</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The JVM also implements its own
<a href="https://en.wikipedia.org/wiki/Region-based_memory_management">Arena based memory management</a>,
(distinct from the arena memory management of glibc). It is used by some
subsystems of the JVM or when native code uses internal objects that rely on JVM arenas
<a href="https://github.com/corretto/corretto-11/blob/885a3859f47627467a15adaef36fd90ceb517f5e/src/src/hotspot/share/utilities/bitMap.hpp#L344-L345">[1]</a>
<a href="https://github.com/corretto/corretto-11/blob/7ea9366e39d0650274e45ce966b36bb01d26ff26/src/src/hotspot/share/utilities/growableArray.hpp#L127">[2]</a></p>
</div>
<div class="paragraph">
<p><code>Compiler</code>, <code>Symbol table</code> do use this memory management for example.
Special mention of the <em>thread local handles</em> that also use JVM arenas.</p>
</div>
<div class="paragraph">
<p>NMT reports all the memory allocation technics that are used by a JVM component,
for example the GC system :</p>
</div>
<div class="listingblock">
<div class="title">compiler</div>
<div class="content">
<pre>-                  Compiler (reserved=6666KB, committed=6666KB)
                            (malloc=6533KB #3575) <i class="conum" data-value="1"></i><b>(1)</b>
                            (arena=133KB #5) <i class="conum" data-value="2"></i><b>(2)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The compiler performed 3575 <code>malloc</code>s amounting to <code>6533 KiB</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The compiler uses 5 arenas totaling <code>133 KiB</code>.</td>
</tr>
</tbody></table>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>There are three kinds of segments we can easily guess in the memory
mapping because we know their size, Java heap, metaspace, and threads.
Other segments are difficult to guess for two reasons: the malloc
implementation details, like the arenas in Glibc, and the number of
different <code>malloc</code> calls for a single component.</p>
</div>
<div class="admonitionblock caution">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Todo
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Where to look for this number? While it’s easy to get the RSS of a process, to understand
if the committed heap actually <em>resides</em> on physical memory you need to use <code>pmap</code> or
inspect <code>/proc/{pid}/maps</code> or <code>/proc/{pid}/smaps</code>. You have to notice the one of the first
memory zones is quite big and about the size of the committed heap as shown in NMT. It’s easier
to spot with <code>pmap -X</code> (capital <code>X</code>). <em>Note the captures below are from a different pod/process</em>.</p>
</div>
<div class="listingblock primary">
<div class="title"><code>pmap -x &lt;pid&gt;</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ pmap -x $(pidof java) | less -S -X
6:   /usr/bin/java -Dfile.encoding=UTF-8 -Duser.timezone=UTC -Djava.security.egd=file:/dev/./urandom
Address           Kbytes     RSS   Dirty Mode  Mapping
0000000000400000       4       4       0 r-x-- java
0000000000600000       4       4       4 r---- java
0000000000601000       4       4       4 rw--- java
0000000001cfc000     412     224     224 rw---   [ anon ]
00000006f0000000 4477472 2944744 2944744 rw---   [ anon ] <i class="conum" data-value="1"></i><b>(1)</b>
0000000801488000 1027552       0       0 -----   [ anon ]
00007f11b3744000   16388   16388   16388 rw---   [ anon ]
00007f11b4745000      16       0       0 -----   [ anon ]
00007f11b4749000   50688   49484   49484 rw---   [ anon ]
00007f11b78c9000    1536       0       0 -----   [ anon ]
00007f11b7a49000   32776   32776   32776 rw---   [ anon ]
00007f11b9a4b000      16       0       0 -----   [ anon ] <i class="conum" data-value="2"></i><b>(2)</b>
00007f11b9a4f000    1012      24      24 rw---   [ anon ] <i class="conum" data-value="3"></i><b>(3)</b>
00007f11b9b4c000      16       0       0 -----   [ anon ]
00007f11b9b50000    1012      92      92 rw---   [ anon ]
00007f11b9c4d000      16       0       0 -----   [ anon ]
00007f11b9c51000    1012     116     116 rw---   [ anon ]
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>heap memory</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>a thread guard pages</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>a thread stack</td>
</tr>
</tbody></table>
</div>
<div class="listingblock secondary">
<div class="title"><code>pmap- X &lt;pid&gt;</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ pmap -X $(pidof java) | less -S -X
6:   /usr/bin/java -Dfile.encoding=UTF-8 -Duser.timezone=UTC -Djava.security.egd=file:/dev/./urandom -XX:InitialRAMPercentage=85.0 -XX:MaxRAMPercentage=85.0 -XX:NativeMemoryTracking=summary
         Address Perm   Offset Device   Inode     Size     Rss     Pss Referenced Anonymous LazyFree ShmemPmdMapped Shared_Hugetlb Private_Hugetlb Swap SwapPss Locked THPeligible Mapping
        00400000 r-xp 00000000  08:01 4054960        4       4       1          4         0        0              0              0               0    0       0      0           0 java
        00600000 r--p 00000000  08:01 4054960        4       4       4          4         4        0              0              0               0    0       0      0           0 java
        00601000 rw-p 00001000  08:01 4054960        4       4       4          4         4        0              0              0               0    0       0      0           0 java
        01cfc000 rw-p 00000000  00:00       0      412     224     224        224       224        0              0              0               0    0       0      0           0 [heap] <i class="conum" data-value="1"></i><b>(1)</b>
       6f0000000 rw-p 00000000  00:00       0  4477472 2939592 2939592    2939592   2939592        0              0              0               0    0       0      0           0        <i class="conum" data-value="2"></i><b>(2)</b>
       801488000 ---p 00000000  00:00       0  1027552       0       0          0         0        0              0              0               0    0       0      0           0
    7f11b4745000 ---p 00000000  00:00       0       16       0       0          0         0        0              0              0               0    0       0      0           0
    7f11b4749000 rw-p 00000000  00:00       0    50688   49472   49472      49472     49472        0              0              0               0    0       0      0           0
    7f11b78c9000 ---p 00000000  00:00       0     1536       0       0          0         0        0              0              0               0    0       0      0           0
    7f11b7a49000 rw-p 00000000  00:00       0    32776   32776   32776      32776     32776        0              0              0               0    0       0      0           0
    7f11b9a4b000 ---p 00000000  00:00       0       16       0       0          0         0        0              0              0               0    0       0      0           0        <i class="conum" data-value="3"></i><b>(3)</b>
    7f11b9a4f000 rw-p 00000000  00:00       0     1012     112     112        112       112        0              0              0               0    0       0      0           0        <i class="conum" data-value="4"></i><b>(4)</b>
    7f11b9b4c000 ---p 00000000  00:00       0       16       0       0          0         0        0              0              0               0    0       0      0           0
    7f11b9b50000 rw-p 00000000  00:00       0     1012      96      96         96        96        0              0              0               0    0       0      0           0
    7f11b9c4d000 ---p 00000000  00:00       0       16       0       0          0         0        0              0              0               0    0       0      0           0
    7f11b9c51000 rw-p 00000000  00:00       0     1012     116     116        116       116        0              0              0               0    0       0      0           0
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>native heap memory</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>java heap</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>a thread guard pages</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>a thread stack</td>
</tr>
</tbody></table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_move_elsewhere"><a class="anchor" href="#_move_elsewhere"></a><a class="link" href="#_move_elsewhere">Move elsewhere</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_virtual_memory_and_paging"><a class="anchor" href="#_virtual_memory_and_paging"></a><a class="link" href="#_virtual_memory_and_paging">virtual memory and paging</a></h3>
<div class="paragraph">
<p><strong>Virtual memory</strong> is a memory management scheme that is used by most operating systems ;
it allows programs to use memory without dealing with hardware, or other concerns like
sharing the memory resource. In doing so it allows programs to request more memory than
available. In this scheme the OS splits the virtual memory and the memory in smaller chunks
called <strong>pages</strong>. For any given page in the virtual memory, and depending on the application(s)
the OS may:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Make this page resident in physical memory, if something has be written into it.</p>
</li>
<li>
<p>Do nothing if a page is not used, this page is virtually available.</p>
</li>
<li>
<p>Move a page from physical memory to swap, if the OS thinks there’s not enough room for other pages.</p>
</li>
<li>
<p>Map a portion of a file to this page.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="../../static/assets/maxrampercentage/os-memory-paging.svg" alt="os memory paging" title="Simple overview of OS paging"/></span></p>
</div>
<div class="paragraph">
<p>E.g at the moment this report was executed the committed memory is <code>5380868 KiB</code> (<code>5.13 GiB</code>) while
the process RSS is <code>4701120 KiB</code>. The difference relates to how <code>mmap</code> works (on Linux), memory
pages are only backed by physical memory once they’re written to.</p>
</div>
<div class="paragraph">
<p>Some people may have heard of the <code>-XX:+AlwaysPreTouch</code> Hotspot option. This option tells
the JVM to <a href="https://github.com/corretto/corretto-11/blob/3b31d243a19774bebde63df21cc84e994a89439a/src/src/hotspot/share/runtime/os.cpp#L1825-L1829">write a zero to every OS memory pages</a>.
This option has the effect of avoiding physical memory commit latencies at runtime, however this
only affects the heap memory zone. Other areas like thread stack or metaspace work differently.</p>
</div>
<div class="paragraph">
<p>In other words that means parts of the <strong>committed</strong> memory shown in NMT is not <strong>resident</strong> and as such
RSS counter may not reflect what is een in the <strong>committed</strong> memory.</p>
</div>
</div>
</div>
</div>

  </div>
  

<div class="navigation navigation-single">
    
    <a href="/drafts/2020/05/23/maxrampercentage-is-not-what-i-wished-for/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">MaxRamPercentage is not what I wished for</span>
    </a>
    
    
</div>


  

  

</article>


        </div>
        
    










<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin="anonymous"></script>
    <script type="text/javascript">
        
        hljs.initHighlightingOnLoad();
    </script>
    

<script src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js" integrity="sha256-vrn14y7WH7zgEElyQqm2uCGSQrX/xjYDjniRUQx3NyU=" crossorigin="anonymous"></script>
<script type="text/javascript">
function addBlockSwitches() {
	$('.primary').each(function() {
		primary = $(this);
		createSwitchItem(primary, createBlockSwitch(primary)).item.addClass("selected");
		primary.children('.title').remove();
	});
	$('.secondary').each(function(idx, node) {
		secondary = $(node);
		primary = findPrimary(secondary);
		switchItem = createSwitchItem(secondary, primary.children('.switch'));
		switchItem.content.addClass('hidden');
		findPrimary(secondary).append(switchItem.content);
		secondary.remove();
	});
}

function createBlockSwitch(primary) {
	blockSwitch = $('<div class="switch"></div>');
	primary.prepend(blockSwitch);
	return blockSwitch;
}

function findPrimary(secondary) {
	candidate = secondary.prev();
	while (!candidate.is('.primary')) {
		candidate = candidate.prev();
	}
	return candidate;
}

function createSwitchItem(block, blockSwitch) {
	blockName = block.children('.title').text();
	content = block.children('.content').first().append(block.next('.colist'));
	item = $('<div class="switch--item">' + blockName + '</div>');
	blockSwitch.append(item);
	return {'item': item, 'content': content};
}

function globalSwitch() {
	$('.switch--item').each(function() {
		var blockId = blockIdForSwitchItem($(this));
		$(this).off('click');
		$(this).on('click', function() {
			selectedText = $(this).text()
			window.localStorage.setItem(blockId, selectedText);
			$(".switch--item").filter(function() {
				return blockIdForSwitchItem($(this)) === blockId;
			}).filter(function() {
				return $(this).text() === selectedText;
			}).each(function() {
				select($(this))
			});
		});
		if ($(this).text() === window.localStorage.getItem(blockId)) {
			select($(this))
		}
	});
}

function blockIdForSwitchItem(item) {
	idComponents = []
	idComponents.push(item.text().toLowerCase());
	item.siblings(".switch--item").each(function(index, sibling) {
		idComponents.push($(sibling).text().toLowerCase());
	});
	return idComponents.sort().join("-")
}

function select(selected) {
	selected.addClass('selected');
	selected.siblings().removeClass('selected');
	selectedContent = selected.parent().siblings(".content").eq(selected.index())
	selectedContent.removeClass('hidden');
	selectedContent.siblings().addClass('hidden');
}

$(addBlockSwitches);
$(globalSwitch);
</script>


    



    </body>
</html>

