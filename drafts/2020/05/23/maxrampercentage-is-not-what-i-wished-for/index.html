<!DOCTYPE html>
<html lang="en">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.69.0" />

    
    
    

<title>MaxRamPercentage is not what I wished for • The Coffee Workshop</title>













    
<meta property="og:locale" content="en">
<meta property="og:site_name" content="The Coffee Workshop">
<meta property="og:title" content="MaxRamPercentage is not what I wished for">
<meta property="og:type" content="website">
<meta property="og:url" content="https://blog.arkey.fr/drafts/2020/05/23/maxrampercentage-is-not-what-i-wished-for/" />
<meta property="og:description" content="Java mostly, and general tech">
<meta property="og:image" content="https://blog.arkey.fr/social-sharing.png">
<meta property="og:image:type" content="image/png">
    
    
    
<meta property="og:image:width" content="192">
<meta property="og:image:height" content="192">
    

<meta property="og:updated_time" content="2020-05-23T23:45:29&#43;0200">



<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@BriceDutheil">
<meta name="twitter:title" content="MaxRamPercentage is not what I wished for">

<meta name="twitter:image" content="https://blog.arkey.fr/social-sharing.png">

<meta name="twitter:description" content="Java mostly, and general tech">
<meta name="twitter:creator" content="@BriceDutheil">
    
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/github.min.css" media="(prefers-color-scheme: light)"><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/gruvbox-dark.min.css" media="(prefers-color-scheme: dark)">




<link rel="stylesheet" href="/scss/hyde-hyde.1a31c6c24f19035526d72f21fed6609c1c9b78d4f6202d083d987863158f4e0f.css" integrity="sha256-GjHGwk8ZA1Um1y8h/tZgnBybeNT2IC0IPZh4YxWPTg8=">


<link rel="stylesheet" href="/scss/hyde-hyde-dark.ed3355e174ad47eef241d8e787e6571c1a182421442c6e694b1a4dde3364f897.css" integrity="sha256-7TNV4XStR&#43;7yQdjnh&#43;ZXHBoYJCFELG5pSxpN3jNk&#43;Jc=" media="(prefers-color-scheme: dark)">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    
    <link rel="shortcut icon" sizes="192x192" href="/android-192-favicon.png">

    
    <link rel="shortcut icon" href="/android-192-favicon.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css" integrity="sha256-h20CPZ0QyXlBuAw7A+KluUYx/3pK+c7lYEpqLTlxjYQ=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/v4-shims.min.css" integrity="sha256-wN7QJaqAwQ03kgUhyN4EU2phRdDkLrQYbFe0EvpQ60U=" crossorigin="anonymous" />

    
    


    
</head>


    <body class="draft">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://blog.arkey.fr">The Coffee Workshop</a>
      </span>
      
      
        <div class="author-image">
          <img src="https://www.gravatar.com/avatar/f31c7fbcbb0766d0632d96fd7e74b649?s=240&d=mp" class="img--circle img--headshot element--center" alt="gravatar">
        </div>
      
      <p class="site__description">
         Java mostly, and general tech 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">The Coffee Workshop</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/"><span class='fa-icon'><i class='fas fa-home'></i></span><code>cd <em>~</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/posts/"><span class='fa-icon'><i class='fas fa-stream'></i></span><code>ls <em>posts/*</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/series/"><span class='fa-icon'><i class='fas fa-list-alt'></i></span><code>grep -o <em>series</em> posts/* | sort -u</code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/"><span class='fa-icon'><i class='fas fa-tags'></i></span><code>grep -o <em>tags</em> posts/* | sort -u</code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/cool-stuff/"><span class='fa-icon'><i class='fas fa-thumbtack'></i></span><code>cd <em>cool-stuff</em></code>
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/whoami/"><span class='fa-icon'><i class='fas fa-id-card'></i></span><code>whoami</code>
						<span></span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://twitter.com/@BriceDutheil" rel="me"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="bird" class="svg-inline--fa fa-bird fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a>
	
	
	
	<a href="https://github.com/bric3" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="https://speakerdeck.com/bric3" rel="me"><i class="fab fa-speaker-deck" aria-hidden="true"></i></i></a>
	
	
	
	
	
	
	
	<a href="https://linkedin.com/in/dutheilbrice" rel="me"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="pro-network" class="svg-inline--fa fa-pro-network fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></a>
	
	
	<a href="https://stackoverflow.com/users/48136/brice" rel="me"><i class="fab fa-stack-overflow fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
</section>

      </div>
    </div>

  </div>
  <div class="container fixed-container">
    
<div class="copyright">
  &copy; 2010 - 2020 Brice Dutheil
  
    <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>
  
</div>



  </div>
</div>

        <div class="content container">
            
    

<article>
  <header>
    <h1>MaxRamPercentage is not what I wished for</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> 2020-05-23
    
    
    
    
    
    <br/>
    <i class="fas fa-clock"></i> 85 min read

    
    
    

</div>


  </header>
  
  
  
  <div class="post adoc">
    <div class="paragraph">
<p>Like many I was happy to see that the JDK landed support for containers
in Java 9, it was backported to Java 8 too.
Now JDK 11 does this by default and reads information from <code>cgroup`s and
it&#8217;s possible to tell the memory usage via the `-XX:MaxRAMPercentage</code> flag.</p>
</div>
<div class="paragraph">
<p>However in practice this turned out not not working as well as hoped.
Here&#8217;s an issue about a containerized Java 11 web application running on Kubernetes,
at some point in time this application experienced memory  problems.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Problem</div>
<div class="paragraph">
<p>With a RAM percentage parameter at <code>85%</code> of <code>3 GiB</code> memory, the container
metrics showed the application actually hit this limit, which resulted
in killed pods and failing <em>deployment</em> of our <em>replicaset</em>. The deployment
had been set up with an <em>horizontal pod auto-scaler</em> too.</p>
</div>
<div class="paragraph">
<p>We had instances on different datacenter without <code>cgroup</code> that handled well
100% of the traffic with a heap of <code>2 GiB</code>. We migrated half of this traffic
to instances on a Kubernetes cluster that used <code>cgroup</code> limits, the K8s instances
worked well in these conditions. Then when we increased the traffic to 100%
on these new instances the <em>pod</em>s started to get <em>oom killed</em>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p><span class="image"><img src="/assets/maxrampercentage/pod-memory-usage.png" alt="pod memory usage"></span>
<em>The orange line is the pod memory limit, the increasing green line is the
total memory usage of the container <code>container_memory_usage_bytes</code>.</em></p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/assets/maxrampercentage/app-jvm-memory-usage.png" alt="app jvm memory usage"></span>
<em>The blue line is the heap limit <code>3 GiB</code>, the increasing green line
is the application memory or more precisely the <strong>R</strong>esident <strong>S</strong>et <strong>S</strong>ize
(RSS), yellow line is the heap usage.</em></p>
</div>
<div class="paragraph">
<p>While this problem at the surface could have be solved with a lot less information,
this issue served as an excuse to go down the rabbit hole of process memory exploration,
and the JVM in particular.
In doing so the following writing tries to piece together several elements
from a few things I knew, things I grepped in the JDK codebase, blog post, stack overflow,
and things learned from other&#8201;&#8212;&#8201;awesome –- people, all related to the JVM and its
interaction with the Linux OS.</p>
</div>
<div class="paragraph">
<p>I hope I didn&#8217;t ignore important things, I hope I&#8217;m not totally wrong,
or simply I hope I&#8217;m not misguiding myself and especially others. If I&#8217;m wrong
please reach out.</p>
</div>
<div class="paragraph">
<p><em>Now let&#8217;s answer this question: Why does the container use more than <code>MaxRamPercentage</code>
of <code>resourceslimits.memory</code>?</em></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Most of the time, figures will use the <a href="https://en.wikipedia.org/wiki/Binary_prefix">IEC binary notation</a> (<code>1 KiB = 1024 B</code>),
it matches the <a href="https://github.com/corretto/corretto-11/blob/055a9a1a279b9a2953c2150bc937b04f905eeba1/src/src/hotspot/share/utilities/globalDefinitions.hpp#L226">JVM</a>,
our <a href="https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#meaning-of-memory">Kubernetes</a> usage,
and Linux&#8217;s tools (<code>/proc/{pid}/stat</code> or <code>/proc/{pid}/maps</code>, although I could find a reference).</p>
</div>
<div class="paragraph">
<p>Some charts may however use the <a href="https://en.wikipedia.org/wiki/Binary_prefix">metric notation</a> (<code>1 KB = 1000 B</code>).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect1">
<h2 id="_lucky_fixing_the_issue"><a class="anchor" href="#_lucky_fixing_the_issue"></a><a class="link" href="#_lucky_fixing_the_issue">Lucky fixing the issue</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The application that became problematic runs on a Kubernetes cluster. As mentioned above
this application worked fine before, and the people who handled the issue at that time were
not well-prepared, and I certainly wouldn&#8217;t perform much better, so they tried memory limits
until it worked. <code>5 GiB</code> proved to be the lucky number.</p>
</div>
<div class="listingblock">
<div class="title">memory limits in the deployment object of the app</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="yaml" class="language-yaml hljs">apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: java-app
spec:
  template:
    spec:
      containers:
      - name: java-app
        resources:
          limits:
            cpu: "8"
            memory: 5Gi <i class="conum" data-value="1"></i><b>(1)</b>
          requests:
            cpu: "3"
            memory: 3Gi</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The working memory limit.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This works but this is not satisfactory :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>This number is not even a guess, but a brute forced number.</p>
</li>
<li>
<p>This application worked with a <code>2 GiB</code> of heap, <code>5 GiB</code> looks greedy.</p>
</li>
<li>
<p>Again this number is not understood.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_analyze"><a class="anchor" href="#_analyze"></a><a class="link" href="#_analyze">Analyze</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>In order to understand our requirement, and to avoid guessing numbers until it works,
let&#8217;s explore the memory of a java process.</p>
</div>
<div class="paragraph">
<p>The RAM percentage are calculated at JVM startup from a given percentage, via
<code>-XX:InitialRAMPercentage=85.0</code> and <code>-XX:MaxRAMPercentage=85.0</code>, those are the only
memory settings passed to the JVM, then the JVM calculates the following values.
Do not confuse <code>VM.flags</code> which will output parameters calculated from the command line
and <code>VM.command_line</code> which will print the actual command line.</p>
</div>
<div class="listingblock">
<div class="title"><code>VM.flags</code> in k8s</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ jcmd $(pgrep java) VM.flags | tr ' ' '\n'
6:
...
-XX:InitialHeapSize=4563402752 <i class="conum" data-value="3"></i><b>(3)</b>
-XX:InitialRAMPercentage=85.000000 <i class="conum" data-value="1"></i><b>(1)</b>
-XX:MarkStackSize=4194304
-XX:MaxHeapSize=4563402752 <i class="conum" data-value="4"></i><b>(4)</b>
-XX:MaxNewSize=2736783360
-XX:MaxRAMPercentage=85.000000 <i class="conum" data-value="2"></i><b>(2)</b>
-XX:MinHeapDeltaBytes=2097152
-XX:NativeMemoryTracking=summary
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Initial RAM at 85%</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Max RAM at 85%</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Initial heap size ~<code>4.25 GiB</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Max heap size ~<code>4.25 GiB</code></td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_reading_the_memory_footprint_of_the_java_process_in_the_container"><a class="anchor" href="#_reading_the_memory_footprint_of_the_java_process_in_the_container"></a><a class="link" href="#_reading_the_memory_footprint_of_the_java_process_in_the_container">Reading the memory footprint of the java process in the container</a></h3>
<div class="paragraph">
<p>The first thing to look at is the <em>resident set size</em>, it can be obtained in
various ways, e.g. using <code>ps</code>, <code>top</code> or reading the <code>/proc</code> should give the same number
if done at the same time.</p>
</div>
<div class="listingblock primary">
<div class="title"><code>ps</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ ps o pid,rss -p $(pidof java)
PID   RSS
  6 4701120</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title"><code>/proc/{pid}/status</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ cat /proc/$(pgrep java)/status | grep VmRSS
VmRSS:	 4701120 kB</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>4.6 GiB</code> !!! Not quite within the <code>4.25 GiB</code> - 85% of <code>5 GiB</code> - limit. So let&#8217;s dig a
bit to understand this number <code>4701120 KiB</code>.</p>
</div>
<div class="sect3">
<h4 id="_digging_in_the_java_memory_zones"><a class="anchor" href="#_digging_in_the_java_memory_zones"></a><a class="link" href="#_digging_in_the_java_memory_zones">Digging in the java memory zones</a></h4>
<div class="paragraph">
<p>Fortunately the application started with <code>-XX:NativeMemoryTracking=summary</code> which
produces an overview of the different memory zones of a Java process.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Enabling native memory tracking (NMT) causes a 5% to 10% performance overhead.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title"><code>VM.native_memory</code> instant snapshot</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ jcmd $(pgrep java) VM.native_memory scale=KB
6:

Native Memory Tracking:

Total: reserved=7168324KB, committed=5380868KB                               <i class="conum" data-value="1"></i><b>(1)</b>
-                 Java Heap (reserved=4456448KB, committed=4456448KB)        <i class="conum" data-value="2"></i><b>(2)</b>
                            (mmap: reserved=4456448KB, committed=4456448KB)

-                     Class (reserved=1195628KB, committed=165788KB)         <i class="conum" data-value="3"></i><b>(3)</b>
                            (classes #28431)                                 <i class="conum" data-value="4"></i><b>(4)</b>
                            (  instance classes #26792, array classes #1639)
                            (malloc=5740KB #87822)
                            (mmap: reserved=1189888KB, committed=160048KB)
                            (  Metadata:   )
                            (    reserved=141312KB, committed=139876KB)
                            (    used=135945KB)
                            (    free=3931KB)
                            (    waste=0KB =0.00%)
                            (  Class space:)
                            (    reserved=1048576KB, committed=20172KB)
                            (    used=17864KB)
                            (    free=2308KB)
                            (    waste=0KB =0.00%)

-                    Thread (reserved=696395KB, committed=85455KB)
                            (thread #674)
                            (stack: reserved=692812KB, committed=81872KB)    <i class="conum" data-value="5"></i><b>(5)</b>
                            (malloc=2432KB #4046)
                            (arena=1150KB #1347)

-                      Code (reserved=251877KB, committed=105201KB)          <i class="conum" data-value="6"></i><b>(6)</b>
                            (malloc=4189KB #11718)
                            (mmap: reserved=247688KB, committed=101012KB)

-                        GC (reserved=230739KB, committed=230739KB)          <i class="conum" data-value="7"></i><b>(7)</b>
                            (malloc=32031KB #63631)
                            (mmap: reserved=198708KB, committed=198708KB)

-                  Compiler (reserved=5914KB, committed=5914KB)              <i class="conum" data-value="8"></i><b>(8)</b>
                            (malloc=6143KB #3281)
                            (arena=18014398509481755KB #5)

-                  Internal (reserved=24460KB, committed=24460KB)           <i class="conum" data-value="10"></i><b>(10)</b>
                            (malloc=24460KB #13140)

-                     Other (reserved=267034KB, committed=267034KB)         <i class="conum" data-value="11"></i><b>(11)</b>
                            (malloc=267034KB #631)

-                    Symbol (reserved=28915KB, committed=28915KB)            <i class="conum" data-value="9"></i><b>(9)</b>
                            (malloc=25423KB #330973)
                            (arena=3492KB #1)

-    Native Memory Tracking (reserved=8433KB, committed=8433KB)
                            (malloc=117KB #1498)
                            (tracking overhead=8316KB)

-               Arena Chunk (reserved=217KB, committed=217KB)
                            (malloc=217KB)

-                   Logging (reserved=7KB, committed=7KB)
                            (malloc=7KB #266)

-                 Arguments (reserved=19KB, committed=19KB)
                            (malloc=19KB #521)

-                    Module (reserved=1362KB, committed=1362KB)
                            (malloc=1362KB #6320)

-              Synchronizer (reserved=837KB, committed=837KB)
                            (malloc=837KB #6877)

-                 Safepoint (reserved=8KB, committed=8KB)
                            (mmap: reserved=8KB, committed=8KB)

-                   Unknown (reserved=32KB, committed=32KB)
                            (mmap: reserved=32KB, committed=32KB)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This shows a <code>reserved</code> value (<code>7168324 KiB</code> (~<code>6.84 GiB</code>)), it&#8217;s the amount of addressable memory
(all OS types) on that container, and a <code>committed</code> value (<code>4456448 KiB</code> (~<code>4.25 GiB</code>)) that represents
what the JVM actually told the OS to allocate.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>Heap</code> zone, note reserved and committed values are the same <code>4456448 KiB</code> here because our
<code>InitialRAMPercentage</code> is the same as max. I&#8217;m not sure why this number is different from the VM
flags <code>-XX:MaxHeapSize=4563402752</code> though.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>~<code>162 MiB</code> of metaspace</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>How many classes have been loaded : <code>28431</code></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>There are 674 threads that are using ~<code>80 MiB</code> and could use up to ~<code>676 MiB</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td><code>Code</code> cache area (assembly of the used methods) ~<code>102 MiB</code> out of ~<code>246 MiB</code> which matches with <code>-XX:ReservedCodeCacheSize=251658240</code></td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>This is app is using G1GC, this section contains <code>GC</code> internal data structures which takes ~<code>225 MiB</code></td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>C1 / C2 compilers (which compile bytecode to assembly) uses ~<code>5.8 MiB</code></td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>The <code>Symbol</code> section contains many things like interned strings and other internal constants ~<code>28.2 MiB</code></td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td><code>Internal</code> (includes <code>DirectByteBuffers</code> before Java 11), maybe others objects, here takes ~<code>24 MiB</code></td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td><code>Other</code> section after Java 11 includes <code>DirectByteBuffers</code> ~<code>261 MiB</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The remaining areas are much smaller in scale, NMT takes ~<code>8.2 MiB</code> itself, module system usage ~<code>1.3 MiB</code>,
etc. Also, note that enabling other JVM features may show up if they are activated.
<a href="https://docs.oracle.com/en/java/javase/11/troubleshoot/diagnostic-tools.html#GUID-5EF7BB07-C903-4EBD-A9C2-EC0E44048D37">Source</a></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>At the time this report was executed the committed memory is <code>5380868 KiB</code> (<code>5.13 GiB</code>) while
the process RSS is <code>4701120 KiB</code>. The difference relates to how <code>mmap</code> works (on Linux), memory
pages are only backed by physical memory once they&#8217;re written to.</p>
</div>
<div class="paragraph">
<p>Some people may have heard of the <code>-XX:+AlwaysPreTouch</code> Hotspot option. This option tells
the JVM to always write zeros to memory pages (which has the effect of reducing physical memory
commit latencies), but this option only affects the heap memory allocations. Other zones like
thread stack or metaspace work differently, that means some <strong>committed</strong> memory shown in NMT is not
<strong>resident</strong> and not accounted for by the RSS counter.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s some memory related vocabulary that help distinguish between memory <em>statuses</em> :</p>
</div>
<table class="tableblock frame-all grid-all fit-content stretch">
<caption class="title">Table 1. vocabulary breakdown</caption>
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Used Heap</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The amount of memory occupied by live objects according.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Committed</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Address ranges that have been mapped with something other than <code>PROT_NONE</code>.
They may or may not be backed by physical or swap due to lazy allocation and paging.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Reserved</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The total address range that has been pre-mapped via <code>mmap</code> for a particular memory pool.
The <em>reserved</em> / <em>committed</em> difference consists of <code>PROT_NONE</code> mappings, which are guaranteed to not be backed
by physical memory</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Resident</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pages which are currently in physical ram. This means code, stacks, part of the committed memory
pools but also portions of <code>mmap</code>ed files which have recently been accessed and allocations outside the control
of the JVM.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Virtual</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The sum of all virtual address mappings. Covers committed, reserved memory pools but also mapped
files or shared memory. This number is rarely informative since the JVM can reserve very large address
ranges in advance or mmap large files.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a href="https://stackoverflow.com/a/31178912/48136">source</a></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There&#8217;s a lot more to read on the
<a href="https://docs.oracle.com/en/java/javase/11/vm/native-memory-tracking.html#GUID-39676837-DA61-4F8D-9C5B-9DB1F5147D80">official documentation about NMT</a>
and <a href="https://docs.oracle.com/en/java/javase/11/troubleshoot/diagnostic-tools.html#GUID-1F53A50E-86FF-491D-A023-8EC4F1D1AC77">how to Monitor VM Internal Memory</a>.</p>
</div>
<div class="paragraph">
<p>And another worthwhile read on <a href="https://shipilev.net/jvm/anatomy-quarks/12-native-memory-tracking/">native memory tracking</a>
by <a href="http://twitter.com/shipilev">Aleksey Shipilёv</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_explore_what_nmt_does_not_show"><a class="anchor" href="#_explore_what_nmt_does_not_show"></a><a class="link" href="#_explore_what_nmt_does_not_show">Explore what NMT does not show</a></h4>
<div class="paragraph">
<p>There&#8217;s also the <code>MappedByteBuffers</code>, these are the files mapped to virtual memory of a process.
NMT does not track them, however, <code>MappedByteBuffers</code> can also take physical memory. It&#8217;s possible
to see the actual usage of a process memory map: <code>pmap -x &lt;pid&gt;</code></p>
</div>
<div class="listingblock">
<div class="title">process memory mappings</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ pmap -x $(pgrep java)
6:   /usr/bin/java -Dfile.encoding=UTF-8 -Duser.timezone=UTC -Djava.security.egd=file:/dev/./urandom
-XX:InitialRAMPercentage=85.0 -XX:MaxRAMPercentage=85.0 -XX:NativeMemoryTracking=summary
-Xlog:os,safepoint*,gc*,gc+ref=debug,gc+ergo*=debug,gc+age*=debug,gc+phases*:file=/gclogs/%t-gc.log:time,uptime,tags:filecount=5,filesize=10M -javaag
Address           Kbytes     RSS   Dirty Mode  Mapping
0000000000400000       4       4       0 r-x-- java
0000000000600000       4       4       4 r---- java
0000000000601000       4       4       4 rw--- java
000000000216f000     404     272     272 rw---   [ anon ]
00000006f0000000 4476620 3128252 3128252 rw---   [ anon ]
00000008013b3000 1028404       0       0 -----   [ anon ]
00007fc5de9ea000      16       0       0 -----   [ anon ]
00007fc5de9ee000    1012     104     104 rw---   [ anon ]
00007fc5deaeb000      16       0       0 -----   [ anon ]
00007fc5deaef000    1012      24      24 rw---   [ anon ]
00007fc5debec000      16       0       0 -----   [ anon ]
00007fc5debf0000    1012      92      92 rw---   [ anon ]
00007fc5deced000      16       0       0 -----   [ anon ]
00007fc5decf1000    1012     100     100 rw---   [ anon ]
00007fc5dedee000      16       0       0 -----   [ anon ]
00007fc5dedf2000    1012     100     100 rw---   [ anon ]
00007fc5deeef000      16       0       0 -----   [ anon ]
00007fc5deef3000    1012     100     100 rw---   [ anon ]
00007fc5deff0000      16       0       0 -----   [ anon ]
00007fc5deff4000    1012     100     100 rw---   [ anon ]
00007fc5df0f1000      16       0       0 -----   [ anon ]
00007fc5df0f5000    1012     100     100 rw---   [ anon ]
00007fc5df1f2000      16       0       0 -----   [ anon ]
00007fc5df1f6000    1012     100     100 rw---   [ anon ]
00007fc5df2f3000      16       0       0 -----   [ anon ]
00007fc5df2f7000    1012     100     100 rw---   [ anon ]
00007fc5df3f4000      16       0       0 -----   [ anon ]
00007fc5df3f8000    1012     100     100 rw---   [ anon ]
00007fc5df4f5000      16       0       0 -----   [ anon ]
00007fc5df4f9000    1012     100     100 rw---   [ anon ]
00007fc5df5f6000      16       0       0 -----   [ anon ]
00007fc5df5fa000    1012     100     100 rw---   [ anon ]

...

00007fca48ba9000   17696   14876       0 r-x-- libjvm.so
00007fca49cf1000    2044       0       0 ----- libjvm.so
00007fca49ef0000     764     764     764 r---- libjvm.so
00007fca49faf000     232     232     208 rw--- libjvm.so
00007fca49fe9000     352     320     320 rw---   [ anon ]
00007fca4a041000     136     136       0 r---- libc-2.28.so
00007fca4a063000    1312    1140       0 r-x-- libc-2.28.so
00007fca4a1ab000     304     148       0 r---- libc-2.28.so
00007fca4a1f7000       4       0       0 ----- libc-2.28.so
00007fca4a1f8000      16      16      16 r---- libc-2.28.so
00007fca4a1fc000       8       8       8 rw--- libc-2.28.so
00007fca4a1fe000      16      16      16 rw---   [ anon ]
00007fca4a202000       4       4       0 r---- libdl-2.28.so
00007fca4a203000       4       4       0 r-x-- libdl-2.28.so
00007fca4a204000       4       4       0 r---- libdl-2.28.so
00007fca4a205000       4       4       4 r---- libdl-2.28.so
00007fca4a206000       4       4       4 rw--- libdl-2.28.so
00007fca4a207000     100     100       0 r-x-- libjli.so
00007fca4a220000    2048       0       0 ----- libjli.so
00007fca4a420000       4       4       4 r---- libjli.so
00007fca4a421000       4       4       4 rw--- libjli.so
00007fca4a422000      24      24       0 r---- libpthread-2.28.so
00007fca4a428000      60      60       0 r-x-- libpthread-2.28.so
00007fca4a437000      24       0       0 r---- libpthread-2.28.so
00007fca4a43d000       4       4       4 r---- libpthread-2.28.so
00007fca4a43e000       4       4       4 rw--- libpthread-2.28.so
00007fca4a43f000      16       4       4 rw---   [ anon ]
00007fca4a443000       4       4       0 r---- LC_IDENTIFICATION
00007fca4a444000       4       0       0 -----   [ anon ]
00007fca4a445000       4       0       0 r----   [ anon ]
00007fca4a446000       8       8       8 rw---   [ anon ]
00007fca4a448000       4       4       0 r---- ld-2.28.so
00007fca4a449000     120     120       0 r-x-- ld-2.28.so
00007fca4a467000      32      32       0 r---- ld-2.28.so
00007fca4a46f000       4       4       4 r---- ld-2.28.so
00007fca4a470000       4       4       4 rw--- ld-2.28.so
00007fca4a471000       4       4       4 rw---   [ anon ]
00007ffe28536000     140      40      40 rw---   [ stack ]
00007ffe28582000      12       0       0 r----   [ anon ]
00007ffe28585000       8       4       0 r-x--   [ anon ]
ffffffffff600000       4       0       0 r-x--   [ anon ]
---------------- ------- ------- -------
total kB         24035820 4776860 4720796</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s refine that with more
<a href="https://www.kernel.org/doc/Documentation/filesystems/proc.txt">knowledge about <code>/proc/{pid}/maps</code></a>,
it indicates that a <em>map</em> has a set of modes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>r-</code>: readable memory mapping</p>
</li>
<li>
<p><code>w</code>: writable memory mapping</p>
</li>
<li>
<p><code>x</code>: executable memory mapping</p>
</li>
<li>
<p><code>s</code> or <code>p</code> : shared memory mapping or private mapping. <code>/proc/&lt;pid&gt;/maps</code> shows both
but <code>pmap</code> only show the <code>s</code> flag.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>On a side note, <code>pmap</code> may show another mapping mode which I barely found any reference of,
here&#8217;s <a href="https://johanlouwers.blogspot.com/2017/07/oracle-linux-understanding-linux.html">one</a>
and <a href="https://linux.die.net/man/2/mmap">here</a></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>R</code>: if set, the map has no swap space reserved (<code>MAP_NORESERVE</code> flag of <code>mmap</code>).
This means that we can get a segmentation fault by accessing that memory if it has not
already been mapped to physical memory, and if the system is out of physical memory.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>At this time the focus is to see what are the memory mapped files with the JVM. Those can be either
read from or written to, we need to look for both the <code>r</code> or <code>w</code> or neither, also while quite unlikely
with Java let&#8217;s not restrict on the <em>executable</em> mapping, so the only thing we could be restricting to
is the shared mapping <code>s</code> (memory mapped files are shared because the OS may want to reuse the afferent
memory pages for other processes) :</p>
</div>
<div class="listingblock">
<div class="title">Our application memory mapped files</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ pmap -x 6 | grep "[r-][w-][x-][s][R-]"
00007f5fdc02f000       4       4       0 r--s- instrumentation1647616515145161084.jar
00007f5fdc030000       4       4       0 r--s- instrumentation11262564974060761935.jar
00007f5fdc053000       8       8       0 r--s- java-agent-bs-cl.jar
00007f5fdc055000       4       4       0 r--s- instrumentation249633448216144460.jar
00007f5fdc056000       4       4       0 r--s- agent1-bootstrap10447345921091566771.jar
00007f5fdc057000      12      12       0 r--s- agent1-api6038277081136135384.jar
00007f5fec000000       8       8       0 r--s- agent1-weaver-api16247655721253674284.jar
00007f5fec002000       4       4       0 r--s- agent1-opentracing-bridge12060425782296980104.jar
00007f5fec003000      12      12       0 r--s- agent2-bridge3261511391751138774.jar
00007f5ffb910000  138176   36060       0 r--s- modules
00007f6008006000      28      28       0 r--s- gconv-modules.cache
                           ^^^^^               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</code></pre>
</div>
</div>
<div class="paragraph">
<p>There&#8217;s around <code>35.2 MiB</code> of memory mapped files.</p>
</div>
<div class="paragraph">
<p><em>As I was a bit unfamiliar with <code>pmap</code>, reading <a href="https://techtalk.intersec.com/2013/07/memory-part-2-understanding-process-memory/">this process memory blog</a>
helped me with the above command.</em></p>
</div>
<div class="paragraph">
<p>Wrapping this information from NMT and memory mapped files leaves us with the
following <em>equation</em> to estimate the actual memory usage of a process:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Total memory = Heap + GC + Metaspace + Code Cache + Symbol tables
               + Compiler + Other JVM structures + Thread stacks
               + Direct buffers + Mapped files +
               + Native Libraries + Malloc overhead + ...</pre>
</div>
</div>
<table class="tableblock frame-all grid-all fit-content stretch">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Heap</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4456448</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">230739</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Metaspace</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">165788</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Code Cache</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">105201</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Symbol tables</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">28915</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Compiler</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5914</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Other JVM structures
(Internal + NMT + smaller area)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">24460 + 8433 + 217 + 7 + 19 + 1362 + 837 + 8 + 32</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Thread stacks</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">85455</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Direct buffers (Other)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">267034</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mapped files</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">36060 + 4 + 4 + 8 + 4 + 4 + 12 + 8 + 4 + 12 + 28</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Native Libraries</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">unaccounted at this time</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Malloc overhead</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">accounted in NMT</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8230;&#8203;</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
<tfoot>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Total</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5242880 KiB</p></td>
</tr>
</tfoot>
</table>
<div class="paragraph">
<p><code>5186278 KiB</code> is what this container is actually using, so way over the RSS (<code>4701120 KiB</code>)
but also over the <code>5 GiB</code> (<code>5242880 KiB</code>) of the pod limit. Yet this pod is healthy and far from
the thresholds to be oom killed.</p>
</div>
<div class="paragraph">
<p><strong>So what I am missing here ?</strong></p>
</div>
<div class="paragraph">
<p>There a few considerations to understand :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>NMT shows <em>reserved</em> and <em>committed</em> values on each areas,</p>
<table class="tableblock frame-all grid-all fit-content stretch">
<colgroup>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>reserved</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">this is the size that the OS guarantees to be available (but the
JVM didn&#8217;t tell the OS to allocate this memory)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>committed</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">this size indicate the memory that the JVM allocated on the OS</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Each of these memory zones are managed differently: <code>GC</code>, <code>Compiler</code> have the
same committed and reserved memory values while other zones have the ability to
shrink or grow for example <code>thread stacks</code> zone reports
<code>85455 KiB</code> but could take up to <code>696395 KiB</code> if necessary, and theoretically
same as the heap.</p>
</div>
</li>
<li>
<p>While the JVM did allocate this memory, Linux on x86 hardware uses virtual
memory with paging. More specifically Linux optimizes actual physical memory
and only commits a page physically if this page is actually written to. In this
case the <code>Heap</code> zone in particular seems to benefit from this behavior as the JVM
allocated <code>4456448 KiB</code>, but the actual RAM <em>resident set size</em> usage of this memory
zone seems at this time is <code>3128252 KiB</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Where to look for this number? While it&#8217;s easy to get the RSS of a process, to understand
if the committed heap actually <em>resides</em> on physical memory you need to use <code>pmap</code> or
inspect <code>/proc/{pid}/maps</code> or <code>/proc/{pid}/smaps</code>. You have to notice the one of the first
memory zones is quite big and about the size of the committed heap as shown in NMT. It&#8217;s easier
to spot with <code>pmap -X</code> (capital <code>X</code>). <em>Note the captures below are from a different pod/process</em>.</p>
</div>
<div class="listingblock primary">
<div class="title"><code>pmap -x &lt;pid&gt;</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ pmap -x $(pidof java) | less -S -X
6:   /usr/bin/java -Dfile.encoding=UTF-8 -Duser.timezone=UTC -Djava.security.egd=file:/dev/./urandom
Address           Kbytes     RSS   Dirty Mode  Mapping
0000000000400000       4       4       0 r-x-- java
0000000000600000       4       4       4 r---- java
0000000000601000       4       4       4 rw--- java
0000000001cfc000     412     224     224 rw---   [ anon ]
00000006f0000000 4477472 2944744 2944744 rw---   [ anon ] <i class="conum" data-value="1"></i><b>(1)</b>
0000000801488000 1027552       0       0 -----   [ anon ]
00007f11b3744000   16388   16388   16388 rw---   [ anon ]
00007f11b4745000      16       0       0 -----   [ anon ]
00007f11b4749000   50688   49484   49484 rw---   [ anon ]
00007f11b78c9000    1536       0       0 -----   [ anon ]
00007f11b7a49000   32776   32776   32776 rw---   [ anon ]
00007f11b9a4b000      16       0       0 -----   [ anon ] <i class="conum" data-value="2"></i><b>(2)</b>
00007f11b9a4f000    1012      24      24 rw---   [ anon ] <i class="conum" data-value="3"></i><b>(3)</b>
00007f11b9b4c000      16       0       0 -----   [ anon ]
00007f11b9b50000    1012      92      92 rw---   [ anon ]
00007f11b9c4d000      16       0       0 -----   [ anon ]
00007f11b9c51000    1012     116     116 rw---   [ anon ]
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>heap memory</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>a thread guard pages</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>a thread stack</td>
</tr>
</table>
</div>
<div class="listingblock secondary">
<div class="title"><code>pmap- X &lt;pid&gt;</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ pmap -X $(pidof java) | less -S -X
6:   /usr/bin/java -Dfile.encoding=UTF-8 -Duser.timezone=UTC -Djava.security.egd=file:/dev/./urandom -XX:InitialRAMPercentage=85.0 -XX:MaxRAMPercentage=85.0 -XX:NativeMemoryTracking=summary
         Address Perm   Offset Device   Inode     Size     Rss     Pss Referenced Anonymous LazyFree ShmemPmdMapped Shared_Hugetlb Private_Hugetlb Swap SwapPss Locked THPeligible Mapping
        00400000 r-xp 00000000  08:01 4054960        4       4       1          4         0        0              0              0               0    0       0      0           0 java
        00600000 r--p 00000000  08:01 4054960        4       4       4          4         4        0              0              0               0    0       0      0           0 java
        00601000 rw-p 00001000  08:01 4054960        4       4       4          4         4        0              0              0               0    0       0      0           0 java
        01cfc000 rw-p 00000000  00:00       0      412     224     224        224       224        0              0              0               0    0       0      0           0 [heap] <i class="conum" data-value="1"></i><b>(1)</b>
       6f0000000 rw-p 00000000  00:00       0  4477472 2939592 2939592    2939592   2939592        0              0              0               0    0       0      0           0
       801488000 ---p 00000000  00:00       0  1027552       0       0          0         0        0              0              0               0    0       0      0           0
    7f11b4745000 ---p 00000000  00:00       0       16       0       0          0         0        0              0              0               0    0       0      0           0
    7f11b4749000 rw-p 00000000  00:00       0    50688   49472   49472      49472     49472        0              0              0               0    0       0      0           0
    7f11b78c9000 ---p 00000000  00:00       0     1536       0       0          0         0        0              0              0               0    0       0      0           0
    7f11b7a49000 rw-p 00000000  00:00       0    32776   32776   32776      32776     32776        0              0              0               0    0       0      0           0
    7f11b9a4b000 ---p 00000000  00:00       0       16       0       0          0         0        0              0              0               0    0       0      0           0        <i class="conum" data-value="2"></i><b>(2)</b>
    7f11b9a4f000 rw-p 00000000  00:00       0     1012     112     112        112       112        0              0              0               0    0       0      0           0        <i class="conum" data-value="3"></i><b>(3)</b>
    7f11b9b4c000 ---p 00000000  00:00       0       16       0       0          0         0        0              0              0               0    0       0      0           0
    7f11b9b50000 rw-p 00000000  00:00       0     1012      96      96         96        96        0              0              0               0    0       0      0           0
    7f11b9c4d000 ---p 00000000  00:00       0       16       0       0          0         0        0              0              0               0    0       0      0           0
    7f11b9c51000 rw-p 00000000  00:00       0     1012     116     116        116       116        0              0              0               0    0       0      0           0
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>heap memory</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>a thread guard pages</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>a thread stack</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_going_back_to_choose_a_better_value_for_the_ram_percentage"><a class="anchor" href="#_going_back_to_choose_a_better_value_for_the_ram_percentage"></a><a class="link" href="#_going_back_to_choose_a_better_value_for_the_ram_percentage">Going back to choose a better value for the RAM percentage</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>From the above, it&#8217;s now possible with NMT especially and with <code>pmap</code> to
understand actual memory usage and to answer the question: "What is a sensible
RAM percentage setting for this application ?"</p>
</div>
<div class="paragraph">
<p>Really what drive the answer is the actual non-heap usage not accounted in
<code>MaxRAMPercentage</code>, from the numbers above:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(total) 5242880 - (heap) 4456448 = 786432 KiB</pre>
</div>
</div>
<table class="tableblock frame-all grid-all fit-content stretch">
<caption class="title">Table 2. In percentages</caption>
<colgroup>
<col>
<col>
<col>
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Non heap</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5242880 - 4456448 = 786432</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">~14 %</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Heap</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4456448</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">~86 %</p></td>
</tr>
</tbody>
<tfoot>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Total</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5186278</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">100 %</p></td>
</tr>
</tfoot>
</table>
<div class="paragraph">
<p><strong>This means the application needs around <code>790 MiB</code>, plus the heap to run.</strong></p>
</div>
<div class="paragraph">
<p>From the flags seen above, the JVM set the heap maximum size memory to <code>4 563 402 752</code> Bytes,
this value was computed from this flag <code>-XX:MaxRAMPercentage=85.000000</code>, and this percentage
is somehow a lucky guess that worked for the <code>5 GiB</code> deployment memory limit.
But this actual percentage is in fact <em>wrong</em>, if the JVM needed all the memory within the max
heap plus bigger stack traces then the container/pod would have been <em>oom killed</em>. Also, it is
necessary to give some free space in the container
to be able to perform serviceability tasks, like profiling, heap dump, etc.</p>
</div>
<div class="paragraph">
<p>For a <code>5 GiB</code> limit it may be good to give around 20% for all of these non-heap, plus system space
for this particular workload (e.g. if the application requires heavy filesystem usage, then
it would be a different number to make room for the filesystem cache).</p>
</div>
<div class="paragraph">
<p>So the problem would be solved with the following value, for a <code>5 GiB</code> memory limit :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">-XX:InitialRAMPercentage=80.0 <i class="conum" data-value="1"></i><b>(1)</b>
-XX:MaxRAMPercentage=80.0 <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="paragraph">
<p>For a quick win let&#8217;s adapt the application image.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_make_the_docker_image_memory_settings_tweakable_per_environment"><a class="anchor" href="#_make_the_docker_image_memory_settings_tweakable_per_environment"></a><a class="link" href="#_make_the_docker_image_memory_settings_tweakable_per_environment">Make the docker image memory settings tweakable per environment</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>As seen at the beginning of this post, RAM settings are part of the command declaration, this
is not suitable as seen above. In addition, the deployment requirements / limits are likely to
differ depending on the cluster / environment. One good reason would be to decrease the money spending
on your cloud provider for non-production clusters, like staging, pre-production, etc.
It will be useful to enable flexibility one setting the application for any given environment.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s use <a href="https://docs.oracle.com/en/java/javase/11/troubleshoot/diagnostic-tools.html#GUID-0A40ECEE-AFDF-48CB-AF7C-A33DDE07A8DC"><code>JDK_JAVA_OPTIONS</code></a>
environment variable to enable flexibility and remove the RAM percentage in the <code>CMD</code> directive.</p>
</div>
<div class="listingblock">
<div class="title">Application dockerfile</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="diff" class="language-diff hljs">  ARG REGISTRY
  FROM $REGISTRY/corretto-java:11.0.6.10.1
+ ENV JDK_JAVA_OPTIONS="" <i class="conum" data-value="1"></i><b>(1)</b>

  RUN mkdir -p /gclogs /etc/java-app

  COPY ./build/libs/java-app-boot.jar \
    ./build/java-agents/agent-1.jar \
    ./build/java-agents/agent-2.jar \
    ./src/serviceability/*.sh \
    /

  CMD [ "/usr/bin/java", \
        "-Dfile.encoding=UTF-8", \
        "-Duser.timezone=UTC", \
        "-Dcom.sun.management.jmxremote.port=7199", \
        "-Dcom.sun.management.jmxremote.rmi.port=7199", \
        "-Dcom.sun.management.jmxremote.ssl=false", \
        "-Dcom.sun.management.jmxremote.authenticate=false", \
        "-Djava.security.egd=file:/dev/./urandom", \
-       "-XX:InitialRAMPercentage=85.0", \ <i class="conum" data-value="2"></i><b>(2)</b>
-       "-XX:MaxRAMPercentage=85.0", \
        "-XX:NativeMemoryTracking=summary", \
        "-Xlog:os,safepoint*,gc*,gc+ref=debug,gc+ergo*=debug,gc+age*=debug,gc+phases*:file=/gclogs/%t-gc.log:time,uptime,tags:filecount=5,filesize=10M", \
        "-javaagent:/agent-1.jar", \
        "-javaagent:/agent-2.jar", \
        "-Dsqreen.config_file=/sqreen.properties", \
        "-jar", \
        "/java-app-boot.jar", \
        "--spring.config.additional-location=/etc/java-app/config.yaml", \
        "--server.port=8080" ]

  LABEL name="java-app"
  LABEL build_path="../"
  LABEL version_auto_semver="true"</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Defines the <a href="https://docs.oracle.com/en/java/javase/11/troubleshoot/diagnostic-tools.html#GUID-0A40ECEE-AFDF-48CB-AF7C-A33DDE07A8DC"><code>JDK_JAVA_OPTIONS</code></a></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Removes the RAM percentage settings to get <em>default</em> values.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now let&#8217;s test this locally to play a bit.</p>
</div>
<div class="listingblock">
<div class="title">Build the container</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">❯ DOCKER_BUILDKIT=1 docker build \
  --tag test-java-app \ <i class="conum" data-value="1"></i><b>(1)</b>
  --build-arg REGISTRY=eu.gcr.io/cd-registry \
  --file _infra/Dockerfile \
  .
[+] Building 1.4s (9/9) FINISHED
 =&gt; [internal] load build definition from Dockerfile                                                                                              0.0s
 =&gt; =&gt; transferring dockerfile: 1.34kB                                                                                                            0.0s
 =&gt; [internal] load .dockerignore                                                                                                                 0.0s
 =&gt; =&gt; transferring context: 35B                                                                                                                  0.0s
 =&gt; [internal] load metadata for eu.gcr.io/cd-registry/corretto-java:11.0.6.10.1                                                                  0.0s
 =&gt; CACHED [1/4] FROM eu.gcr.io/cd-registry/corretto-java:11.0.6.10.1                                                                             0.0s
 =&gt; [internal] load build context                                                                                                                 0.0s
 =&gt; =&gt; transferring context: 1.32kB                                                                                                               0.0s
 =&gt; [2/4] RUN mkdir -p /gclogs /etc/java-app                                                                                                      0.3s
 =&gt; [3/4] COPY ./build/async-profiler/linux-x64 /async-profiler                                                                                   0.0s
 =&gt; [4/4] COPY ./build/libs/java-app-boot.jar   ./build/java-agents/agent-1.jar   ./build/java-agents/agent-2.jar   ./src/serviceability/*.sh   / 0.6s
 =&gt; exporting to image                                                                                                                            0.4s
 =&gt; =&gt; exporting layers                                                                                                                           0.4s
 =&gt; =&gt; writing image sha256:5ceef8f5a4e23cb3bea7ca7cb7c90c0e338386b7f37992c92861cb119c312cb9                                                      0.0s
 =&gt; =&gt; naming to docker.io/library/test-java-app</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Custom tag to avoid collision with regular images in my cache</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Run the container with the Java app</p>
</div>
<div class="listingblock primary">
<div class="title"><strong>Without</strong> <code>JDK_JAVA_OPTIONS</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">❯ docker run --rm --memory="3gb" --name j-mem test-java-app
Picked up JDK_JAVA_OPTIONS:
10:14:53.566 [main] INFO org.springframework.core.KotlinDetector - Kotlin reflection implementation not found at runtime, related features won't be available.
2020-03-20 10:14:55.616 [] WARN  --- [kground-preinit] o.s.h.c.j.Jackson2ObjectMapperBuilder    : For Jackson Kotlin classes support please add "com.fasterxml.jackson.module:jackson-module-kotlin" to the classpath
...</code></pre>
</div>
</div>
<div class="listingblock secondary">
<div class="title"><strong>With</strong> <code>JDK_JAVA_OPTIONS</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">❯ docker run --rm --memory="3gb" --env JDK_JAVA_OPTIONS="-XX:InitialRAMPercentage=70.0 -XX:MaxRAMPercentage=70.0" --name j-mem test-java-app
Picked up JDK_JAVA_OPTIONS: -XX:InitialRAMPercentage=70.0 -XX:MaxRAMPercentage=70.0
10:14:53.566 [main] INFO org.springframework.core.KotlinDetector - Kotlin reflection implementation not found at runtime, related features won't be available.
2020-03-20 10:14:55.616 [] WARN  --- [kground-preinit] o.s.h.c.j.Jackson2ObjectMapperBuilder    : For Jackson Kotlin classes support please add "com.fasterxml.jackson.module:jackson-module-kotlin" to the classpath
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we can make sure we have the correct flags.</p>
</div>
<div class="listingblock primary">
<div class="title"><strong>Without</strong> <code>JDK_JAVA_OPTIONS</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">❯ docker exec -it j-mem bash -c "jcmd \$(pgrep java) VM.flags | tr ' ' '\n'"
6:
-XX:CICompilerCount=3
-XX:ConcGCThreads=1
-XX:G1ConcRefinementThreads=4
-XX:G1HeapRegionSize=1048576
-XX:GCDrainStackTargetSize=64
-XX:InitialHeapSize=50331648
-XX:MarkStackSize=4194304
-XX:MaxHeapSize=805306368 <i class="conum" data-value="1"></i><b>(1)</b>
-XX:MaxNewSize=482344960
-XX:MinHeapDeltaBytes=1048576
-XX:NativeMemoryTracking=summary
-XX:NonNMethodCodeHeapSize=5830732
-XX:NonProfiledCodeHeapSize=122913754
-XX:ProfiledCodeHeapSize=122913754
-XX:ReservedCodeCacheSize=251658240
-XX:+SegmentedCodeCache
-XX:+UseCompressedClassPointers
-XX:+UseCompressedOops
-XX:+UseFastUnorderedTimeStamps
-XX:+UseG1GC</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Max heap is about <code>768 MiB</code></td>
</tr>
</table>
</div>
<div class="listingblock secondary">
<div class="title"><strong>With</strong> <code>JDK_JAVA_OPTIONS</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">❯ docker exec -it j-mem bash -c "jcmd \$(pgrep java) VM.flags | tr ' ' '\n'"
6:
-XX:CICompilerCount=3
-XX:ConcGCThreads=1
-XX:G1ConcRefinementThreads=4
-XX:G1HeapRegionSize=1048576
-XX:GCDrainStackTargetSize=64
-XX:InitialHeapSize=2256535552
-XX:InitialRAMPercentage=70.000000
-XX:MarkStackSize=4194304
-XX:MaxHeapSize=2256535552 <i class="conum" data-value="1"></i><b>(1)</b>
-XX:MaxNewSize=1353711616
-XX:MaxRAMPercentage=70.000000
-XX:MinHeapDeltaBytes=1048576
-XX:NativeMemoryTracking=summary
-XX:NonNMethodCodeHeapSize=5830732
-XX:NonProfiledCodeHeapSize=122913754
-XX:ProfiledCodeHeapSize=122913754
-XX:ReservedCodeCacheSize=251658240
-XX:+SegmentedCodeCache
-XX:+UseCompressedClassPointers
-XX:+UseCompressedOops
-XX:+UseFastUnorderedTimeStamps
-XX:+UseG1GC</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Max heap is about <code>2.1 GiB</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Notice when there&#8217;s no RAM settings the JVM computed the max heap size at 25%
of memory constraints <code>3 GiB</code>. And to 80%, <code>2.1 GiB</code>, of the same limit when
passing the RAM percentages. Also, the heap values are the only one affected,
other memory areas default values kept the same values.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_going_further"><a class="anchor" href="#_going_further"></a><a class="link" href="#_going_further">Going further</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>As a reminder this application was set up with 85% max heap when the
deployment limit was <code>3 GiB</code>, it worked well under 50% of the traffic but failed with full traffic.
Then this pod memory limit was bumped to <code>5 GiB</code> and the pod wasn&#8217;t anymore oomkilled.
How this <em>limit</em> was found is a lucky guess, given the RAM percentages were set in the <code>CMD</code>
directive of the Dockerfile.</p>
</div>
<div class="paragraph">
<p>As identified above there are two, maybe three memory areas whose usage may explain the surge in memory before
the memory limit was increased. I don&#8217;t have anything to back that idea except how I expect these memory areas
to grow but not the others.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The <code>Thread</code> stack memory zone, the increased actual memory pages is small, but enough to be mentioned.</p>
</li>
<li>
<p>The <code>GC</code> internal memory zone, with more threads there are more allocations, and as such more
things to track.</p>
</li>
<li>
<p>The <code>Other</code> memory zones with more <code>DirectByteBuffers</code> usage.</p>
</li>
<li>
<p>And anyway with more thread there could be a bit more allocations, which means more
memory pages needed.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><span class="image"><img src="/assets/maxrampercentage/app-file-descriptors.png" alt="app file descriptors"></span></p>
</div>
<div class="paragraph">
<p>The heap had a max value anyway, and if it was then the app would either trigger full GCs, or self terminate
with an <code>OutOfMemoryError</code>, so that is not the heap. As for the offers it&#8217;s unlikely with the workload they grow
that much.</p>
</div>
<div class="paragraph">
<p>My hypothesis is that when full traffic came to this pod, these zones grew by <code>100 MiB</code> to <code>200 MiB</code> (sum),
while not much, it was sufficient to go over the 15% of memory left for the non heap memory, and thus triggered
the system oom killer.</p>
</div>
<div class="paragraph">
<p>Also, at some point in time this application worked well under way less memory in a different cluster <code>-Xmx=2g</code>.
The code is not the culprit in this case. Let&#8217;s explore that.</p>
</div>
<div class="sect2">
<h3 id="_actual_java_heap_usage"><a class="anchor" href="#_actual_java_heap_usage"></a><a class="link" href="#_actual_java_heap_usage">Actual Java Heap usage</a></h3>
<div class="paragraph">
<p>While the previous section allowed to understand the actual memory usage, it didn&#8217;t give any figure
regarding the actual heap usage for this application :</p>
</div>
<div class="listingblock primary">
<div class="title">GC.heap_info</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ jcmd $(pgrep java) GC.heap_info
6:
 garbage-first heap   total 4456448K, used 537569K [0x00000006f0000000, 0x0000000800000000) <i class="conum" data-value="1"></i><b>(1)</b>
  region size 2048K, 161 young (329728K), 13 survivors (26624K)
 Metaspace       used 154131K, capacity 160610K, committed 160976K, reserved 1189888K
  class space    used 18070K, capacity 20474K, committed 20556K, reserved 1048576K</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Used heap : ~<code>525 MiB</code></td>
</tr>
</table>
</div>
<div class="listingblock secondary">
<div class="title">1</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ jcmd $(pgrep java) GC.heap_info
6:
 garbage-first heap   total 4456448K, used 925702K [0x00000006f0000000, 0x0000000800000000) <i class="conum" data-value="1"></i><b>(1)</b>
  region size 2048K, 387 young (792576K), 12 survivors (24576K)
 Metaspace       used 154131K, capacity 160610K, committed 160976K, reserved 1189888K
  class space    used 18070K, capacity 20474K, committed 20556K, reserved 1048576K</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Used heap : ~<code>904 MiB</code></td>
</tr>
</table>
</div>
<div class="listingblock secondary">
<div class="title">2</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ jcmd 6 GC.heap_info
6:
 garbage-first heap   total 4456448K, used 1245902K [0x00000006f0000000, 0x0000000800000000) <i class="conum" data-value="1"></i><b>(1)</b>
  region size 2048K, 543 young (1112064K), 12 survivors (24576K)
 Metaspace       used 154131K, capacity 160610K, committed 160976K, reserved 1189888K
  class space    used 18070K, capacity 20474K, committed 20556K, reserved 1048576K</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Used heap : ~<code>1,217 MiB</code></td>
</tr>
</table>
</div>
<div class="listingblock secondary">
<div class="title">3</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ jcmd 6 GC.heap_info
6:
 garbage-first heap   total 4456448K, used 2421454K [0x00000006f0000000, 0x0000000800000000) <i class="conum" data-value="1"></i><b>(1)</b>
  region size 2048K, 1117 young (2287616K), 12 survivors (24576K)
 Metaspace       used 154131K, capacity 160610K, committed 160976K, reserved 1189888K
  class space    used 18070K, capacity 20474K, committed 20556K, reserved 1048576K</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Used heap : ~<code>2,364 MiB</code></td>
</tr>
</table>
</div>
<div class="listingblock secondary">
<div class="title">4</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ jcmd 6 GC.heap_info
6:
 garbage-first heap   total 4456448K, used 2715248K [0x00000006f0000000, 0x0000000800000000) <i class="conum" data-value="1"></i><b>(1)</b>
  region size 2048K, 1225 young (2508800K), 13 survivors (26624K)
 Metaspace       used 154131K, capacity 160610K, committed 160976K, reserved 1189888K
  class space    used 18070K, capacity 20474K, committed 20556K, reserved 1048576K</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Used heap : ~<code>2,652 MiB</code></td>
</tr>
</table>
</div>
<div class="listingblock secondary">
<div class="title">5</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ jcmd 6 GC.heap_info
6:
 garbage-first heap   total 4456448K, used 279521K [0x00000006f0000000, 0x0000000800000000) <i class="conum" data-value="1"></i><b>(1)</b>
  region size 2048K, 35 young (71680K), 13 survivors (26624K)
 Metaspace       used 154131K, capacity 160610K, committed 160976K, reserved 1189888K
  class space    used 18070K, capacity 20474K, committed 20556K, reserved 1048576K</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Used heap : ~<code>273 MiB</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>On the application in production, limited with <code>5 GiB</code> of memory, the heap
seems to increase between something like <code>273 MiB</code> to <code>2.7 GiB</code>. Graphing the trend of the heap usage
over time suggests the memory usage for this app (for the current cluster topology
(<em>replicaset</em>, traffic, etc.)).</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/maxrampercentage/app-heap-usage-with-5GiB-limit-85p-max.png" alt="app heap usage with 5GiB limit 85p max">
</div>
</div>
<div class="paragraph">
<p>To keep things simple let&#8217;s use the rough top usage of <code>2.7 GiB</code> of the heap. While the available
allocated heap is <code>4.25 GiB</code>. As a reminder non-used memory pages are not physically in RAM,
thanks to the OS (in that case Linux), look at the <code>RSS</code> column of the <code>pmap</code> output.</p>
</div>
<div class="paragraph">
<p>So just using this heap usage with the non heap usage, plus some margin, gives this number :</p>
</div>
<div class="literalblock">
<div class="content">
<pre>2.7 GiB of used heap + 0.8 GiB of non heap + 0.2 GiB margin = 3.7 GiB</pre>
</div>
</div>
<div class="paragraph">
<p>Again keep in mind this is the heap usage with the current GC activity. As said earlier
this application worked with a lower heap <code>2 GiB</code>, this certainly worked at the cost of
higher GC activity and CPU usage at that time, this is ok as this workload is mostly IO bound.
But with restraints in Kubernetes care must be taken otherwise the pod may be throttled.</p>
</div>
<div class="paragraph">
<p>Anyway this CPU usage may require some adjustment on the deployment CPU limit
(<a href="https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#resource-units-in-kubernetes">millicores</a>).
This is essential because on Kubernetes, if a pod reached its CPU limit it gets
<a href="https://cloud.google.com/blog/products/gcp/kubernetes-best-practices-resource-requests-and-limits?hl=fa">throttled</a>,
and this very bad for a Java app to be throttled (this is the same for a Go application).</p>
</div>
<div class="paragraph">
<p>Going back to our <em>equation</em> above, those numbers yield the following percentage
<code>-XX:MaxRAMPercentage=72.97</code> for a deployment limit of <code>3.7 GiB</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre> _____ ___  ____   ___
|_   _/ _ \|  _ \ / _ \
  | || | | | | | | | | |
  | || |_| | |_| | |_| |
  |_| \___/|____/ \___/</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>TODO VALIDATE in prod
TODO Use -Xmx=2g</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_lesson"><a class="anchor" href="#_the_lesson"></a><a class="link" href="#_the_lesson">The lesson</a></h3>
<div class="paragraph">
<p>The thing is that when this flag appeared (before it was <code>*RAMFraction</code>), almost only blogs (like this
<a href="https://merikan.com/2019/04/jvm-in-a-container/">one</a>) explored the options, thanks to them, but most are
incomplete to get the big picture, not to mention those who have slight errors.</p>
</div>
<div class="paragraph">
<p>The official documentation doesn&#8217;t even mention <code>*RAMPercentage</code> flags:</p>
</div>
<div class="ulist">
<div class="title">Oracle documentation</div>
<ul>
<li>
<p><a href="https://docs.oracle.com/en/java/javase/11/tools/java.html#GUID-3B1CE181-CD30-4178-9602-230B800D4FAE"><code>java</code> (JDK11)</a></p>
</li>
<li>
<p><a href="https://docs.oracle.com/en/java/javase/12/docs/specs/man/java.html"><code>java</code> (JDK12)</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Fortunately there&#8217;s still</p>
</div>
<div class="paragraph">



<div class="table-wrapper">
    <table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. <a href="https://chriswhocodes.com/hotspot_options_jdk11.html">VM Options Explorer - JDK11 HotSpot</a></caption>
<colgroup>
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 9.091%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Since</th>
<th class="tableblock halign-left valign-top">Deprecated</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">OS</th>
<th class="tableblock halign-left valign-top">CPU</th>
<th class="tableblock halign-left valign-top">Component</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Availability</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Defined in</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MaxRAMPercentage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JDK10</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">double</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">gc</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">25.0 range(0.0, 100.0)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">product</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum percentage of real memory used for maximum heap size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>share/gc/shared/gc_globals.hpp</code></p></td>
</tr>
</tbody>
</table>

</div>

</div>
<div class="paragraph">
<p>Point taken, I already knew <a href="https://twitter.com/chriswhocodes">Chris Newland</a>'s useful websites
but didn&#8217;t visit them to use this option, <strong>I should have !</strong></p>
</div>
<div class="paragraph">
<p>Anyway after all, I don&#8217;t think <code>*RAMPercentage</code> flags are quite useful (or those
are used inadequately for this application ?!). For me they don&#8217;t quite respect the <em>principle of
the least surprise</em>. We&#8217;ve seen these percentages lacks any consideration of how non-heap usage grow,
and the JVM didn&#8217;t limit these zones according to the <code>cgroup</code> limits, which is unsettling, because
if they were, the JVM would have crashed with an <code>OutOfMemoryError</code>s from these zones.</p>
</div>
<div class="paragraph">
<p>That being said, I believe that from now on it is actually just as ok if not better to prefer the usual
<code>-Xmx</code> flags for Java applications running in a container for now, especially with the
<code>JDK_JAVA_OPTIONS</code> environment variable, and this a bit less work because it&#8217;s not anymore necessary
to translate byte numbers in percentages but instead just use the actual max memory.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_take_away"><a class="anchor" href="#_take_away"></a><a class="link" href="#_take_away">Take away</a></h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Use <code>JDK_JAVA_OPTIONS</code> in the image rather than setting memory in the <code>CMD</code> directive.</p>
</li>
<li>
<p><code>RSS</code>, the amount of physical memory that is allocated &amp; used by a process,</p>
</li>
<li>
<p><code>RSS</code> maybe more or inferior to committed memory of the JVM due to OS virtual memory management</p>
</li>
<li>
<p><code>/proc</code> filesystem and related tooling is great</p>
</li>
<li>
<p>Java ~= heap + metaspace + off-heap (DirectBuffer + threads + compiled code + GC data + &#8230;&#8203;)</p>
</li>
<li>
<p>Using <code>Xmx</code> in a container is still a very good choice compared to <code>MaxRAMPercentage</code></p>
</li>
</ul>
</div>
<hr>
<hr>
<hr>
<hr>
<hr>
<hr>
<div class="literalblock">
<div class="content">
<pre> __
/\ \
\ \ \____    ___     ___   __  __    ____
 \ \ '__`\  / __`\ /' _ `\/\ \/\ \  /',__\
  \ \ \L\ \/\ \L\ \/\ \/\ \ \ \_\ \/\__, `\
   \ \_,__/\ \____/\ \_\ \_\ \____/\/\____/
    \/___/  \/___/  \/_/\/_/\/___/  \/___/</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_bonus"><a class="anchor" href="#_bonus"></a><a class="link" href="#_bonus">Bonus</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The main topic of the blog post is over, but as it was interesting to look at this problem
with some <code>cgroup</code> knowledge and Linux memory understanding, so I wrapped some
information that was nice to refresh and explore.</p>
</div>
<div class="sect2">
<h3 id="_interpreting_cgroups_memory_cgroup_v1"><a class="anchor" href="#_interpreting_cgroups_memory_cgroup_v1"></a><a class="link" href="#_interpreting_cgroups_memory_cgroup_v1">Interpreting cgroup&#8217;s memory (cgroup v1)</a></h3>
<div class="paragraph">
<p>Before going further I&#8217;d like to mention that the Linux kernel documentation on
<a href="https://www.kernel.org/doc/Documentation/cgroup-v1/memory.txt">cgroup v1</a>
is a very good start.</p>
</div>
<div class="paragraph">
<p>In our case let&#8217;s see what <code>cgroup</code> have to say inside our container. A lot of interesting
bits are available in the <code>/sys/fs/cgroup</code>, those are not process specific.
They may help tackle issue with memory not directly related with the process itself:</p>
</div>
<div class="listingblock">
<div class="title">memory.stat</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">❯ kubectl exec -it --container=java-app deployment/java-app -- cat /sys/fs/cgroup/memory/memory.stat
cache 57434112 <i class="conum" data-value="7"></i><b>(7)</b>
rss 4822343680 <i class="conum" data-value="1"></i><b>(1)</b>
rss_huge 0
shmem 0
mapped_file 0
dirty 0
writeback 0
swap 0 <i class="conum" data-value="6"></i><b>(6)</b>
pgpgin 7918680
pgpgout 6726903
pgfault 7682598
pgmajfault 0
pgmajfault_s 0
pgmajfault_a 0
pgmajfault_f 0
inactive_anon 0 <i class="conum" data-value="2"></i><b>(2)</b>
active_anon 4823887872 <i class="conum" data-value="3"></i><b>(3)</b>
inactive_file 58806272 <i class="conum" data-value="4"></i><b>(4)</b>
active_file 188416 <i class="conum" data-value="5"></i><b>(5)</b>
unevictable 0
hierarchical_memory_limit 5368709120
hierarchical_memsw_limit 5368709120
total_cache 57434112
total_rss 4822343680
total_rss_huge 0
total_shmem 0
total_mapped_file 0
total_dirty 0
total_writeback 0
total_swap 0
total_pgpgin 7918680
total_pgpgout 6726903
total_pgfault 7682598
total_pgmajfault 0
total_pgmajfault_s 0
total_pgmajfault_a 0
total_pgmajfault_f 0
total_inactive_anon 0
total_active_anon 4823887872
total_inactive_file 58806272
total_active_file 188416
total_unevictable 0</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>rss of the processes, anonymous memory and swap cache, without <code>tmpfs</code> (shmem) (~<code>4.49 GiB</code>)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>anonymous memory and swap cache on active LRU list, with <code>tmpfs</code> (shmem)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>anonymous memory and swap cache on inactive LRU list, with <code>tmpfs</code> (shmem) (~<code>4.49 GiB</code>)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>file-backed memory on inactive LRU list, in bytes (~<code>56 MiB</code>)</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>file-backed memory on active LRU list, in bytes (~<code>184 KiB</code>)</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>swap usage, <code>0</code> is the only good value for java</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>page cache memory (~<code>54.8 MiB</code>)</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">From the <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/resource_management_guide/sec-memory">RHEL6 documentation</a></div>
<div class="paragraph">
<p>When you interpret the values reported by memory.stat, note how the various statistics inter-relate:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>active_anon</code> + <code>inactive_anon</code> = anonymous memory + file cache for tmpfs + swap cache</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Therefore, <code>active_anon</code> + <code>inactive_anon</code> ≠ rss, because rss does not include tmpfs.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>active_file</code> + <code>inactive_file</code> = cache - size of tmpfs</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>There other memory settings to look at, some of these are being looked upon by the JVM
to understand the contraint of the cgroup.</p>
</div>
<div class="listingblock">
<div class="title">memory usage and limits</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">cat /sys/fs/cgroup/memory/memory.{usage_in_bytes,limit_in_bytes,memsw.usage_in_bytes,memsw.limit_in_bytes}
4944756736 <i class="conum" data-value="1"></i><b>(1)</b>
5368709120 <i class="conum" data-value="2"></i><b>(2)</b>
4944748544 <i class="conum" data-value="3"></i><b>(3)</b>
5368709120 <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>current memory usage ~<code>4.61 GiB</code>, but for the whole memory it&#8217;s recommended to read cache+rss+swap values in <code>memory.stat</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>limit of the memory resource (~<code>5 GiB</code>)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>current memory and swap usage (~<code>4.61 GiB</code>)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>limit on memory and swap (~<code>5 GiB</code>)</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note the <code>memory.limit_in_bytes</code> and <code>memory.memsw.limit_in_bytes</code> values are the same,
that means that the processes in the cgroup can use all the memory before swaping,
however it is not impossible for the process to be use the swap before this limit is reached.</p>
</div>
<div class="paragraph">
<p>In fact due to the OS <code>swapiness</code> value the kernel may try to reclaim memory from RAM and put
on the swap.
There are other parameters related to the kernel and tcp allocations.</p>
</div>
<div class="paragraph">
<p>On the swapiness side, it&#8217;s possible to change that in the cgroup as well.</p>
</div>
<div class="listingblock">
<div class="title">memory.swapiness</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">cat /proc/sys/vm/swappiness <i class="conum" data-value="1"></i><b>(1)</b>
60
cat /sys/fs/cgroup/memory/memory.swappiness <i class="conum" data-value="2"></i><b>(2)</b>
60</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>OS <code>swapiness</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>cgroup <code>swapiness</code>, here the setting is unchanged.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>By the way, high <code>swappiness</code> is bad for applications with GC like the JVM.</p>
</div>
<div class="paragraph">
<p>AS mentioned earlier the JVM look for some values in <code>memory.limit_in_bytes</code> and <code>memory.usage_in_bytes</code>,
but not only, let&#8217;s find out with this logger :</p>
</div>
<div class="listingblock">
<div class="title">log container details</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">-Xlog:os,os+container=trace:file=/gclogs/%t-os-container.log:time,uptime,tags,level</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ head -n 200 /logs/2020-05-22_22-28-32-os-container.log
[2020-05-22T23:17:44.775+0000][0.001s][trace][os,container] OSContainer::init: Initializing Container Support
[2020-05-22T23:17:44.776+0000][0.001s][trace][os,container] Path to /memory.limit_in_bytes is /sys/fs/cgroup/memory/memory.limit_in_bytes <i class="conum" data-value="1"></i><b>(1)</b>
[2020-05-22T23:17:44.776+0000][0.001s][trace][os,container] Memory Limit is: 5368709120
[2020-05-22T23:17:44.776+0000][0.001s][trace][os,container] Path to /cpu.cfs_quota_us is /sys/fs/cgroup/cpu,cpuacct/cpu.cfs_quota_us <i class="conum" data-value="2"></i><b>(2)</b>
[2020-05-22T23:17:44.776+0000][0.001s][trace][os,container] CPU Quota is: 800000
[2020-05-22T23:17:44.776+0000][0.001s][trace][os,container] Path to /cpu.cfs_period_us is /sys/fs/cgroup/cpu,cpuacct/cpu.cfs_period_us <i class="conum" data-value="3"></i><b>(3)</b>
[2020-05-22T23:17:44.776+0000][0.002s][trace][os,container] CPU Period is: 100000
[2020-05-22T23:17:44.776+0000][0.002s][trace][os,container] Path to /cpu.shares is /sys/fs/cgroup/cpu,cpuacct/cpu.shares <i class="conum" data-value="4"></i><b>(4)</b>
[2020-05-22T23:17:44.776+0000][0.002s][trace][os,container] CPU Shares is: 3072
[2020-05-22T23:17:44.776+0000][0.002s][trace][os,container] CPU Quota count based on quota/period: 8
[2020-05-22T23:17:44.776+0000][0.002s][trace][os,container] CPU Share count based on shares: 3
[2020-05-22T23:17:44.776+0000][0.002s][trace][os,container] OSContainer::active_processor_count: 8
[2020-05-22T23:17:44.776+0000][0.002s][trace][os,container] Path to /cpu.cfs_quota_us is /sys/fs/cgroup/cpu,cpuacct/cpu.cfs_quota_us
[2020-05-22T23:17:44.776+0000][0.002s][trace][os,container] CPU Quota is: 800000
[2020-05-22T23:17:44.776+0000][0.002s][trace][os,container] Path to /cpu.cfs_period_us is /sys/fs/cgroup/cpu,cpuacct/cpu.cfs_period_us
[2020-05-22T23:17:44.776+0000][0.002s][trace][os,container] CPU Period is: 100000
[2020-05-22T23:17:44.776+0000][0.002s][trace][os,container] Path to /cpu.shares is /sys/fs/cgroup/cpu,cpuacct/cpu.shares
[2020-05-22T23:17:44.776+0000][0.002s][trace][os,container] CPU Shares is: 3072
[2020-05-22T23:17:44.776+0000][0.002s][trace][os,container] CPU Quota count based on quota/period: 8
[2020-05-22T23:17:44.776+0000][0.002s][trace][os,container] CPU Share count based on shares: 3
[2020-05-22T23:17:44.776+0000][0.002s][trace][os,container] OSContainer::active_processor_count: 8
[2020-05-22T23:17:44.776+0000][0.002s][trace][os,container] Path to /memory.limit_in_bytes is /sys/fs/cgroup/memory/memory.limit_in_bytes
[2020-05-22T23:17:44.776+0000][0.002s][trace][os,container] Memory Limit is: 5368709120
[2020-05-22T23:17:44.776+0000][0.002s][trace][os,container] Path to /memory.limit_in_bytes is /sys/fs/cgroup/memory/memory.limit_in_bytes
[2020-05-22T23:17:44.776+0000][0.002s][trace][os,container] Memory Limit is: 5368709120
[2020-05-22T23:17:44.776+0000][0.002s][info ][os          ] Use of CLOCK_MONOTONIC is supported
[2020-05-22T23:17:44.776+0000][0.002s][info ][os          ] Use of pthread_condattr_setclock is supported
[2020-05-22T23:17:44.776+0000][0.002s][info ][os          ] Relative timed-wait using pthread_cond_timedwait is associated with CLOCK_MONOTONIC
[2020-05-22T23:17:44.776+0000][0.002s][info ][os          ] HotSpot is running with glibc 2.28, NPTL 2.28
[2020-05-22T23:17:44.776+0000][0.002s][info ][os          ] SafePoint Polling address, bad (protected) page:0x00007f3b2efcf000, good (unprotected) page:0x00007f3b2efd0000
[2020-05-22T23:17:44.777+0000][0.002s][info ][os,thread   ] Thread attached (tid: 2260, pthread id: 139892140738304).
[2020-05-22T23:17:44.777+0000][0.003s][info ][os          ] attempting shared library load of /usr/lib/jvm/java-11-amazon-corretto/lib/libzip.so
[2020-05-22T23:17:44.777+0000][0.003s][info ][os          ] shared library load of /usr/lib/jvm/java-11-amazon-corretto/lib/libzip.so was successful
[2020-05-22T23:17:44.777+0000][0.003s][info ][os          ] attempting shared library load of /usr/lib/jvm/java-11-amazon-corretto/lib/libjimage.so
[2020-05-22T23:17:44.777+0000][0.003s][info ][os          ] shared library load of /usr/lib/jvm/java-11-amazon-corretto/lib/libjimage.so was successful
[2020-05-22T23:17:44.777+0000][0.003s][trace][os,container] Path to /cpu.cfs_quota_us is /sys/fs/cgroup/cpu,cpuacct/cpu.cfs_quota_us
[2020-05-22T23:17:44.777+0000][0.003s][trace][os,container] CPU Quota is: 800000
[2020-05-22T23:17:44.777+0000][0.003s][trace][os,container] Path to /cpu.cfs_period_us is /sys/fs/cgroup/cpu,cpuacct/cpu.cfs_period_us
[2020-05-22T23:17:44.777+0000][0.003s][trace][os,container] CPU Period is: 100000
[2020-05-22T23:17:44.777+0000][0.003s][trace][os,container] Path to /cpu.shares is /sys/fs/cgroup/cpu,cpuacct/cpu.shares
[2020-05-22T23:17:44.777+0000][0.003s][trace][os,container] CPU Shares is: 3072
[2020-05-22T23:17:44.777+0000][0.003s][trace][os,container] CPU Quota count based on quota/period: 8
[2020-05-22T23:17:44.777+0000][0.003s][trace][os,container] CPU Share count based on shares: 3
[2020-05-22T23:17:44.777+0000][0.003s][trace][os,container] OSContainer::active_processor_count: 8
[2020-05-22T23:17:44.778+0000][0.004s][info ][os,cpu      ] CPU:total 32 (initial active 8) (16 cores per cpu, 2 threads per core) family 6 model 85 stepping 3, cmov, cx8, fxsr, mmx, sse, sse2, sse3, ssse3, sse4.1, sse4.2, popcnt, avx, avx2, aes, clmul, erms, rtm, 3dnowpref, lzcnt, ht, tsc, tscinvbit, bmi1, bmi2, adx, fma
[2020-05-22T23:17:44.778+0000][0.004s][info ][os,cpu      ] CPU Model and flags from /proc/cpuinfo:
[2020-05-22T23:17:44.778+0000][0.004s][info ][os,cpu      ] model name  : Intel(R) Xeon(R) CPU @ 2.00GHz
[2020-05-22T23:17:44.778+0000][0.004s][info ][os,cpu      ] flags               : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ss ht syscall nx pdpe1gb rdtscp lm constant_tsc rep_good nopl xtopology nonstop_tsc cpuid tsc_known_freq pni pclmulqdq ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe popcnt aes xsave avx f16c rdrand hypervisor lahf_lm abm 3dnowprefetch invpcid_single pti ssbd ibrs ibpb stibp fsgsbase tsc_adjust bmi1 hle avx2 smep bmi2 erms invpcid rtm mpx avx512f avx512dq rdseed adx smap clflushopt clwb avx512cd avx512bw avx512vl xsaveopt xsavec xgetbv1 xsaves arat md_clear arch_capabilities
[2020-05-22T23:17:44.779+0000][0.005s][info ][os,thread   ] Thread started (pthread id: 139892128659200, attributes: stacksize: 1024k, guardsize: 4k, detached).
[2020-05-22T23:17:44.779+0000][0.005s][info ][os,thread   ] Thread is alive (tid: 2261, pthread id: 139892128659200).
[2020-05-22T23:17:44.780+0000][0.005s][info ][os,thread   ] Thread started (pthread id: 139891649345280, attributes: stacksize: 1024k, guardsize: 4k, detached).
[2020-05-22T23:17:44.780+0000][0.006s][info ][os,thread   ] Thread is alive (tid: 2262, pthread id: 139891649345280).
[2020-05-22T23:17:44.780+0000][0.006s][info ][os,thread   ] Thread started (pthread id: 139891430127360, attributes: stacksize: 1024k, guardsize: 4k, detached).
[2020-05-22T23:17:44.780+0000][0.006s][info ][os,thread   ] Thread is alive (tid: 2263, pthread id: 139891430127360).
[2020-05-22T23:17:44.817+0000][0.043s][info ][os,thread   ] Thread started (pthread id: 139891387094784, attributes: stacksize: 1024k, guardsize: 4k, detached).
[2020-05-22T23:17:44.817+0000][0.043s][info ][os,thread   ] Thread is alive (tid: 2264, pthread id: 139891387094784).
[2020-05-22T23:17:44.818+0000][0.043s][info ][os,thread   ] Thread started (pthread id: 139891386038016, attributes: stacksize: 1024k, guardsize: 4k, detached).
[2020-05-22T23:17:44.818+0000][0.043s][info ][os,thread   ] Thread is alive (tid: 2265, pthread id: 139891386038016).
[2020-05-22T23:17:44.835+0000][0.060s][info ][os,thread   ] Thread started (pthread id: 139891384080128, attributes: stacksize: 1024k, guardsize: 4k, detached).
[2020-05-22T23:17:44.835+0000][0.060s][info ][os,thread   ] Thread is alive (tid: 2266, pthread id: 139891384080128).
[2020-05-22T23:17:44.840+0000][0.065s][trace][os,container] Path to /cpu.cfs_quota_us is /sys/fs/cgroup/cpu,cpuacct/cpu.cfs_quota_us
[2020-05-22T23:17:44.840+0000][0.065s][trace][os,container] CPU Quota is: 800000
[2020-05-22T23:17:44.840+0000][0.065s][trace][os,container] Path to /cpu.cfs_period_us is /sys/fs/cgroup/cpu,cpuacct/cpu.cfs_period_us
[2020-05-22T23:17:44.840+0000][0.065s][trace][os,container] CPU Period is: 100000
[2020-05-22T23:17:44.840+0000][0.065s][trace][os,container] Path to /cpu.shares is /sys/fs/cgroup/cpu,cpuacct/cpu.shares
[2020-05-22T23:17:44.840+0000][0.065s][trace][os,container] CPU Shares is: 3072
[2020-05-22T23:17:44.840+0000][0.065s][trace][os,container] CPU Quota count based on quota/period: 8
[2020-05-22T23:17:44.840+0000][0.065s][trace][os,container] CPU Share count based on shares: 3
[2020-05-22T23:17:44.840+0000][0.065s][trace][os,container] OSContainer::active_processor_count: 8
[2020-05-22T23:17:44.841+0000][0.067s][info ][os,thread   ] Thread started (pthread id: 139891383023360, attributes: stacksize: 1024k, guardsize: 0k, detached).
[2020-05-22T23:17:44.841+0000][0.067s][info ][os,thread   ] Thread is alive (tid: 2267, pthread id: 139891383023360).
[2020-05-22T23:17:44.842+0000][0.067s][info ][os,thread   ] Thread started (pthread id: 139891381970688, attributes: stacksize: 1024k, guardsize: 0k, detached).
[2020-05-22T23:17:44.842+0000][0.067s][info ][os,thread   ] Thread is alive (tid: 2268, pthread id: 139891381970688).
[2020-05-22T23:17:44.851+0000][0.077s][info ][os,thread   ] Thread started (pthread id: 139891168560896, attributes: stacksize: 1024k, guardsize: 0k, detached).
[2020-05-22T23:17:44.851+0000][0.077s][info ][os,thread   ] Thread is alive (tid: 2269, pthread id: 139891168560896).
[2020-05-22T23:17:44.852+0000][0.077s][info ][os,thread   ] Thread started (pthread id: 139891167508224, attributes: stacksize: 1024k, guardsize: 0k, detached).
[2020-05-22T23:17:44.852+0000][0.077s][info ][os,thread   ] Thread is alive (tid: 2270, pthread id: 139891167508224).
[2020-05-22T23:17:44.852+0000][0.078s][info ][os,thread   ] Thread started (pthread id: 139891166455552, attributes: stacksize: 1024k, guardsize: 0k, detached).
[2020-05-22T23:17:44.852+0000][0.078s][info ][os,thread   ] Thread is alive (tid: 2271, pthread id: 139891166455552).
[2020-05-22T23:17:44.852+0000][0.078s][info ][os,thread   ] Thread started (pthread id: 139891165402880, attributes: stacksize: 1024k, guardsize: 0k, detached).
[2020-05-22T23:17:44.853+0000][0.078s][info ][os,thread   ] Thread is alive (tid: 2272, pthread id: 139891165402880).
[2020-05-22T23:17:44.858+0000][0.084s][trace][os,container] Path to /memory.limit_in_bytes is /sys/fs/cgroup/memory/memory.limit_in_bytes <i class="conum" data-value="1"></i><b>(1)</b>
[2020-05-22T23:17:44.858+0000][0.084s][trace][os,container] Memory Limit is: 5368709120
[2020-05-22T23:17:44.858+0000][0.084s][trace][os,container] Path to /memory.usage_in_bytes is /sys/fs/cgroup/memory/memory.usage_in_bytes <i class="conum" data-value="5"></i><b>(5)</b>
[2020-05-22T23:17:44.858+0000][0.084s][trace][os,container] Memory Usage is: 4583374848
[2020-05-22T23:17:44.859+0000][0.084s][trace][os,container] Path to /memory.limit_in_bytes is /sys/fs/cgroup/memory/memory.limit_in_bytes
[2020-05-22T23:17:44.859+0000][0.084s][trace][os,container] Memory Limit is: 5368709120
[2020-05-22T23:17:44.859+0000][0.084s][trace][os,container] Path to /memory.usage_in_bytes is /sys/fs/cgroup/memory/memory.usage_in_bytes
[2020-05-22T23:17:44.859+0000][0.084s][trace][os,container] Memory Usage is: 4583374848
[2020-05-22T23:17:44.859+0000][0.084s][trace][os,container] Path to /memory.limit_in_bytes is /sys/fs/cgroup/memory/memory.limit_in_bytes
[2020-05-22T23:17:44.859+0000][0.084s][trace][os,container] Memory Limit is: 5368709120
[2020-05-22T23:17:44.859+0000][0.084s][trace][os,container] Path to /memory.usage_in_bytes is /sys/fs/cgroup/memory/memory.usage_in_bytes
[2020-05-22T23:17:44.859+0000][0.084s][trace][os,container] Memory Usage is: 4583505920
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>/sys/fs/cgroup/memory/memory.limit_in_bytes</code> = 5368709120 bytes, in the k8s deployment object <code>spec.containers[0].resources.limits.memory: 5Gi</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>/sys/fs/cgroup/cpu,cpuacct/cpu.cfs_quota_us</code> = 800000, in the k8s deployment object <code>spec.containers[0].resources.limits.cpu: 8</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>/sys/fs/cgroup/cpu,cpuacct/cpu.cfs_period_us</code> = 100000, 1/10 of a second, the minimal time slice the process can be scheduled on the CPU,</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>/sys/fs/cgroup/cpu,cpuacct/cpu.shares</code> = 3072, in the k8s deployment object this comes from <code>spec.containers[0].resources.requests.cpu: 3</code></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><code>/sys/fs/cgroup/memory/memory.usage_in_bytes</code> = 4583374848 bytes &#8658; <code>4.27 GiB</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Kubernetes documentation was lacking a bit in that regard, but I found
<a href="https://medium.com/@betz.mark/understanding-resource-limits-in-kubernetes-cpu-time-9eff74d3161b">this blog post that
explained a bit better how cpu resource limits work in kubernetes</a>.
And anyway the official documentation is <a href="https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#how-pods-with-resource-limits-are-run">here</a>.</p>
</div>
</div>
</div>
</div>

  </div>
  

<div class="navigation navigation-single">
    
    <a href="/drafts/2020/04/29/watchman/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">Watchman</span>
    </a>
    
    
    <a href="/drafts/2020/05/24/using-java-flight-recorder/" class="navigation-next">
      <span class="navigation-tittle">Using Java FlightRecorder</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  

</article>


        </div>
        
    










<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js" integrity="sha256-eOgo0OtLL4cdq7RdwRUiGKLX9XsIJ7nGhWEKbohmVAQ=" crossorigin="anonymous"></script><script type="text/javascript">
        
        hljs.initHighlightingOnLoad();
    </script>
    
    


<script src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js" integrity="sha256-vrn14y7WH7zgEElyQqm2uCGSQrX/xjYDjniRUQx3NyU=" crossorigin="anonymous"></script>
<script type="text/javascript">
function addBlockSwitches() {
	$('.primary').each(function() {
		primary = $(this);
		createSwitchItem(primary, createBlockSwitch(primary)).item.addClass("selected");
		primary.children('.title').remove();
	});
	$('.secondary').each(function(idx, node) {
		secondary = $(node);
		primary = findPrimary(secondary);
		switchItem = createSwitchItem(secondary, primary.children('.switch'));
		switchItem.content.addClass('hidden');
		findPrimary(secondary).append(switchItem.content);
		secondary.remove();
	});
}

function createBlockSwitch(primary) {
	blockSwitch = $('<div class="switch"></div>');
	primary.prepend(blockSwitch);
	return blockSwitch;
}

function findPrimary(secondary) {
	candidate = secondary.prev();
	while (!candidate.is('.primary')) {
		candidate = candidate.prev();
	}
	return candidate;
}

function createSwitchItem(block, blockSwitch) {
	blockName = block.children('.title').text();
	content = block.children('.content').first().append(block.next('.colist'));
	item = $('<div class="switch--item">' + blockName + '</div>');
	blockSwitch.append(item);
	return {'item': item, 'content': content};
}

function globalSwitch() {
	$('.switch--item').each(function() {
		var blockId = blockIdForSwitchItem($(this));
		$(this).off('click');
		$(this).on('click', function() {
			selectedText = $(this).text()
			window.localStorage.setItem(blockId, selectedText);
			$(".switch--item").filter(function() {
				return blockIdForSwitchItem($(this)) === blockId;
			}).filter(function() {
				return $(this).text() === selectedText;
			}).each(function() {
				select($(this))
			});
		});
		if ($(this).text() === window.localStorage.getItem(blockId)) {
			select($(this))
		}
	});
}

function blockIdForSwitchItem(item) {
	idComponents = []
	idComponents.push(item.text().toLowerCase());
	item.siblings(".switch--item").each(function(index, sibling) {
		idComponents.push($(sibling).text().toLowerCase());
	});
	return idComponents.sort().join("-")
}

function select(selected) {
	selected.addClass('selected');
	selected.siblings().removeClass('selected');
	selectedContent = selected.parent().siblings(".content").eq(selected.index())
	selectedContent.removeClass('hidden');
	selectedContent.siblings().addClass('hidden');
}

$(addBlockSwitches);
$(globalSwitch);
</script>


    



    </body>
</html>

