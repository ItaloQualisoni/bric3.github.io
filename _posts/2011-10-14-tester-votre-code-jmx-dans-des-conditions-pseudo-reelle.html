---
layout: post
title: Tester votre code JMX dans des conditions pseudo réelle.
date: 2011-10-14 13:01:31.000000000 +02:00
type: post
published: true
status: publish
categories:
- code
- TDD
tags:
- code
- jmx
- TDD
- test unitaire
meta:
  _edit_last: '1'
  _syntaxhighlighter_encoded: '1'
  _su_rich_snippet_type: none
  amazon-product-excerpt-hook-override: '3'
  amazon-product-content-hook-override: '2'
  amazon-product-newwindow: '3'
author:
  login: brice
  email: brice.dutheil@gmail.com
  display_name: Brice Dutheil
  first_name: Brice
  last_name: Dutheil
---
<p>Vous devez écrire du code qui fait appel à JMX, en bon citoyen et bon développeur vous voulez tester ce code.</p>
<p>Première approche; vous enregistrez vos MBean sur un `MBeanServer`, disons celui de la plateforme (avec Java 6 : `ManagementFactory.getPlatformMBeanServer()`).</p>
<pre class="lang:java decode:true">mBeanServer.registerMBean(theMBean, theMBean.getObjectName());</pre>
<p>Étant donné que `MBeanServer` étends `MBeanServerConnection` il est possible d’exécuter des querys, de faire des invocations sur les MBean etc. Si le code est suffisamment isolé des aspects techniques de connexion à JMX, vous passerez le `MBeanServer` en lieu et place de la `MBeanServerConnection`.</p>
<p>Supposons le code suivant.</p>
<pre class="lang:java decode:true">public class OperateOnJMXConnection implements JMXOperation {

    public void perform(MBeanServerConnection connection) {
        // doing some stuff there
    }

    public Result getResult() { return result; }
}</pre>
<p>Pour tester ce code il faudrait alors écrire :</p>
<pre class="lang:java decode:true">@Test
public void do_not_fail() {
    operateOnJMXConnection.perform(mbeanServer);

    assertThat(result).satisfies(someCondition);
}</pre>
<p>Mais voilà, vous restez en local, et par exemple si vous avez merdé sur la sérialisation de vos beans, vous ne verrez pas d'échec dans vos test et vous aurez une surprise en prod, ou avant si votre projet a un processus qualité décent.</p>
<p>Évidement il y a une solution, l'idée c'est de pouvoir se connecter au `mBeanServer` local à votre processus (typiquement dans maven 3, l’exécution de vos tests peuvent être forkée).</p>
<p>Alors j'ai essayé de récupérer les informations pour récupérer les informations de la VM qui tourne, mais bon on tombe dans des classes <strong>sun</strong>, j'ai préféré ne pas continuer sur ce chemin semé d'embûches, sans compter sur la faiblesse de cette approche.</p>
<p>Bref en relisant les articles de Khanh sur JMX, j'ai vu quelque chose d'intéressant `JMXConnectorServerFactory`. Cette classe permet donc de créer un `JMXConnectorServer` avec l'URL qu'on lui spécifie et d'un `MBeanServer`. A noter que cette URL doit respecter un certain formalisme tel que la javadoc l'indique : `service:jmx:<em>protocol</em>:<em>remainder</em>`.</p>
<p>Le protocole ne peut pas être n'importe quoi, il faut qu'il y ait le bon service enregistré pour qu'il soit géré. Dans notre cas RMI est standard, c'est donc le protocole que je prendrai. Pour le remainder, il s'agit plus d'une partie d'une URL, je vous laisse voir la Javadoc de `JMXServiceUrl` à ce sujet, mais dans les grandes lignes la forme doit être la suivante : `//[host[:port]][url-path]`</p>
<pre class="lang:java decode:true">JMXConnectorServer connectorServer = JMXConnectorServerFactory.newJMXConnectorServer(
    new JMXServiceURL(&amp;quot;service:jmx:rmi://&amp;quot;),
    null,
    mBeanServer
);

connectorServer.start();</pre>
<p>Hop dans le code précédent, on a créé puis démarrer notre `JMXConnectorServer`. Il n'y a plus qu'à se connecter dessus de manière standard :<br />
Je vais utiliser `connectorServer.getJMXServer()` pour récupérer l'URL du service, il y a une raison à cela, c'est que comme l'indique la javadoc, l'URL passée pour la création du `JMXConnectorServer` peut être légèrement modifiée par celui-ci, il faut donc récupérer la nouvelle URL.</p>
<pre class="lang:java decode:true">JMXConnector jmxConnetor = JMXConnectorFactory.connect(connectorServer.getJMXServiceUrl());
MBeanServerConnection connection = jmx.getgetMBeanServerConnection();</pre>
<p>Et voilà vous avez accès à une `MBeanServerConnection`, qui vit dans la JVM locale, mais qui utilise RMI pour communiquer avec le `MBeanServer`, du coup vous êtes nettement plus proches des conditions du code de production et c'est ce qui nous intéresse dans cet article.</p>
<p>Pour référence les articles de Khanh, et en français s'il vous plait :) :</p>
<ul>
<li>Partie 1 : <a href="http://jetoile.blogspot.com/2010/10/jmx-pour-les-nuls-les-concepts-partie-1.html">http://jetoile.blogspot.com/2010/10/jmx-pour-les-nuls-les-concepts-partie-1.html</a></li>
<li>Partie 2 : <a href="http://jetoile.blogspot.com/2010/11/jmx-pour-les-nuls-les-differents-mbeans.html">http://jetoile.blogspot.com/2010/11/jmx-pour-les-nuls-les-differents-mbeans.html</a></li>
<li>Partie 3 : <a href="http://jetoile.blogspot.com/2010/11/jmx-pour-les-nuls-les-agents-jmx-partie.html">http://jetoile.blogspot.com/2010/11/jmx-pour-les-nuls-les-agents-jmx-partie.html</a></li>
<li>Partie 4 : <a href="http://jetoile.blogspot.com/2010/11/jmx-pour-les-nuls-les-classes-de-base.html">http://jetoile.blogspot.com/2010/11/jmx-pour-les-nuls-les-classes-de-base.html</a></li>
<li>Partie 5 : <a href="http://jetoile.blogspot.com/2010/11/jmx-pour-les-nuls-le-mbean-server.html">http://jetoile.blogspot.com/2010/11/jmx-pour-les-nuls-le-mbean-server.html</a></li>
<li>Partie 6 : <a href="http://jetoile.blogspot.com/2010/12/jmx-pour-les-nuls-chargement-dynamique.html">http://jetoile.blogspot.com/2010/12/jmx-pour-les-nuls-chargement-dynamique.html</a></li>
<li>Partie 7 : <a href="http://jetoile.blogspot.com/2010/12/jmx-pour-les-nuls-les-services-jmx.html">http://jetoile.blogspot.com/2010/12/jmx-pour-les-nuls-les-services-jmx.html</a></li>
<li>Partie 8 : <a href="http://jetoile.blogspot.com/2010/12/jmx-pour-les-nuls-les-connecteurs.html">http://jetoile.blogspot.com/2010/12/jmx-pour-les-nuls-les-connecteurs.html</a></li>
</ul>
<p>Quelques liens javadoc :</p>
<ul>
<li><a href="http://download.oracle.com/javase/6/docs/api/javax/management/remote/JMXConnectorFactory.html">JMXConnectorFactory</a></li>
<li><a href="http://download.oracle.com/javase/6/docs/api/javax/management/remote/JMXConnectorServerFactory.html">JMXConnectorServerFactory</a></li>
<li><a href="http://download.oracle.com/javase/6/docs/api/javax/management/remote/JMXServiceURL.html">JMXServiceURL</a></li>
<li><a href="http://download.oracle.com/javase/6/docs/api/javax/management/remote/JMXConnectorServer.html">JMXConnectorServer</a></li>
</ul>
<p>Enfin je me suis créé une petite classe de commodité qui permet de créé facilement un loopback pour les TU :</p>
